<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.10.0" xml:lang="en-US">
  <compounddef id="modeling__deepseek_8py" kind="file" language="Python">
    <compoundname>modeling_deepseek.py</compoundname>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm" prot="public">modeling_deepseek::DeepseekV3RMSNorm</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding" prot="public">modeling_deepseek::DeepseekV3RotaryEmbedding</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding" prot="public">modeling_deepseek::DeepseekV3LinearScalingRotaryEmbedding</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding" prot="public">modeling_deepseek::DeepseekV3DynamicNTKScalingRotaryEmbedding</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding" prot="public">modeling_deepseek::DeepseekV3YarnRotaryEmbedding</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3MLP" prot="public">modeling_deepseek::DeepseekV3MLP</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1MoEGate" prot="public">modeling_deepseek::MoEGate</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3MoE" prot="public">modeling_deepseek::DeepseekV3MoE</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3Attention" prot="public">modeling_deepseek::DeepseekV3Attention</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2" prot="public">modeling_deepseek::DeepseekV3FlashAttention2</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer" prot="public">modeling_deepseek::DeepseekV3DecoderLayer</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel" prot="public">modeling_deepseek::DeepseekV3PreTrainedModel</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3Model" prot="public">modeling_deepseek::DeepseekV3Model</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM" prot="public">modeling_deepseek::DeepseekV3ForCausalLM</innerclass>
    <innerclass refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification" prot="public">modeling_deepseek::DeepseekV3ForSequenceClassification</innerclass>
    <innernamespace refid="namespacemodeling__deepseek">modeling_deepseek</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespacemodeling__deepseek" refkind="compound"><highlight class="normal">Hugging<sp/>Face</highlight><highlight class="stringliteral">&apos;s<sp/>logo</highlight></codeline>
<codeline lineno="2"><highlight class="stringliteral">Hugging<sp/>Face</highlight></codeline>
<codeline lineno="3"><highlight class="stringliteral">Models</highlight></codeline>
<codeline lineno="4"><highlight class="stringliteral">Datasets</highlight></codeline>
<codeline lineno="5"><highlight class="stringliteral">Spaces</highlight></codeline>
<codeline lineno="6"><highlight class="stringliteral">Posts</highlight></codeline>
<codeline lineno="7"><highlight class="stringliteral">Docs</highlight></codeline>
<codeline lineno="8"><highlight class="stringliteral">Enterprise</highlight></codeline>
<codeline lineno="9"><highlight class="stringliteral">Pricing</highlight></codeline>
<codeline lineno="10"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="11"><highlight class="stringliteral">Log<sp/>In</highlight></codeline>
<codeline lineno="12"><highlight class="stringliteral">Sign<sp/>Up</highlight></codeline>
<codeline lineno="13"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="14"><highlight class="stringliteral">deepseek-ai</highlight></codeline>
<codeline lineno="15"><highlight class="stringliteral">/</highlight></codeline>
<codeline lineno="16"><highlight class="stringliteral">DeepSeek-R1<sp/></highlight></codeline>
<codeline lineno="17"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="18"><highlight class="stringliteral">like</highlight></codeline>
<codeline lineno="19"><highlight class="stringliteral">8.79k</highlight></codeline>
<codeline lineno="20"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="21"><highlight class="stringliteral">Follow</highlight></codeline>
<codeline lineno="22"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="23"><highlight class="stringliteral">DeepSeek</highlight></codeline>
<codeline lineno="24"><highlight class="stringliteral">33.6k</highlight></codeline>
<codeline lineno="25"><highlight class="stringliteral">Text<sp/>Generation</highlight></codeline>
<codeline lineno="26"><highlight class="stringliteral">Transformers</highlight></codeline>
<codeline lineno="27"><highlight class="stringliteral">Safetensors</highlight></codeline>
<codeline lineno="28"><highlight class="stringliteral">deepseek_v3</highlight></codeline>
<codeline lineno="29"><highlight class="stringliteral">conversational</highlight></codeline>
<codeline lineno="30"><highlight class="stringliteral">custom_code</highlight></codeline>
<codeline lineno="31"><highlight class="stringliteral">fp8</highlight></codeline>
<codeline lineno="32"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="33"><highlight class="stringliteral">arxiv:</highlight></codeline>
<codeline lineno="34"><highlight class="stringliteral">2501.12948</highlight></codeline>
<codeline lineno="35"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="36"><highlight class="stringliteral">License:</highlight></codeline>
<codeline lineno="37"><highlight class="stringliteral">mit</highlight></codeline>
<codeline lineno="38"><highlight class="stringliteral">Model<sp/>card</highlight></codeline>
<codeline lineno="39"><highlight class="stringliteral">Files<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>versions</highlight></codeline>
<codeline lineno="40"><highlight class="normal">Community</highlight></codeline>
<codeline lineno="41"><highlight class="normal">140</highlight></codeline>
<codeline lineno="42"><highlight class="normal">DeepSeek-R1</highlight></codeline>
<codeline lineno="43"><highlight class="normal">/</highlight></codeline>
<codeline lineno="44"><highlight class="normal">modeling_deepseek.py</highlight></codeline>
<codeline lineno="45"><highlight class="normal"></highlight></codeline>
<codeline lineno="46"><highlight class="normal">msr2000</highlight><highlight class="stringliteral">&apos;s<sp/>picture</highlight></codeline>
<codeline lineno="47"><highlight class="stringliteral">msr2000</highlight></codeline>
<codeline lineno="48"><highlight class="stringliteral">Add<sp/>files<sp/>using<sp/>upload-large-folder<sp/>tool</highlight></codeline>
<codeline lineno="49"><highlight class="stringliteral">abf9bba</highlight></codeline>
<codeline lineno="50"><highlight class="stringliteral">verified</highlight></codeline>
<codeline lineno="51"><highlight class="stringliteral">25<sp/>days<sp/>ago</highlight></codeline>
<codeline lineno="52"><highlight class="stringliteral">raw</highlight></codeline>
<codeline lineno="53"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="54"><highlight class="stringliteral">Copy<sp/>download<sp/>link</highlight></codeline>
<codeline lineno="55"><highlight class="stringliteral">history</highlight></codeline>
<codeline lineno="56"><highlight class="stringliteral">blame</highlight></codeline>
<codeline lineno="57"><highlight class="stringliteral">contribute</highlight></codeline>
<codeline lineno="58"><highlight class="stringliteral">delete</highlight></codeline>
<codeline lineno="59"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="60"><highlight class="stringliteral">75.8<sp/>kB</highlight></codeline>
<codeline lineno="61"><highlight class="stringliteral"></highlight><highlight class="comment">#<sp/>coding=utf-8</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copyright<sp/>2023<sp/>DeepSeek-AI<sp/>and<sp/>The<sp/>HuggingFace<sp/>Inc.<sp/>team.<sp/>All<sp/>rights<sp/>reserved.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"></highlight><highlight class="comment">#<sp/>This<sp/>code<sp/>is<sp/>based<sp/>on<sp/>EleutherAI&apos;s<sp/>GPT-NeoX<sp/>library<sp/>and<sp/>the<sp/>GPT-NeoX</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="65"><highlight class="normal"></highlight><highlight class="comment">#<sp/>and<sp/>OPT<sp/>implementations<sp/>in<sp/>this<sp/>library.<sp/>It<sp/>has<sp/>been<sp/>modified<sp/>from<sp/>its</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight><highlight class="comment">#<sp/>original<sp/>forms<sp/>to<sp/>accommodate<sp/>minor<sp/>architectural<sp/>differences<sp/>compared</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="comment">#<sp/>to<sp/>GPT-NeoX<sp/>and<sp/>OPT<sp/>used<sp/>by<sp/>the<sp/>Meta<sp/>AI<sp/>team<sp/>that<sp/>trained<sp/>the<sp/>model.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="69"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Licensed<sp/>under<sp/>the<sp/>Apache<sp/>License,<sp/>Version<sp/>2.0<sp/>(the<sp/>&quot;License&quot;);</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="70"><highlight class="normal"></highlight><highlight class="comment">#<sp/>you<sp/>may<sp/>not<sp/>use<sp/>this<sp/>file<sp/>except<sp/>in<sp/>compliance<sp/>with<sp/>the<sp/>License.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="71"><highlight class="normal"></highlight><highlight class="comment">#<sp/>You<sp/>may<sp/>obtain<sp/>a<sp/>copy<sp/>of<sp/>the<sp/>License<sp/>at</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight><highlight class="comment">#<sp/><sp/><sp/><sp/><sp/>http://www.apache.org/licenses/LICENSE-2.0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"></highlight><highlight class="comment">#</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Unless<sp/>required<sp/>by<sp/>applicable<sp/>law<sp/>or<sp/>agreed<sp/>to<sp/>in<sp/>writing,<sp/>software</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="76"><highlight class="normal"></highlight><highlight class="comment">#<sp/>distributed<sp/>under<sp/>the<sp/>License<sp/>is<sp/>distributed<sp/>on<sp/>an<sp/>&quot;AS<sp/>IS&quot;<sp/>BASIS,</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight><highlight class="comment">#<sp/>WITHOUT<sp/>WARRANTIES<sp/>OR<sp/>CONDITIONS<sp/>OF<sp/>ANY<sp/>KIND,<sp/>either<sp/>express<sp/>or<sp/>implied.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"></highlight><highlight class="comment">#<sp/>See<sp/>the<sp/>License<sp/>for<sp/>the<sp/>specific<sp/>language<sp/>governing<sp/>permissions<sp/>and</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="79"><highlight class="normal"></highlight><highlight class="comment">#<sp/>limitations<sp/>under<sp/>the<sp/>License.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="80"><highlight class="normal"></highlight><highlight class="stringliteral">&quot;&quot;&quot;<sp/>PyTorch<sp/>DeepSeek<sp/>model.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="81"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>math</highlight></codeline>
<codeline lineno="82"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>warnings</highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>typing<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>List,<sp/>Optional,<sp/>Tuple,<sp/>Union</highlight></codeline>
<codeline lineno="84"><highlight class="normal"></highlight></codeline>
<codeline lineno="85"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>torch</highlight></codeline>
<codeline lineno="86"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>torch.nn.functional<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>F</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>torch.utils.checkpoint</highlight></codeline>
<codeline lineno="88"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>torch<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>nn</highlight></codeline>
<codeline lineno="89"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>torch.nn<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>BCEWithLogitsLoss,<sp/>CrossEntropyLoss,<sp/>MSELoss</highlight></codeline>
<codeline lineno="90"><highlight class="normal"></highlight></codeline>
<codeline lineno="91"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.activations<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>ACT2FN</highlight></codeline>
<codeline lineno="92"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.cache_utils<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>Cache,<sp/>DynamicCache</highlight></codeline>
<codeline lineno="93"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.modeling_attn_mask_utils<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/>AttentionMaskConverter,</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/>_prepare_4d_attention_mask,</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/>_prepare_4d_causal_attention_mask,</highlight></codeline>
<codeline lineno="97"><highlight class="normal">)</highlight></codeline>
<codeline lineno="98"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.modeling_outputs<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/>BaseModelOutputWithPast,</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/>CausalLMOutputWithPast,</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/>SequenceClassifierOutputWithPast,</highlight></codeline>
<codeline lineno="102"><highlight class="normal">)</highlight></codeline>
<codeline lineno="103"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.modeling_utils<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>PreTrainedModel</highlight></codeline>
<codeline lineno="104"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.pytorch_utils<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/>ALL_LAYERNORM_LAYERS,</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/>is_torch_greater_or_equal_than_1_13,</highlight></codeline>
<codeline lineno="107"><highlight class="normal">)</highlight></codeline>
<codeline lineno="108"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.utils<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/>add_start_docstrings,</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/>add_start_docstrings_to_model_forward,</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>is_flash_attn_2_available,</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/>is_flash_attn_greater_or_equal_2_10,</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/>logging,</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/>replace_return_docstrings,</highlight></codeline>
<codeline lineno="115"><highlight class="normal">)</highlight></codeline>
<codeline lineno="116"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>transformers.utils.import_utils<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>is_torch_fx_available</highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>.configuration_deepseek<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>DeepseekV3Config</highlight></codeline>
<codeline lineno="118"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>torch.distributed<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>dist</highlight></codeline>
<codeline lineno="119"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>numpy<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>np</highlight></codeline>
<codeline lineno="120"><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>is_flash_attn_2_available():</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>flash_attn<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>flash_attn_func,<sp/>flash_attn_varlen_func</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">from</highlight><highlight class="normal"><sp/>flash_attn.bert_padding<sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>index_first_axis,<sp/>pad_input,<sp/>unpad_input<sp/><sp/></highlight><highlight class="comment">#<sp/>noqa</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="124"><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"></highlight><highlight class="comment">#<sp/>This<sp/>makes<sp/>`_prepare_4d_causal_attention_mask`<sp/>a<sp/>leaf<sp/>function<sp/>in<sp/>the<sp/>FX<sp/>graph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight><highlight class="comment">#<sp/>It<sp/>means<sp/>that<sp/>the<sp/>function<sp/>will<sp/>not<sp/>be<sp/>traced<sp/>through<sp/>and<sp/>simply<sp/>appear<sp/>as<sp/>a<sp/>node<sp/>in<sp/>the<sp/>graph.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>is_torch_fx_available():</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>is_torch_greater_or_equal_than_1_13:</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>torch.fx</highlight></codeline>
<codeline lineno="131"><highlight class="normal"></highlight></codeline>
<codeline lineno="132" refid="namespacemodeling__deepseek_1a8d9baef5b34c8ef4b2f1ea6334ba2266" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>_prepare_4d_causal_attention_mask<sp/>=<sp/>torch.fx.wrap(_prepare_4d_causal_attention_mask)</highlight></codeline>
<codeline lineno="133"><highlight class="normal"></highlight></codeline>
<codeline lineno="134"><highlight class="normal"></highlight></codeline>
<codeline lineno="135" refid="namespacemodeling__deepseek_1ae57b9b10039f9c6cc3805df718ae3968" refkind="member"><highlight class="normal">logger<sp/>=<sp/>logging.get_logger(__name__)</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137" refid="namespacemodeling__deepseek_1a881e5dbefaf2df66dcee12dbd1e82010" refkind="member"><highlight class="normal">_CONFIG_FOR_DOC<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;DeepseekV3Config&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight></codeline>
<codeline lineno="140" refid="namespacemodeling__deepseek_1aff225c90cb4b2622f8872d0c3f584b3d" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1aff225c90cb4b2622f8872d0c3f584b3d" kindref="member">_get_unpad_data</ref>(attention_mask):</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/>seqlens_in_batch<sp/>=<sp/>attention_mask.sum(dim=-1,<sp/>dtype=torch.int32)</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/>indices<sp/>=<sp/>torch.nonzero(attention_mask.flatten(),<sp/>as_tuple=</highlight><highlight class="keyword">False</highlight><highlight class="normal">).flatten()</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>max_seqlen_in_batch<sp/>=<sp/>seqlens_in_batch.max().item()</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/>cu_seqlens<sp/>=<sp/>F.pad(</highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.cumsum(seqlens_in_batch,<sp/>dim=0,<sp/>dtype=torch.torch.int32),<sp/>(1,<sp/>0)</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices,</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seqlens,</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seqlen_in_batch,</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="152"><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight></codeline>
<codeline lineno="154" refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm" kindref="compound">DeepseekV3RMSNorm</ref>(nn.Module):</highlight></codeline>
<codeline lineno="155" refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1af2508deb9797766a4044f127e7726f0f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1af2508deb9797766a4044f127e7726f0f" kindref="member">__init__</ref>(self,<sp/>hidden_size,<sp/>eps=1e-6):</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="157"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DeepseekV3RMSNorm<sp/>is<sp/>equivalent<sp/>to<sp/>T5LayerNorm</highlight></codeline>
<codeline lineno="158"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1af2508deb9797766a4044f127e7726f0f" kindref="member">__init__</ref>()</highlight></codeline>
<codeline lineno="160" refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1aaa589372f55dbb8c3ebc78a3f9ea590f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1aaa589372f55dbb8c3ebc78a3f9ea590f" kindref="member">weight</ref><sp/>=<sp/>nn.Parameter(torch.ones(hidden_size))</highlight></codeline>
<codeline lineno="161" refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1a0f2b51b768f967bd503eb17b34a55d26" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1a0f2b51b768f967bd503eb17b34a55d26" kindref="member">variance_epsilon</ref><sp/>=<sp/>eps</highlight></codeline>
<codeline lineno="162"><highlight class="normal"></highlight></codeline>
<codeline lineno="163" refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1a2bb202d26033b0c66c354225063f05da" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1a2bb202d26033b0c66c354225063f05da" kindref="member">forward</ref>(self,<sp/>hidden_states):</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_dtype<sp/>=<sp/>hidden_states.dtype</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>hidden_states.to(torch.float32)</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>variance<sp/>=<sp/>hidden_states.pow(2).mean(-1,<sp/>keepdim=</highlight><highlight class="keyword">True</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>hidden_states<sp/>*<sp/>torch.rsqrt(variance<sp/>+<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1a0f2b51b768f967bd503eb17b34a55d26" kindref="member">variance_epsilon</ref>)</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RMSNorm_1aaa589372f55dbb8c3ebc78a3f9ea590f" kindref="member">weight</ref><sp/>*<sp/>hidden_states.to(input_dtype)</highlight></codeline>
<codeline lineno="169"><highlight class="normal"></highlight></codeline>
<codeline lineno="170"><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal">ALL_LAYERNORM_LAYERS.append(DeepseekV3RMSNorm)</highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"></highlight></codeline>
<codeline lineno="174" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding" kindref="compound">DeepseekV3RotaryEmbedding</ref>(nn.Module):</highlight></codeline>
<codeline lineno="175" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1af854f8ee2ae1c1b1ee3cbb3a79f6aeff" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1af854f8ee2ae1c1b1ee3cbb3a79f6aeff" kindref="member">__init__</ref>(self,<sp/>dim,<sp/>max_position_embeddings=2048,<sp/>base=10000,<sp/>device=None):</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1af854f8ee2ae1c1b1ee3cbb3a79f6aeff" kindref="member">__init__</ref>()</highlight></codeline>
<codeline lineno="177"><highlight class="normal"></highlight></codeline>
<codeline lineno="178" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref><sp/>=<sp/>dim</highlight></codeline>
<codeline lineno="179" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa2ff22ce2ac8aa4b7f5187637af71004" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa2ff22ce2ac8aa4b7f5187637af71004" kindref="member">max_position_embeddings</ref><sp/>=<sp/>max_position_embeddings</highlight></codeline>
<codeline lineno="180" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" kindref="member">base</ref><sp/>=<sp/>base</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inv_freq<sp/>=<sp/>1.0<sp/>/<sp/>(</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" kindref="member">base</ref><sp/>**<sp/>(torch.arange(0,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref>,<sp/>2).float().to(device)<sp/>/<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref>)</highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;inv_freq&quot;</highlight><highlight class="normal">,<sp/>inv_freq,<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="185"><highlight class="normal"></highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Build<sp/>here<sp/>to<sp/>make<sp/>`torch.jit.trace`<sp/>work.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1ae01ef97644accdcf3fe2fe1b1aef2ca2" kindref="member">_set_cos_sin_cache</ref>(</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>seq_len=max_position_embeddings,</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device=self.inv_freq.device,</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dtype=torch.get_default_dtype(),</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="192" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><sp/>=<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"></highlight></codeline>
<codeline lineno="194" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1ae01ef97644accdcf3fe2fe1b1aef2ca2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1ae01ef97644accdcf3fe2fe1b1aef2ca2" kindref="member">_set_cos_sin_cache</ref>(self,<sp/>seq_len,<sp/>device,<sp/>dtype):</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><sp/>=<sp/>seq_len</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>t<sp/>=<sp/>torch.arange(</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref>,<sp/>device=device,<sp/>dtype=self.inv_freq.dtype</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freqs<sp/>=<sp/>torch.outer(t,<sp/>self.inv_freq.to(t.device))</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Different<sp/>from<sp/>paper,<sp/>but<sp/>it<sp/>uses<sp/>a<sp/>different<sp/>permutation<sp/>in<sp/>order<sp/>to<sp/>obtain<sp/>the<sp/>same<sp/>calculation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>emb<sp/>=<sp/>torch.cat((freqs,<sp/>freqs),<sp/>dim=-1)</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;cos_cached&quot;</highlight><highlight class="normal">,<sp/>emb.cos().to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;sin_cached&quot;</highlight><highlight class="normal">,<sp/>emb.sin().to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="205"><highlight class="normal"></highlight></codeline>
<codeline lineno="206" refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1af3522f95c36edff62dcdf56d23ad6bfc" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1af3522f95c36edff62dcdf56d23ad6bfc" kindref="member">forward</ref>(self,<sp/>x,<sp/>seq_len=None):</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>x:<sp/>[bs,<sp/>num_attention_heads,<sp/>seq_len,<sp/>head_size]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">or</highlight><highlight class="normal"><sp/>seq_len<sp/>&gt;<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref>:</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1ae01ef97644accdcf3fe2fe1b1aef2ca2" kindref="member">_set_cos_sin_cache</ref>(seq_len=seq_len,<sp/>device=x.device,<sp/>dtype=x.dtype)</highlight></codeline>
<codeline lineno="210"><highlight class="normal"></highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.cos_cached[:seq_len].to(dtype=x.dtype),</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.sin_cached[:seq_len].to(dtype=x.dtype),</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="215"><highlight class="normal"></highlight></codeline>
<codeline lineno="216"><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.LlamaLinearScalingRotaryEmbedding<sp/>with<sp/>Llama-&gt;DeepseekV3</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="218" refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding" kindref="compound">DeepseekV3LinearScalingRotaryEmbedding</ref>(<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding" kindref="compound">DeepseekV3RotaryEmbedding</ref>):</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;DeepseekV3RotaryEmbedding<sp/>extended<sp/>with<sp/>linear<sp/>scaling.<sp/>Credits<sp/>to<sp/>the<sp/>Reddit<sp/>user<sp/>/u/kaiokendev&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="220"><highlight class="normal"></highlight></codeline>
<codeline lineno="221" refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a88b7ec792d696d9aca729412cc9cef65" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a88b7ec792d696d9aca729412cc9cef65" kindref="member">__init__</ref>(</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dim,</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=2048,</highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=10000,</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device=None,</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor=1.0,</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="229" refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1ac154d5c78a36bbd7a676fc51dc4d868c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1ac154d5c78a36bbd7a676fc51dc4d868c" kindref="member">scaling_factor</ref><sp/>=<sp/>scaling_factor</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a88b7ec792d696d9aca729412cc9cef65" kindref="member">__init__</ref>(dim,<sp/>max_position_embeddings,<sp/>base,<sp/>device)</highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight></codeline>
<codeline lineno="232" refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a8e7b2346a4ecceac9140a465b2798e09" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a8e7b2346a4ecceac9140a465b2798e09" kindref="member">_set_cos_sin_cache</ref>(self,<sp/>seq_len,<sp/>device,<sp/>dtype):</highlight></codeline>
<codeline lineno="233" refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a20f2051e0be20d6227f68ee713ea632b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a20f2051e0be20d6227f68ee713ea632b" kindref="member">max_seq_len_cached</ref><sp/>=<sp/>seq_len</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>t<sp/>=<sp/>torch.arange(</highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1a20f2051e0be20d6227f68ee713ea632b" kindref="member">max_seq_len_cached</ref>,<sp/>device=device,<sp/>dtype=self.inv_freq.dtype</highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>t<sp/>=<sp/>t<sp/>/<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3LinearScalingRotaryEmbedding_1ac154d5c78a36bbd7a676fc51dc4d868c" kindref="member">scaling_factor</ref></highlight></codeline>
<codeline lineno="238"><highlight class="normal"></highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freqs<sp/>=<sp/>torch.outer(t,<sp/>self.inv_freq)</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Different<sp/>from<sp/>paper,<sp/>but<sp/>it<sp/>uses<sp/>a<sp/>different<sp/>permutation<sp/>in<sp/>order<sp/>to<sp/>obtain<sp/>the<sp/>same<sp/>calculation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>emb<sp/>=<sp/>torch.cat((freqs,<sp/>freqs),<sp/>dim=-1)</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;cos_cached&quot;</highlight><highlight class="normal">,<sp/>emb.cos().to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;sin_cached&quot;</highlight><highlight class="normal">,<sp/>emb.sin().to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="244"><highlight class="normal"></highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.LlamaDynamicNTKScalingRotaryEmbedding<sp/>with<sp/>Llama-&gt;DeepseekV3</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="247" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding" kindref="compound">DeepseekV3DynamicNTKScalingRotaryEmbedding</ref>(<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding" kindref="compound">DeepseekV3RotaryEmbedding</ref>):</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;DeepseekV3RotaryEmbedding<sp/>extended<sp/>with<sp/>Dynamic<sp/>NTK<sp/>scaling.<sp/>Credits<sp/>to<sp/>the<sp/>Reddit<sp/>users<sp/>/u/bloc97<sp/>and<sp/>/u/emozilla&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="249"><highlight class="normal"></highlight></codeline>
<codeline lineno="250" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1ab9b04c5d525c2cab59b63c01d831887b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1ab9b04c5d525c2cab59b63c01d831887b" kindref="member">__init__</ref>(</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dim,</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=2048,</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=10000,</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device=None,</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor=1.0,</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="258" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a7f3bf0b3f2166a8d7a92f3edb75b9ada" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a7f3bf0b3f2166a8d7a92f3edb75b9ada" kindref="member">scaling_factor</ref><sp/>=<sp/>scaling_factor</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1ab9b04c5d525c2cab59b63c01d831887b" kindref="member">__init__</ref>(dim,<sp/>max_position_embeddings,<sp/>base,<sp/>device)</highlight></codeline>
<codeline lineno="260"><highlight class="normal"></highlight></codeline>
<codeline lineno="261" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a7bc816eb10147956ba9463291fe22749" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a7bc816eb10147956ba9463291fe22749" kindref="member">_set_cos_sin_cache</ref>(self,<sp/>seq_len,<sp/>device,<sp/>dtype):</highlight></codeline>
<codeline lineno="262" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a1aa7ce7af86c8ec232856099e8223969" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a1aa7ce7af86c8ec232856099e8223969" kindref="member">max_seq_len_cached</ref><sp/>=<sp/>seq_len</highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>seq_len<sp/>&gt;<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa2ff22ce2ac8aa4b7f5187637af71004" kindref="member">max_position_embeddings</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a8f9ba629164b9c536d3b6ac860adbf6c" kindref="member">max_position_embeddings</ref>:</highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base<sp/>=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" kindref="member">base</ref><sp/>*<sp/>(</highlight></codeline>
<codeline lineno="266" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a8f9ba629164b9c536d3b6ac860adbf6c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a7f3bf0b3f2166a8d7a92f3edb75b9ada" kindref="member">scaling_factor</ref><sp/>*<sp/>seq_len<sp/>/<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa2ff22ce2ac8aa4b7f5187637af71004" kindref="member">max_position_embeddings</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a8f9ba629164b9c536d3b6ac860adbf6c" kindref="member">max_position_embeddings</ref>)</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a7f3bf0b3f2166a8d7a92f3edb75b9ada" kindref="member">scaling_factor</ref><sp/>-<sp/>1)</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>**<sp/>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a6b5502b5e0630e580645660ebf46d942" kindref="member">dim</ref><sp/>/<sp/>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a6b5502b5e0630e580645660ebf46d942" kindref="member">dim</ref><sp/>-<sp/>2))</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inv_freq<sp/>=<sp/>1.0<sp/>/<sp/>(</highlight></codeline>
<codeline lineno="270" refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a6b5502b5e0630e580645660ebf46d942" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base<sp/>**<sp/>(torch.arange(0,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a6b5502b5e0630e580645660ebf46d942" kindref="member">dim</ref>,<sp/>2).float().to(device)<sp/>/<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a6b5502b5e0630e580645660ebf46d942" kindref="member">dim</ref>)</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;inv_freq&quot;</highlight><highlight class="normal">,<sp/>inv_freq,<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="273"><highlight class="normal"></highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>t<sp/>=<sp/>torch.arange(</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3DynamicNTKScalingRotaryEmbedding_1a1aa7ce7af86c8ec232856099e8223969" kindref="member">max_seq_len_cached</ref>,<sp/>device=device,<sp/>dtype=self.inv_freq.dtype</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="277"><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freqs<sp/>=<sp/>torch.outer(t,<sp/>self.inv_freq)</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>Different<sp/>from<sp/>paper,<sp/>but<sp/>it<sp/>uses<sp/>a<sp/>different<sp/>permutation<sp/>in<sp/>order<sp/>to<sp/>obtain<sp/>the<sp/>same<sp/>calculation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>emb<sp/>=<sp/>torch.cat((freqs,<sp/>freqs),<sp/>dim=-1)</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;cos_cached&quot;</highlight><highlight class="normal">,<sp/>emb.cos().to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;sin_cached&quot;</highlight><highlight class="normal">,<sp/>emb.sin().to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"></highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Inverse<sp/>dim<sp/>formula<sp/>to<sp/>find<sp/>dim<sp/>based<sp/>on<sp/>number<sp/>of<sp/>rotations</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="286" refid="namespacemodeling__deepseek_1a5773fca3051b7ea373ce0a49be2ea763" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1a5773fca3051b7ea373ce0a49be2ea763" kindref="member">yarn_find_correction_dim</ref>(</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/>num_rotations,<sp/>dim,<sp/>base=10000,<sp/>max_position_embeddings=2048</highlight></codeline>
<codeline lineno="288"><highlight class="normal">):</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>(dim<sp/>*<sp/>math.log(max_position_embeddings<sp/>/<sp/>(num_rotations<sp/>*<sp/>2<sp/>*<sp/>math.pi)))<sp/>/<sp/>(</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>2<sp/>*<sp/>math.log(base)</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="292"><highlight class="normal"></highlight></codeline>
<codeline lineno="293"><highlight class="normal"></highlight></codeline>
<codeline lineno="294"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Find<sp/>dim<sp/>range<sp/>bounds<sp/>based<sp/>on<sp/>rotations</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="295" refid="namespacemodeling__deepseek_1ab17059a7c13afd5df5eda1a07fe7e6b7" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1ab17059a7c13afd5df5eda1a07fe7e6b7" kindref="member">yarn_find_correction_range</ref>(</highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/>low_rot,<sp/>high_rot,<sp/>dim,<sp/>base=10000,<sp/>max_position_embeddings=2048</highlight></codeline>
<codeline lineno="297"><highlight class="normal">):</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/>low<sp/>=<sp/>math.floor(</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacemodeling__deepseek_1a5773fca3051b7ea373ce0a49be2ea763" kindref="member">yarn_find_correction_dim</ref>(low_rot,<sp/>dim,<sp/>base,<sp/>max_position_embeddings)</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/>high<sp/>=<sp/>math.ceil(</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacemodeling__deepseek_1a5773fca3051b7ea373ce0a49be2ea763" kindref="member">yarn_find_correction_dim</ref>(high_rot,<sp/>dim,<sp/>base,<sp/>max_position_embeddings)</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>max(low,<sp/>0),<sp/>min(high,<sp/>dim<sp/>-<sp/>1)<sp/><sp/></highlight><highlight class="comment">#<sp/>Clamp<sp/>values<sp/>just<sp/>in<sp/>case</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="305"><highlight class="normal"></highlight></codeline>
<codeline lineno="306"><highlight class="normal"></highlight></codeline>
<codeline lineno="307" refid="namespacemodeling__deepseek_1a34b414bdb0bddfa5b31edbc45c4a85de" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1a34b414bdb0bddfa5b31edbc45c4a85de" kindref="member">yarn_get_mscale</ref>(scale=1,<sp/>mscale=1):</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>scale<sp/>&lt;=<sp/>1:</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>1.0</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>0.1<sp/>*<sp/>mscale<sp/>*<sp/>math.log(scale)<sp/>+<sp/>1.0</highlight></codeline>
<codeline lineno="311"><highlight class="normal"></highlight></codeline>
<codeline lineno="312"><highlight class="normal"></highlight></codeline>
<codeline lineno="313" refid="namespacemodeling__deepseek_1a241d0772b349f4669077765b46345cdf" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1a241d0772b349f4669077765b46345cdf" kindref="member">yarn_linear_ramp_mask</ref>(min,<sp/>max,<sp/>dim):</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>min<sp/>==<sp/>max:</highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max<sp/>+=<sp/>0.001<sp/><sp/></highlight><highlight class="comment">#<sp/>Prevent<sp/>singularity</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"></highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/>linear_func<sp/>=<sp/>(torch.arange(dim,<sp/>dtype=torch.float32)<sp/>-<sp/>min)<sp/>/<sp/>(max<sp/>-<sp/>min)</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/>ramp_func<sp/>=<sp/>torch.clamp(linear_func,<sp/>0,<sp/>1)</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>ramp_func</highlight></codeline>
<codeline lineno="320"><highlight class="normal"></highlight></codeline>
<codeline lineno="321"><highlight class="normal"></highlight></codeline>
<codeline lineno="322" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding" kindref="compound">DeepseekV3YarnRotaryEmbedding</ref>(<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding" kindref="compound">DeepseekV3RotaryEmbedding</ref>):</highlight></codeline>
<codeline lineno="323"><highlight class="normal"></highlight></codeline>
<codeline lineno="324" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a7e381647020b937d72ecb2b8da32415f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a7e381647020b937d72ecb2b8da32415f" kindref="member">__init__</ref>(</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dim,</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=2048,</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=10000,</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device=None,</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor=1.0,</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>original_max_position_embeddings=4096,</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>beta_fast=32,</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>beta_slow=1,</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mscale=1,</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mscale_all_dim=0,</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="337" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0450cef3403d2d07eb74172126e825f7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0450cef3403d2d07eb74172126e825f7" kindref="member">scaling_factor</ref><sp/>=<sp/>scaling_factor</highlight></codeline>
<codeline lineno="338" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a9bcb88b24920df2af9a1a6699f4cfc71" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a9bcb88b24920df2af9a1a6699f4cfc71" kindref="member">original_max_position_embeddings</ref><sp/>=<sp/>original_max_position_embeddings</highlight></codeline>
<codeline lineno="339" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1aa848f331156c2c3622f170f063147586" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1aa848f331156c2c3622f170f063147586" kindref="member">beta_fast</ref><sp/>=<sp/>beta_fast</highlight></codeline>
<codeline lineno="340" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a7186257b9000a06e47cf4f5e2d11f35a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a7186257b9000a06e47cf4f5e2d11f35a" kindref="member">beta_slow</ref><sp/>=<sp/>beta_slow</highlight></codeline>
<codeline lineno="341" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a977c90d71cc8ead486782f3d33b5786e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a977c90d71cc8ead486782f3d33b5786e" kindref="member">mscale</ref><sp/>=<sp/>mscale</highlight></codeline>
<codeline lineno="342" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a56a46e30963d56baf32ab412f87b173d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a56a46e30963d56baf32ab412f87b173d" kindref="member">mscale_all_dim</ref><sp/>=<sp/>mscale_all_dim</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a7e381647020b937d72ecb2b8da32415f" kindref="member">__init__</ref>(dim,<sp/>max_position_embeddings,<sp/>base,<sp/>device)</highlight></codeline>
<codeline lineno="344"><highlight class="normal"></highlight></codeline>
<codeline lineno="345" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a6f5c4d2f0bb03b152f6c4a6a6045f8ad" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a6f5c4d2f0bb03b152f6c4a6a6045f8ad" kindref="member">_set_cos_sin_cache</ref>(self,<sp/>seq_len,<sp/>device,<sp/>dtype):</highlight></codeline>
<codeline lineno="346" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a3f2beb6f11dce391469b0897ad79b447" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aaacc804689a5d12fc0b95ffa05cf224b" kindref="member">max_seq_len_cached</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a3f2beb6f11dce391469b0897ad79b447" kindref="member">max_seq_len_cached</ref><sp/>=<sp/>seq_len</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dim<sp/>=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1aa8e8d5b5d8ed37578d435e3767839f23" kindref="member">dim</ref></highlight></codeline>
<codeline lineno="348"><highlight class="normal"></highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freq_extra<sp/>=<sp/>1.0<sp/>/<sp/>(</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" kindref="member">base</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0b2cef3a2a3f0c6f985291f2d302084c" kindref="member">base</ref></highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**<sp/>(torch.arange(0,<sp/>dim,<sp/>2,<sp/>dtype=torch.float32,<sp/>device=device)<sp/>/<sp/>dim)</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freq_inter<sp/>=<sp/>1.0<sp/>/<sp/>(</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0450cef3403d2d07eb74172126e825f7" kindref="member">scaling_factor</ref></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" kindref="member">base</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0b2cef3a2a3f0c6f985291f2d302084c" kindref="member">base</ref></highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**<sp/>(torch.arange(0,<sp/>dim,<sp/>2,<sp/>dtype=torch.float32,<sp/>device=device)<sp/>/<sp/>dim)</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="358"><highlight class="normal"></highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>low,<sp/>high<sp/>=<sp/><ref refid="namespacemodeling__deepseek_1ab17059a7c13afd5df5eda1a07fe7e6b7" kindref="member">yarn_find_correction_range</ref>(</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1aa848f331156c2c3622f170f063147586" kindref="member">beta_fast</ref>,</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a7186257b9000a06e47cf4f5e2d11f35a" kindref="member">beta_slow</ref>,</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dim,</highlight></codeline>
<codeline lineno="363" refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0b2cef3a2a3f0c6f985291f2d302084c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3RotaryEmbedding_1a015f24ad70439d3fb24fc901df9f7309" kindref="member">base</ref><ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0b2cef3a2a3f0c6f985291f2d302084c" kindref="member">base</ref>,</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a9bcb88b24920df2af9a1a6699f4cfc71" kindref="member">original_max_position_embeddings</ref>,</highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inv_freq_mask<sp/>=<sp/>1.0<sp/>-<sp/><ref refid="namespacemodeling__deepseek_1a241d0772b349f4669077765b46345cdf" kindref="member">yarn_linear_ramp_mask</ref>(low,<sp/>high,<sp/>dim<sp/>//<sp/>2).to(</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device=device,<sp/>dtype=torch.float32</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inv_freq<sp/>=<sp/>freq_inter<sp/>*<sp/>(1<sp/>-<sp/>inv_freq_mask)<sp/>+<sp/>freq_extra<sp/>*<sp/>inv_freq_mask</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight><highlight class="stringliteral">&quot;inv_freq&quot;</highlight><highlight class="normal">,<sp/>inv_freq,<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="371"><highlight class="normal"></highlight></codeline>
<codeline lineno="372"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>t<sp/>=<sp/>torch.arange(seq_len,<sp/>device=device,<sp/>dtype=torch.float32)</highlight></codeline>
<codeline lineno="373"><highlight class="normal"></highlight></codeline>
<codeline lineno="374"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>freqs<sp/>=<sp/>torch.outer(t,<sp/>inv_freq)</highlight></codeline>
<codeline lineno="375"><highlight class="normal"></highlight></codeline>
<codeline lineno="376"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_mscale<sp/>=<sp/>float(</highlight></codeline>
<codeline lineno="377"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="namespacemodeling__deepseek_1a34b414bdb0bddfa5b31edbc45c4a85de" kindref="member">yarn_get_mscale</ref>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0450cef3403d2d07eb74172126e825f7" kindref="member">scaling_factor</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a977c90d71cc8ead486782f3d33b5786e" kindref="member">mscale</ref>)</highlight></codeline>
<codeline lineno="378"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>/<sp/><ref refid="namespacemodeling__deepseek_1a34b414bdb0bddfa5b31edbc45c4a85de" kindref="member">yarn_get_mscale</ref>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a0450cef3403d2d07eb74172126e825f7" kindref="member">scaling_factor</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3YarnRotaryEmbedding_1a56a46e30963d56baf32ab412f87b173d" kindref="member">mscale_all_dim</ref>)</highlight></codeline>
<codeline lineno="379"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="380"><highlight class="normal"></highlight></codeline>
<codeline lineno="381"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>emb<sp/>=<sp/>torch.cat((freqs,<sp/>freqs),<sp/>dim=-1)</highlight></codeline>
<codeline lineno="382"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;cos_cached&quot;</highlight><highlight class="normal">,<sp/>(emb.cos()<sp/>*<sp/>_mscale).to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.register_buffer(</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;sin_cached&quot;</highlight><highlight class="normal">,<sp/>(emb.sin()<sp/>*<sp/>_mscale).to(dtype),<sp/>persistent=</highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="388"><highlight class="normal"></highlight></codeline>
<codeline lineno="389"><highlight class="normal"></highlight></codeline>
<codeline lineno="390"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.rotate_half</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="391" refid="namespacemodeling__deepseek_1ac3015cd18af85cbf60800ee0a8091b87" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1ac3015cd18af85cbf60800ee0a8091b87" kindref="member">rotate_half</ref>(x):</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Rotates<sp/>half<sp/>the<sp/>hidden<sp/>dims<sp/>of<sp/>the<sp/>input.&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/>x1<sp/>=<sp/>x[...,<sp/>:<sp/>x.shape[-1]<sp/>//<sp/>2]</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/>x2<sp/>=<sp/>x[...,<sp/>x.shape[-1]<sp/>//<sp/>2<sp/>:]</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>torch.cat((-x2,<sp/>x1),<sp/>dim=-1)</highlight></codeline>
<codeline lineno="396"><highlight class="normal"></highlight></codeline>
<codeline lineno="397"><highlight class="normal"></highlight></codeline>
<codeline lineno="398"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.apply_rotary_pos_emb</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="399" refid="namespacemodeling__deepseek_1a1a750b896c05148a865beae617cc3153" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1a1a750b896c05148a865beae617cc3153" kindref="member">apply_rotary_pos_emb</ref>(q,<sp/>k,<sp/>cos,<sp/>sin,<sp/>position_ids,<sp/>unsqueeze_dim=1):</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Applies<sp/>Rotary<sp/>Position<sp/>Embedding<sp/>to<sp/>the<sp/>query<sp/>and<sp/>key<sp/>tensors.</highlight></codeline>
<codeline lineno="401"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>Args:</highlight></codeline>
<codeline lineno="402"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>(`torch.Tensor`):<sp/>The<sp/>query<sp/>tensor.</highlight></codeline>
<codeline lineno="403"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>k<sp/>(`torch.Tensor`):<sp/>The<sp/>key<sp/>tensor.</highlight></codeline>
<codeline lineno="404"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cos<sp/>(`torch.Tensor`):<sp/>The<sp/>cosine<sp/>part<sp/>of<sp/>the<sp/>rotary<sp/>embedding.</highlight></codeline>
<codeline lineno="405"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sin<sp/>(`torch.Tensor`):<sp/>The<sp/>sine<sp/>part<sp/>of<sp/>the<sp/>rotary<sp/>embedding.</highlight></codeline>
<codeline lineno="406"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>(`torch.Tensor`):</highlight></codeline>
<codeline lineno="407"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>The<sp/>position<sp/>indices<sp/>of<sp/>the<sp/>tokens<sp/>corresponding<sp/>to<sp/>the<sp/>query<sp/>and<sp/>key<sp/>tensors.<sp/>For<sp/>example,<sp/>this<sp/>can<sp/>be</highlight></codeline>
<codeline lineno="408"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>used<sp/>to<sp/>pass<sp/>offsetted<sp/>position<sp/>ids<sp/>when<sp/>working<sp/>with<sp/>a<sp/>KV-cache.</highlight></codeline>
<codeline lineno="409"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>unsqueeze_dim<sp/>(`int`,<sp/>*optional*,<sp/>defaults<sp/>to<sp/>1):</highlight></codeline>
<codeline lineno="410"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>The<sp/>&apos;unsqueeze_dim&apos;<sp/>argument<sp/>specifies<sp/>the<sp/>dimension<sp/>along<sp/>which<sp/>to<sp/>unsqueeze<sp/>cos[position_ids]<sp/>and</highlight></codeline>
<codeline lineno="411"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sin[position_ids]<sp/>so<sp/>that<sp/>they<sp/>can<sp/>be<sp/>properly<sp/>broadcasted<sp/>to<sp/>the<sp/>dimensions<sp/>of<sp/>q<sp/>and<sp/>k.<sp/>For<sp/>example,<sp/>note</highlight></codeline>
<codeline lineno="412"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>that<sp/>cos[position_ids]<sp/>and<sp/>sin[position_ids]<sp/>have<sp/>the<sp/>shape<sp/>[batch_size,<sp/>seq_len,<sp/>head_dim].<sp/>Then,<sp/>if<sp/>q<sp/>and</highlight></codeline>
<codeline lineno="413"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>k<sp/>have<sp/>the<sp/>shape<sp/>[batch_size,<sp/>heads,<sp/>seq_len,<sp/>head_dim],<sp/>then<sp/>setting<sp/>unsqueeze_dim=1<sp/>makes</highlight></codeline>
<codeline lineno="414"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cos[position_ids]<sp/>and<sp/>sin[position_ids]<sp/>broadcastable<sp/>to<sp/>the<sp/>shapes<sp/>of<sp/>q<sp/>and<sp/>k.<sp/>Similarly,<sp/>if<sp/>q<sp/>and<sp/>k<sp/>have</highlight></codeline>
<codeline lineno="415"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>the<sp/>shape<sp/>[batch_size,<sp/>seq_len,<sp/>heads,<sp/>head_dim],<sp/>then<sp/>set<sp/>unsqueeze_dim=2.</highlight></codeline>
<codeline lineno="416"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>Returns:</highlight></codeline>
<codeline lineno="417"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>`tuple(torch.Tensor)`<sp/>comprising<sp/>of<sp/>the<sp/>query<sp/>and<sp/>key<sp/>tensors<sp/>rotated<sp/>using<sp/>the<sp/>Rotary<sp/>Position<sp/>Embedding.</highlight></codeline>
<codeline lineno="418"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/>cos<sp/>=<sp/>cos[position_ids].unsqueeze(unsqueeze_dim)</highlight></codeline>
<codeline lineno="420"><highlight class="normal"><sp/><sp/><sp/><sp/>sin<sp/>=<sp/>sin[position_ids].unsqueeze(unsqueeze_dim)</highlight></codeline>
<codeline lineno="421"><highlight class="normal"></highlight></codeline>
<codeline lineno="422"><highlight class="normal"><sp/><sp/><sp/><sp/>b,<sp/>h,<sp/>s,<sp/>d<sp/>=<sp/>q.shape</highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/>q<sp/>=<sp/>q.view(b,<sp/>h,<sp/>s,<sp/>d<sp/>//<sp/>2,<sp/>2).transpose(4,<sp/>3).reshape(b,<sp/>h,<sp/>s,<sp/>d)</highlight></codeline>
<codeline lineno="424"><highlight class="normal"></highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/>b,<sp/>h,<sp/>s,<sp/>d<sp/>=<sp/>k.shape</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/>k<sp/>=<sp/>k.view(b,<sp/>h,<sp/>s,<sp/>d<sp/>//<sp/>2,<sp/>2).transpose(4,<sp/>3).reshape(b,<sp/>h,<sp/>s,<sp/>d)</highlight></codeline>
<codeline lineno="427"><highlight class="normal"></highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/>q_embed<sp/>=<sp/>(q<sp/>*<sp/>cos)<sp/>+<sp/>(<ref refid="namespacemodeling__deepseek_1ac3015cd18af85cbf60800ee0a8091b87" kindref="member">rotate_half</ref>(q)<sp/>*<sp/>sin)</highlight></codeline>
<codeline lineno="429"><highlight class="normal"><sp/><sp/><sp/><sp/>k_embed<sp/>=<sp/>(k<sp/>*<sp/>cos)<sp/>+<sp/>(<ref refid="namespacemodeling__deepseek_1ac3015cd18af85cbf60800ee0a8091b87" kindref="member">rotate_half</ref>(k)<sp/>*<sp/>sin)</highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>q_embed,<sp/>k_embed</highlight></codeline>
<codeline lineno="431"><highlight class="normal"></highlight></codeline>
<codeline lineno="432"><highlight class="normal"></highlight></codeline>
<codeline lineno="433" refid="classmodeling__deepseek_1_1DeepseekV3MLP" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MLP" kindref="compound">DeepseekV3MLP</ref>(nn.Module):</highlight></codeline>
<codeline lineno="434" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ae9b26577d4b936f5b0385dfa5f4f467d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ae9b26577d4b936f5b0385dfa5f4f467d" kindref="member">__init__</ref>(self,<sp/>config,<sp/>hidden_size=None,<sp/>intermediate_size=None):</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ae9b26577d4b936f5b0385dfa5f4f467d" kindref="member">__init__</ref>()</highlight></codeline>
<codeline lineno="436" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a21b62497b6d89e9367e3bfc2a0cdae23" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a21b62497b6d89e9367e3bfc2a0cdae23" kindref="member">config</ref><sp/>=<sp/>config</highlight></codeline>
<codeline lineno="437" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad6ec7ad20f7ad22a1a3b4dfc08c77232" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad6ec7ad20f7ad22a1a3b4dfc08c77232" kindref="member">hidden_size</ref><sp/>=<sp/>config.hidden_size<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>hidden_size<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>hidden_size</highlight></codeline>
<codeline lineno="438" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad0dce99a7a4ce56663b7e56dc360c612" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad0dce99a7a4ce56663b7e56dc360c612" kindref="member">intermediate_size</ref><sp/>=<sp/>(</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.intermediate_size<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>intermediate_size<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>intermediate_size</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="441"><highlight class="normal"></highlight></codeline>
<codeline lineno="442" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a04c5b1fca10614d4ec0576a3328ed95a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a04c5b1fca10614d4ec0576a3328ed95a" kindref="member">gate_proj</ref><sp/>=<sp/>nn.Linear(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad6ec7ad20f7ad22a1a3b4dfc08c77232" kindref="member">hidden_size</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad0dce99a7a4ce56663b7e56dc360c612" kindref="member">intermediate_size</ref>,<sp/>bias=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="443" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a7f3065c6feff10e2c47e6e4036c4d59d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a7f3065c6feff10e2c47e6e4036c4d59d" kindref="member">up_proj</ref><sp/>=<sp/>nn.Linear(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad6ec7ad20f7ad22a1a3b4dfc08c77232" kindref="member">hidden_size</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad0dce99a7a4ce56663b7e56dc360c612" kindref="member">intermediate_size</ref>,<sp/>bias=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="444" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a9f19556d227dc20ec1c038bf1c231702" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a9f19556d227dc20ec1c038bf1c231702" kindref="member">down_proj</ref><sp/>=<sp/>nn.Linear(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad0dce99a7a4ce56663b7e56dc360c612" kindref="member">intermediate_size</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1ad6ec7ad20f7ad22a1a3b4dfc08c77232" kindref="member">hidden_size</ref>,<sp/>bias=</highlight><highlight class="keyword">False</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="445" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a6c78de28c06d079513715a8f72571fb8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a6c78de28c06d079513715a8f72571fb8" kindref="member">act_fn</ref><sp/>=<sp/>ACT2FN[config.hidden_act]</highlight></codeline>
<codeline lineno="446"><highlight class="normal"></highlight></codeline>
<codeline lineno="447" refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a2d3ccef3b5a7595610caa94ae8076687" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a2d3ccef3b5a7595610caa94ae8076687" kindref="member">forward</ref>(self,<sp/>x):</highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>down_proj<sp/>=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a9f19556d227dc20ec1c038bf1c231702" kindref="member">down_proj</ref>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a6c78de28c06d079513715a8f72571fb8" kindref="member">act_fn</ref>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a04c5b1fca10614d4ec0576a3328ed95a" kindref="member">gate_proj</ref>(x))<sp/>*<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MLP_1a7f3065c6feff10e2c47e6e4036c4d59d" kindref="member">up_proj</ref>(x))</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>down_proj</highlight></codeline>
<codeline lineno="450"><highlight class="normal"></highlight></codeline>
<codeline lineno="451"><highlight class="normal"></highlight></codeline>
<codeline lineno="452" refid="classmodeling__deepseek_1_1MoEGate" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1MoEGate" kindref="compound">MoEGate</ref>(nn.Module):</highlight></codeline>
<codeline lineno="453" refid="classmodeling__deepseek_1_1MoEGate_1ac50ed7ab225f5cff4ae21ddf15de0cd5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1MoEGate_1ac50ed7ab225f5cff4ae21ddf15de0cd5" kindref="member">__init__</ref>(self,<sp/>config):</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1MoEGate_1ac50ed7ab225f5cff4ae21ddf15de0cd5" kindref="member">__init__</ref>()</highlight></codeline>
<codeline lineno="455" refid="classmodeling__deepseek_1_1MoEGate_1a175a68827b832da6b31df800506cd7cc" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a175a68827b832da6b31df800506cd7cc" kindref="member">config</ref><sp/>=<sp/>config</highlight></codeline>
<codeline lineno="456" refid="classmodeling__deepseek_1_1MoEGate_1a5fe88e1d4ff6abb14c97196173a34f8e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a5fe88e1d4ff6abb14c97196173a34f8e" kindref="member">top_k</ref><sp/>=<sp/>config.num_experts_per_tok</highlight></codeline>
<codeline lineno="457" refid="classmodeling__deepseek_1_1MoEGate_1a4c5d307e8b47dfd7d6302dcdeb0632c3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a4c5d307e8b47dfd7d6302dcdeb0632c3" kindref="member">n_routed_experts</ref><sp/>=<sp/>config.n_routed_experts</highlight></codeline>
<codeline lineno="458" refid="classmodeling__deepseek_1_1MoEGate_1afee88d90fd7377e9d5e2e0ca3dd2c05d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1afee88d90fd7377e9d5e2e0ca3dd2c05d" kindref="member">routed_scaling_factor</ref><sp/>=<sp/>config.routed_scaling_factor</highlight></codeline>
<codeline lineno="459" refid="classmodeling__deepseek_1_1MoEGate_1a77ec2442dea904601fc1e35f890e1860" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a77ec2442dea904601fc1e35f890e1860" kindref="member">scoring_func</ref><sp/>=<sp/>config.scoring_func</highlight></codeline>
<codeline lineno="460" refid="classmodeling__deepseek_1_1MoEGate_1a9a42f726280fd1bc15330b7f3216e95b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a9a42f726280fd1bc15330b7f3216e95b" kindref="member">seq_aux</ref><sp/>=<sp/>config.seq_aux</highlight></codeline>
<codeline lineno="461" refid="classmodeling__deepseek_1_1MoEGate_1afa00ffb1dabc5b300a441e48b241b412" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1afa00ffb1dabc5b300a441e48b241b412" kindref="member">topk_method</ref><sp/>=<sp/>config.topk_method</highlight></codeline>
<codeline lineno="462" refid="classmodeling__deepseek_1_1MoEGate_1ae44ae50f6e7b07c1ee1d265f3935f57c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1ae44ae50f6e7b07c1ee1d265f3935f57c" kindref="member">n_group</ref><sp/>=<sp/>config.n_group</highlight></codeline>
<codeline lineno="463" refid="classmodeling__deepseek_1_1MoEGate_1a420ede75d878914bf57a1a8b0635022b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a420ede75d878914bf57a1a8b0635022b" kindref="member">topk_group</ref><sp/>=<sp/>config.topk_group</highlight></codeline>
<codeline lineno="464"><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">#<sp/>topk<sp/>selection<sp/>algorithm</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="466" refid="classmodeling__deepseek_1_1MoEGate_1a14f1676e0baa38cd3f641c97cb95c694" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a14f1676e0baa38cd3f641c97cb95c694" kindref="member">norm_topk_prob</ref><sp/>=<sp/>config.norm_topk_prob</highlight></codeline>
<codeline lineno="467" refid="classmodeling__deepseek_1_1MoEGate_1a3aed25f433556ffd76640df5d7093be3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a3aed25f433556ffd76640df5d7093be3" kindref="member">gating_dim</ref><sp/>=<sp/>config.hidden_size</highlight></codeline>
<codeline lineno="468" refid="classmodeling__deepseek_1_1MoEGate_1a75b199559cf3835df724f8c1c3485d28" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a75b199559cf3835df724f8c1c3485d28" kindref="member">weight</ref><sp/>=<sp/>nn.Parameter(</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.empty((self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a4c5d307e8b47dfd7d6302dcdeb0632c3" kindref="member">n_routed_experts</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a3aed25f433556ffd76640df5d7093be3" kindref="member">gating_dim</ref>))</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1afa00ffb1dabc5b300a441e48b241b412" kindref="member">topk_method</ref><sp/>==<sp/></highlight><highlight class="stringliteral">&quot;noaux_tc&quot;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="472" refid="classmodeling__deepseek_1_1MoEGate_1a6496432799fc3ed30118819f88722080" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a6496432799fc3ed30118819f88722080" kindref="member">e_score_correction_bias</ref><sp/>=<sp/>nn.Parameter(</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.empty((self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a4c5d307e8b47dfd7d6302dcdeb0632c3" kindref="member">n_routed_experts</ref>))</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a08b5f10d1d2dcd7922399d226056e1be" kindref="member">reset_parameters</ref>()</highlight></codeline>
<codeline lineno="476"><highlight class="normal"></highlight></codeline>
<codeline lineno="477" refid="classmodeling__deepseek_1_1MoEGate_1a08b5f10d1d2dcd7922399d226056e1be" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1MoEGate_1a08b5f10d1d2dcd7922399d226056e1be" kindref="member">reset_parameters</ref>(self)<sp/>-&gt;<sp/>None:</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>torch.nn.init<sp/></highlight><highlight class="keyword">as</highlight><highlight class="normal"><sp/>init</highlight></codeline>
<codeline lineno="479"><highlight class="normal"></highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>init.kaiming_uniform_(self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a75b199559cf3835df724f8c1c3485d28" kindref="member">weight</ref>,<sp/>a=math.sqrt(5))</highlight></codeline>
<codeline lineno="481"><highlight class="normal"></highlight></codeline>
<codeline lineno="482" refid="classmodeling__deepseek_1_1MoEGate_1aa6700ebbe1311738105223d9ab2638d4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1MoEGate_1aa6700ebbe1311738105223d9ab2638d4" kindref="member">forward</ref>(self,<sp/>hidden_states):</highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bsz,<sp/>seq_len,<sp/>h<sp/>=<sp/>hidden_states.shape</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>hidden_states.view(-1,<sp/>h)</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logits<sp/>=<sp/>F.linear(</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states.type(torch.float32),<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a75b199559cf3835df724f8c1c3485d28" kindref="member">weight</ref>.type(torch.float32),<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a77ec2442dea904601fc1e35f890e1860" kindref="member">scoring_func</ref><sp/>==<sp/></highlight><highlight class="stringliteral">&quot;sigmoid&quot;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scores<sp/>=<sp/>logits.sigmoid()</highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>NotImplementedError(</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;insupportable<sp/>scoring<sp/>function<sp/>for<sp/>MoE<sp/>gating:<sp/>{self.scoring_func}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="495"><highlight class="normal"></highlight></codeline>
<codeline lineno="496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1afa00ffb1dabc5b300a441e48b241b412" kindref="member">topk_method</ref><sp/>==<sp/></highlight><highlight class="stringliteral">&quot;noaux_tc&quot;</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">assert</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.training</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scores_for_choice<sp/>=<sp/>scores.view(bsz<sp/>*<sp/>seq_len,<sp/>-1)<sp/>+<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a6496432799fc3ed30118819f88722080" kindref="member">e_score_correction_bias</ref>.unsqueeze(0)</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>group_scores<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="501"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scores_for_choice.view(bsz<sp/>*<sp/>seq_len,<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1ae44ae50f6e7b07c1ee1d265f3935f57c" kindref="member">n_group</ref>,<sp/>-1).topk(2,<sp/>dim=-1)[0].sum(dim<sp/>=<sp/>-1)</highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/><sp/></highlight><highlight class="comment">#<sp/>[n,<sp/>n_group]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>group_idx<sp/>=<sp/>torch.topk(</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>group_scores,<sp/>k=self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a420ede75d878914bf57a1a8b0635022b" kindref="member">topk_group</ref>,<sp/>dim=-1,<sp/>sorted=</highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)[</highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>1</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]<sp/><sp/></highlight><highlight class="comment">#<sp/>[n,<sp/>top_k_group]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>group_mask<sp/>=<sp/>torch.zeros_like(group_scores)<sp/><sp/></highlight><highlight class="comment">#<sp/>[n,<sp/>n_group]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>group_mask.scatter_(1,<sp/>group_idx,<sp/>1)<sp/><sp/></highlight><highlight class="comment">#<sp/>[n,<sp/>n_group]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>score_mask<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>group_mask.unsqueeze(-1)</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.expand(</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bsz<sp/>*<sp/>seq_len,<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1ae44ae50f6e7b07c1ee1d265f3935f57c" kindref="member">n_group</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a4c5d307e8b47dfd7d6302dcdeb0632c3" kindref="member">n_routed_experts</ref><sp/>//<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1ae44ae50f6e7b07c1ee1d265f3935f57c" kindref="member">n_group</ref></highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.reshape(bsz<sp/>*<sp/>seq_len,<sp/>-1)</highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/><sp/></highlight><highlight class="comment">#<sp/>[n,<sp/>e]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tmp_scores<sp/>=<sp/>scores_for_choice.masked_fill(~score_mask.bool(),<sp/>0.0)<sp/><sp/></highlight><highlight class="comment">#<sp/>[n,<sp/>e]</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>_,<sp/>topk_idx<sp/>=<sp/>torch.topk(</highlight></codeline>
<codeline lineno="519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tmp_scores,<sp/>k=self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a5fe88e1d4ff6abb14c97196173a34f8e" kindref="member">top_k</ref>,<sp/>dim=-1,<sp/>sorted=</highlight><highlight class="keyword">False</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>topk_weight<sp/>=<sp/>scores.gather(1,<sp/>topk_idx)</highlight></codeline>
<codeline lineno="522"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">raise</highlight><highlight class="normal"><sp/>NotImplementedError(</highlight></codeline>
<codeline lineno="524"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f</highlight><highlight class="stringliteral">&quot;insupportable<sp/>TopK<sp/>function<sp/>for<sp/>MoE<sp/>gating:<sp/>{self.topk_method}&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="526"><highlight class="normal"></highlight></codeline>
<codeline lineno="527"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a5fe88e1d4ff6abb14c97196173a34f8e" kindref="member">top_k</ref><sp/>&gt;<sp/>1<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1a14f1676e0baa38cd3f641c97cb95c694" kindref="member">norm_topk_prob</ref>:</highlight></codeline>
<codeline lineno="529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>denominator<sp/>=<sp/>topk_weight.sum(dim=-1,<sp/>keepdim=</highlight><highlight class="keyword">True</highlight><highlight class="normal">)<sp/>+<sp/>1e-20</highlight></codeline>
<codeline lineno="530"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>topk_weight<sp/>=<sp/>topk_weight<sp/>/<sp/>denominator</highlight></codeline>
<codeline lineno="531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>topk_weight<sp/>=<sp/>topk_weight<sp/>*<sp/>self.<ref refid="classmodeling__deepseek_1_1MoEGate_1afee88d90fd7377e9d5e2e0ca3dd2c05d" kindref="member">routed_scaling_factor</ref><sp/></highlight><highlight class="comment">#<sp/>must<sp/>multiply<sp/>the<sp/>scaling<sp/>factor</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="532"><highlight class="normal"></highlight></codeline>
<codeline lineno="533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>topk_idx,<sp/>topk_weight</highlight></codeline>
<codeline lineno="534"><highlight class="normal"></highlight></codeline>
<codeline lineno="535" refid="classmodeling__deepseek_1_1DeepseekV3MoE" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MoE" kindref="compound">DeepseekV3MoE</ref>(nn.Module):</highlight></codeline>
<codeline lineno="536"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="537"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>A<sp/>mixed<sp/>expert<sp/>module<sp/>containing<sp/>shared<sp/>experts.</highlight></codeline>
<codeline lineno="538"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="539"><highlight class="normal"></highlight></codeline>
<codeline lineno="540" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a96905b42a7ed512b23308776564909f2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a96905b42a7ed512b23308776564909f2" kindref="member">__init__</ref>(self,<sp/>config):</highlight></codeline>
<codeline lineno="541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a96905b42a7ed512b23308776564909f2" kindref="member">__init__</ref>()</highlight></codeline>
<codeline lineno="542" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ad7c503743dd456891b376984f9c69ad6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ad7c503743dd456891b376984f9c69ad6" kindref="member">config</ref><sp/>=<sp/>config</highlight></codeline>
<codeline lineno="543" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a82fcfa5197c93b130f5ebf788cefd7d7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a82fcfa5197c93b130f5ebf788cefd7d7" kindref="member">num_experts_per_tok</ref><sp/>=<sp/>config.num_experts_per_tok</highlight></codeline>
<codeline lineno="544"><highlight class="normal"></highlight></codeline>
<codeline lineno="545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>hasattr(config,<sp/></highlight><highlight class="stringliteral">&quot;ep_size&quot;</highlight><highlight class="normal">)<sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>config.ep_size<sp/>&gt;<sp/>1:</highlight></codeline>
<codeline lineno="546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">assert</highlight><highlight class="normal"><sp/>config.ep_size<sp/>==<sp/>dist.get_world_size()</highlight></codeline>
<codeline lineno="547" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref><sp/>=<sp/>config.ep_size</highlight></codeline>
<codeline lineno="548" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref><sp/>=<sp/>config.n_routed_experts<sp/>//<sp/>config.ep_size</highlight></codeline>
<codeline lineno="549" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ab252352f006c96f59a1966b33eb7fdc4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ab252352f006c96f59a1966b33eb7fdc4" kindref="member">ep_rank</ref><sp/>=<sp/>dist.get_rank()</highlight></codeline>
<codeline lineno="550" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a4ae045a0a52bd60ae8a3ccd9874f02d7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a4ae045a0a52bd60ae8a3ccd9874f02d7" kindref="member">experts</ref><sp/>=<sp/>nn.ModuleList(</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[</highlight></codeline>
<codeline lineno="552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classmodeling__deepseek_1_1DeepseekV3MLP" kindref="compound">DeepseekV3MLP</ref>(</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config,<sp/>intermediate_size=config.moe_intermediate_size</highlight></codeline>
<codeline lineno="555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>i<sp/>&gt;=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ab252352f006c96f59a1966b33eb7fdc4" kindref="member">ep_rank</ref><sp/>*<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref></highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">and</highlight><highlight class="normal"><sp/>i<sp/>&lt;<sp/>(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ab252352f006c96f59a1966b33eb7fdc4" kindref="member">ep_rank</ref><sp/>+<sp/>1)<sp/>*<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref></highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>i<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>range(config.n_routed_experts)</highlight></codeline>
<codeline lineno="561"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]</highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref><sp/>=<sp/>1</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref><sp/>=<sp/>config.n_routed_experts</highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ab252352f006c96f59a1966b33eb7fdc4" kindref="member">ep_rank</ref><sp/>=<sp/>0</highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a4ae045a0a52bd60ae8a3ccd9874f02d7" kindref="member">experts</ref><sp/>=<sp/>nn.ModuleList(</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classmodeling__deepseek_1_1DeepseekV3MLP" kindref="compound">DeepseekV3MLP</ref>(</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config,<sp/>intermediate_size=config.moe_intermediate_size</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>i<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>range(config.n_routed_experts)</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="575" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a2f583653dc523f5a303c379499d0f408" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a2f583653dc523f5a303c379499d0f408" kindref="member">gate</ref><sp/>=<sp/><ref refid="classmodeling__deepseek_1_1MoEGate" kindref="compound">MoEGate</ref>(config)</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>config.n_shared_experts<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>intermediate_size<sp/>=<sp/>config.moe_intermediate_size<sp/>*<sp/>config.n_shared_experts</highlight></codeline>
<codeline lineno="578" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a90c242857bf845ebf2a97c9e4f7fde86" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a90c242857bf845ebf2a97c9e4f7fde86" kindref="member">shared_experts</ref><sp/>=<sp/><ref refid="classmodeling__deepseek_1_1DeepseekV3MLP" kindref="compound">DeepseekV3MLP</ref>(</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config=config,<sp/>intermediate_size=intermediate_size</highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="581"><highlight class="normal"></highlight></codeline>
<codeline lineno="582" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a17e46f3082bc2c1cd4e74fe2ff2685c7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a17e46f3082bc2c1cd4e74fe2ff2685c7" kindref="member">forward</ref>(self,<sp/>hidden_states):</highlight></codeline>
<codeline lineno="583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>identity<sp/>=<sp/>hidden_states</highlight></codeline>
<codeline lineno="584"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>orig_shape<sp/>=<sp/>hidden_states.shape</highlight></codeline>
<codeline lineno="585"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>topk_idx,<sp/>topk_weight<sp/>=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a2f583653dc523f5a303c379499d0f408" kindref="member">gate</ref>(hidden_states)</highlight></codeline>
<codeline lineno="586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>hidden_states.view(-1,<sp/>hidden_states.shape[-1])</highlight></codeline>
<codeline lineno="587"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>flat_topk_idx<sp/>=<sp/>topk_idx.view(-1)</highlight></codeline>
<codeline lineno="588"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/>self.training:</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>y<sp/>=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae3d9e2c537bcb2df062cdff8328ba839" kindref="member">moe_infer</ref>(hidden_states,<sp/>topk_idx,<sp/>topk_weight).view(*orig_shape)</highlight></codeline>
<codeline lineno="590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ad7c503743dd456891b376984f9c69ad6" kindref="member">config</ref>.n_shared_experts<sp/></highlight><highlight class="keywordflow">is</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">not</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">:</highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>y<sp/>=<sp/>y<sp/>+<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a90c242857bf845ebf2a97c9e4f7fde86" kindref="member">shared_experts</ref>(identity)</highlight></codeline>
<codeline lineno="592"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>y</highlight></codeline>
<codeline lineno="593"><highlight class="normal"></highlight></codeline>
<codeline lineno="594"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="preprocessor">@torch.no_grad()</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="595" refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae3d9e2c537bcb2df062cdff8328ba839" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae3d9e2c537bcb2df062cdff8328ba839" kindref="member">moe_infer</ref>(self,<sp/>x,<sp/>topk_ids,<sp/>topk_weight):</highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cnts<sp/>=<sp/>topk_ids.new_zeros((topk_ids.shape[0],<sp/>len(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a4ae045a0a52bd60ae8a3ccd9874f02d7" kindref="member">experts</ref>)))</highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cnts.scatter_(1,<sp/>topk_ids,<sp/>1)</highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert<sp/>=<sp/>cnts.sum(dim=0)</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idxs<sp/>=<sp/>topk_ids.view(-1).argsort()</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sorted_tokens<sp/>=<sp/>x[idxs<sp/>//<sp/>topk_ids.shape[1]]</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sorted_tokens_shape<sp/>=<sp/>sorted_tokens.shape</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref><sp/>&gt;<sp/>1:</highlight></codeline>
<codeline lineno="603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_ep_rank<sp/>=<sp/>tokens_per_expert.view(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref>,<sp/>-1).sum(dim=1)</highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert_group<sp/>=<sp/>tokens_per_expert.new_empty(</highlight></codeline>
<codeline lineno="605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert.shape[0]</highlight></codeline>
<codeline lineno="606"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="607"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dist.all_to_all_single(tokens_per_expert_group,<sp/>tokens_per_expert)</highlight></codeline>
<codeline lineno="608"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_splits<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="609"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert_group.view(self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref>,<sp/>-1)</highlight></codeline>
<codeline lineno="610"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.sum(1)</highlight></codeline>
<codeline lineno="611"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.cpu()</highlight></codeline>
<codeline lineno="612"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.numpy()</highlight></codeline>
<codeline lineno="613"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.tolist()</highlight></codeline>
<codeline lineno="614"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="615"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gathered_tokens<sp/>=<sp/>sorted_tokens.new_empty(</highlight></codeline>
<codeline lineno="616"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert_group.sum(dim=0).cpu().item(),<sp/>sorted_tokens.shape[1]</highlight></codeline>
<codeline lineno="617"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="618"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_split_sizes<sp/>=<sp/>tokens_per_ep_rank.cpu().numpy().tolist()</highlight></codeline>
<codeline lineno="619"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dist.all_to_all(</highlight></codeline>
<codeline lineno="620"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>list(gathered_tokens.split(output_splits)),</highlight></codeline>
<codeline lineno="621"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>list(sorted_tokens.split(input_split_sizes)),</highlight></codeline>
<codeline lineno="622"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="623"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert_post_gather<sp/>=<sp/>tokens_per_expert_group.view(</highlight></codeline>
<codeline lineno="624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref>,<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref></highlight></codeline>
<codeline lineno="625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>).sum(dim=0)</highlight></codeline>
<codeline lineno="626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gatherd_idxs<sp/>=<sp/>np.zeros(shape=(gathered_tokens.shape[0],),<sp/>dtype=np.int32)</highlight></codeline>
<codeline lineno="627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>s<sp/>=<sp/>0</highlight></codeline>
<codeline lineno="628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>i,<sp/>k<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>enumerate(tokens_per_expert_group.cpu().numpy()):</highlight></codeline>
<codeline lineno="629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gatherd_idxs[s<sp/>:<sp/>s<sp/>+<sp/>k]<sp/>=<sp/>i<sp/>%<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref></highlight></codeline>
<codeline lineno="630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>s<sp/>+=<sp/>k</highlight></codeline>
<codeline lineno="631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gatherd_idxs<sp/>=<sp/>gatherd_idxs.argsort()</highlight></codeline>
<codeline lineno="632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sorted_tokens<sp/>=<sp/>gathered_tokens[gatherd_idxs]</highlight></codeline>
<codeline lineno="633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert<sp/>=<sp/>tokens_per_expert_post_gather</highlight></codeline>
<codeline lineno="634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_per_expert<sp/>=<sp/>tokens_per_expert.cpu().numpy()</highlight></codeline>
<codeline lineno="635"><highlight class="normal"></highlight></codeline>
<codeline lineno="636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outputs<sp/>=<sp/>[]</highlight></codeline>
<codeline lineno="637"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_idx<sp/>=<sp/>0</highlight></codeline>
<codeline lineno="638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>i,<sp/>num_tokens<sp/></highlight><highlight class="keywordflow">in</highlight><highlight class="normal"><sp/>enumerate(tokens_per_expert):</highlight></codeline>
<codeline lineno="639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>end_idx<sp/>=<sp/>start_idx<sp/>+<sp/>num_tokens</highlight></codeline>
<codeline lineno="640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>num_tokens<sp/>==<sp/>0:</highlight></codeline>
<codeline lineno="641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>expert<sp/>=<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a4ae045a0a52bd60ae8a3ccd9874f02d7" kindref="member">experts</ref>[i<sp/>+<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ab252352f006c96f59a1966b33eb7fdc4" kindref="member">ep_rank</ref><sp/>*<sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1a430f75b10752a7984dce84e5387e8ee2" kindref="member">experts_per_rank</ref>]</highlight></codeline>
<codeline lineno="643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tokens_for_this_expert<sp/>=<sp/>sorted_tokens[start_idx:end_idx]</highlight></codeline>
<codeline lineno="644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>expert_out<sp/>=<sp/>expert(tokens_for_this_expert)</highlight></codeline>
<codeline lineno="645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outputs.append(expert_out)</highlight></codeline>
<codeline lineno="646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>start_idx<sp/>=<sp/>end_idx</highlight></codeline>
<codeline lineno="647"><highlight class="normal"></highlight></codeline>
<codeline lineno="648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outs<sp/>=<sp/>torch.cat(outputs,<sp/>dim=0)<sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>len(outputs)<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>sorted_tokens.new_empty(0)</highlight></codeline>
<codeline lineno="649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>self.<ref refid="classmodeling__deepseek_1_1DeepseekV3MoE_1ae9f212cf75c9114776e9ddf07c9ea7bd" kindref="member">ep_size</ref><sp/>&gt;<sp/>1:</highlight></codeline>
<codeline lineno="650"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_x<sp/>=<sp/>torch.empty_like(outs)</highlight></codeline>
<codeline lineno="651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_x[gatherd_idxs]<sp/>=<sp/>outs</highlight></codeline>
<codeline lineno="652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gathered_tokens<sp/>=<sp/>new_x.new_empty(*sorted_tokens_shape)</highlight></codeline>
<codeline lineno="653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dist.all_to_all(</highlight></codeline>
<codeline lineno="654"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>list(gathered_tokens.split(input_split_sizes)),</highlight></codeline>
<codeline lineno="655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>list(new_x.split(output_splits)),</highlight></codeline>
<codeline lineno="656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outs<sp/>=<sp/>gathered_tokens</highlight></codeline>
<codeline lineno="658"><highlight class="normal"></highlight></codeline>
<codeline lineno="659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_x<sp/>=<sp/>torch.empty_like(outs)</highlight></codeline>
<codeline lineno="660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_x[idxs]<sp/>=<sp/>outs</highlight></codeline>
<codeline lineno="661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>final_out<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>new_x.view(*topk_ids.shape,<sp/>-1)</highlight></codeline>
<codeline lineno="663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.type(topk_weight.dtype)</highlight></codeline>
<codeline lineno="664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.mul_(topk_weight.unsqueeze(dim=-1))</highlight></codeline>
<codeline lineno="665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.sum(dim=1)</highlight></codeline>
<codeline lineno="666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.type(new_x.dtype)</highlight></codeline>
<codeline lineno="667"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>final_out</highlight></codeline>
<codeline lineno="669"><highlight class="normal"></highlight></codeline>
<codeline lineno="670"><highlight class="normal"></highlight></codeline>
<codeline lineno="671"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.repeat_kv</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="672" refid="namespacemodeling__deepseek_1a5bf7ad188a9dfd9846300c6e3708cd1a" refkind="member"><highlight class="normal"></highlight><highlight class="keyword">def<sp/></highlight><highlight class="normal"><ref refid="namespacemodeling__deepseek_1a5bf7ad188a9dfd9846300c6e3708cd1a" kindref="member">repeat_kv</ref>(hidden_states:<sp/>torch.Tensor,<sp/>n_rep:<sp/>int)<sp/>-&gt;<sp/>torch.Tensor:</highlight></codeline>
<codeline lineno="673"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="674"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>This<sp/>is<sp/>the<sp/>equivalent<sp/>of<sp/>torch.repeat_interleave(x,<sp/>dim=1,<sp/>repeats=n_rep).<sp/>The<sp/>hidden<sp/>states<sp/>go<sp/>from<sp/>(batch,</highlight></codeline>
<codeline lineno="675"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>num_key_value_heads,<sp/>seqlen,<sp/>head_dim)<sp/>to<sp/>(batch,<sp/>num_attention_heads,<sp/>seqlen,<sp/>head_dim)</highlight></codeline>
<codeline lineno="676"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="677"><highlight class="normal"><sp/><sp/><sp/><sp/>batch,<sp/>num_key_value_heads,<sp/>slen,<sp/>head_dim<sp/>=<sp/>hidden_states.shape</highlight></codeline>
<codeline lineno="678"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>n_rep<sp/>==<sp/>1:</highlight></codeline>
<codeline lineno="679"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>hidden_states</highlight></codeline>
<codeline lineno="680"><highlight class="normal"><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>hidden_states[:,<sp/>:,<sp/></highlight><highlight class="keywordtype">None</highlight><highlight class="normal">,<sp/>:,<sp/>:].expand(</highlight></codeline>
<codeline lineno="681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch,<sp/>num_key_value_heads,<sp/>n_rep,<sp/>slen,<sp/>head_dim</highlight></codeline>
<codeline lineno="682"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="683"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>hidden_states.reshape(batch,<sp/>num_key_value_heads<sp/>*<sp/>n_rep,<sp/>slen,<sp/>head_dim)</highlight></codeline>
<codeline lineno="684"><highlight class="normal"></highlight></codeline>
<codeline lineno="685"><highlight class="normal"></highlight></codeline>
<codeline lineno="686"><highlight class="normal"></highlight><highlight class="comment">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.LlamaAttention<sp/>with<sp/>Llama-&gt;DeepseekV3</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="687" refid="classmodeling__deepseek_1_1DeepseekV3Attention" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classmodeling__deepseek_1_1DeepseekV3Attention" kindref="compound">DeepseekV3Attention</ref>(nn.Module):</highlight></codeline>
<codeline lineno="688"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;&quot;&quot;Multi-headed<sp/>attention<sp/>from<sp/>&apos;Attention<sp/>Is<sp/>All<sp/>You<sp/>Need&apos;<sp/>paper&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="689"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="690" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1af98a39d0d876f3b54ff08c7387056498" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>def<sp/>__init__(self,<sp/>config:<sp/>DeepseekV3Config,<sp/>layer_idx:<sp/>Optional[int]<sp/>=<sp/>None):</highlight></codeline>
<codeline lineno="691"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().__init__()</highlight></codeline>
<codeline lineno="692" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a1c8144674d02a5016d53ce346a834635" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.config<sp/>=<sp/>config</highlight></codeline>
<codeline lineno="693" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1acb98b03c694a7a30e512e64f162022c0" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.layer_idx<sp/>=<sp/>layer_idx</highlight></codeline>
<codeline lineno="694"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>layer_idx<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="695"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.warning_once(</highlight></codeline>
<codeline lineno="696"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;Instantiating<sp/>{self.__class__.__name__}<sp/>without<sp/>passing<sp/>`layer_idx`<sp/>is<sp/>not<sp/>recommended<sp/>and<sp/>will<sp/>&quot;</highlight></codeline>
<codeline lineno="697"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;to<sp/>errors<sp/>during<sp/>the<sp/>forward<sp/>call,<sp/>if<sp/>caching<sp/>is<sp/>used.<sp/>Please<sp/>make<sp/>sure<sp/>to<sp/>provide<sp/>a<sp/>`layer_idx`<sp/>&quot;</highlight></codeline>
<codeline lineno="698"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;when<sp/>creating<sp/>this<sp/>class.&quot;</highlight></codeline>
<codeline lineno="699"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="700"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="701" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a23c871a2bfab6ae4d668f5f11c377d11" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.attention_dropout<sp/>=<sp/>config.attention_dropout</highlight></codeline>
<codeline lineno="702" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a50654aa78257260bec49426d84d51fd2" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.hidden_size<sp/>=<sp/>config.hidden_size</highlight></codeline>
<codeline lineno="703" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a106f42b8983b3692f2bf53fb4ebfafec" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.num_heads<sp/>=<sp/>config.num_attention_heads</highlight></codeline>
<codeline lineno="704"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="705" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1abd28a02abd5cb87bccbe03f62c0a32ef" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.max_position_embeddings<sp/>=<sp/>config.max_position_embeddings</highlight></codeline>
<codeline lineno="706" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a7586cfe9b481f9eef2e366c5911335f9" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.rope_theta<sp/>=<sp/>config.rope_theta</highlight></codeline>
<codeline lineno="707" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a28efd11dc4520e5fc75f76b013526805" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_lora_rank<sp/>=<sp/>config.q_lora_rank</highlight></codeline>
<codeline lineno="708" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a38ac896a065b4b2eb72d06bd4f04e7bb" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.qk_rope_head_dim<sp/>=<sp/>config.qk_rope_head_dim</highlight></codeline>
<codeline lineno="709" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a539d7500b502ff50d7bbc38edd33a73b" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.kv_lora_rank<sp/>=<sp/>config.kv_lora_rank</highlight></codeline>
<codeline lineno="710" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1afad36c4bc568470c3e63315c27dbf842" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.v_head_dim<sp/>=<sp/>config.v_head_dim</highlight></codeline>
<codeline lineno="711" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1af16a31590d1f904d5c3d1ef5ecbd6425" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.qk_nope_head_dim<sp/>=<sp/>config.qk_nope_head_dim</highlight></codeline>
<codeline lineno="712" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a9021aec986b43147703e3f62f78da126" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_head_dim<sp/>=<sp/>config.qk_nope_head_dim<sp/>+<sp/>config.qk_rope_head_dim</highlight></codeline>
<codeline lineno="713"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="714" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1aa218d0a1c4085dfd2c671e9bc854c825" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.is_causal<sp/>=<sp/>True</highlight></codeline>
<codeline lineno="715"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="716"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.q_lora_rank<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="717" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1ac81d4a3c2486393475ff466c10d401df" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_proj<sp/>=<sp/>nn.Linear(</highlight></codeline>
<codeline lineno="718"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.hidden_size,<sp/>self.num_heads<sp/>*<sp/>self.q_head_dim,<sp/>bias=False</highlight></codeline>
<codeline lineno="719"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="720"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="721" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1ae4b3cd0ae7aaca036aa15b0cd108c761" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_a_proj<sp/>=<sp/>nn.Linear(</highlight></codeline>
<codeline lineno="722"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.hidden_size,<sp/>config.q_lora_rank,<sp/>bias=config.attention_bias</highlight></codeline>
<codeline lineno="723"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="724" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a37dc6c493e38448e95f12007fe3abd5e" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_a_layernorm<sp/>=<sp/>DeepseekV3RMSNorm(config.q_lora_rank)</highlight></codeline>
<codeline lineno="725" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1ab02ecb424285128723576b38da574438" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_b_proj<sp/>=<sp/>nn.Linear(</highlight></codeline>
<codeline lineno="726"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.q_lora_rank,<sp/>self.num_heads<sp/>*<sp/>self.q_head_dim,<sp/>bias=False</highlight></codeline>
<codeline lineno="727"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="728"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="729" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1aff10fd45c557e43af334db72bf01d4a0" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.kv_a_proj_with_mqa<sp/>=<sp/>nn.Linear(</highlight></codeline>
<codeline lineno="730"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.hidden_size,</highlight></codeline>
<codeline lineno="731"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.kv_lora_rank<sp/>+<sp/>config.qk_rope_head_dim,</highlight></codeline>
<codeline lineno="732"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bias=config.attention_bias,</highlight></codeline>
<codeline lineno="733"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="734" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a7b8fb461c7671364ae3abade34e0b41a" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.kv_a_layernorm<sp/>=<sp/>DeepseekV3RMSNorm(config.kv_lora_rank)</highlight></codeline>
<codeline lineno="735" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a71018a8b18e43fc3eb602feb40f6f27f" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.kv_b_proj<sp/>=<sp/>nn.Linear(</highlight></codeline>
<codeline lineno="736"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.kv_lora_rank,</highlight></codeline>
<codeline lineno="737"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.num_heads</highlight></codeline>
<codeline lineno="738"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>(self.q_head_dim<sp/>-<sp/>self.qk_rope_head_dim<sp/>+<sp/>self.v_head_dim),</highlight></codeline>
<codeline lineno="739"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bias=False,</highlight></codeline>
<codeline lineno="740"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="741"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="742" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a4ca46ab8a8834ac6f78efd4a8ba7e2fa" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.o_proj<sp/>=<sp/>nn.Linear(</highlight></codeline>
<codeline lineno="743"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.num_heads<sp/>*<sp/>self.v_head_dim,</highlight></codeline>
<codeline lineno="744"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.hidden_size,</highlight></codeline>
<codeline lineno="745"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bias=config.attention_bias,</highlight></codeline>
<codeline lineno="746"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="747"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self._init_rope()</highlight></codeline>
<codeline lineno="748"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="749" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a9c64003a9864d569a2a21ddf17ef125a" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.softmax_scale<sp/>=<sp/>self.q_head_dim<sp/>**<sp/>(-0.5)</highlight></codeline>
<codeline lineno="750"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.config.rope_scaling<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="751"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mscale_all_dim<sp/>=<sp/>self.config.rope_scaling.get(&quot;mscale_all_dim&quot;,<sp/>0)</highlight></codeline>
<codeline lineno="752"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor<sp/>=<sp/>self.config.rope_scaling[&quot;factor&quot;]</highlight></codeline>
<codeline lineno="753"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>mscale_all_dim:</highlight></codeline>
<codeline lineno="754"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mscale<sp/>=<sp/>yarn_get_mscale(scaling_factor,<sp/>mscale_all_dim)</highlight></codeline>
<codeline lineno="755"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.softmax_scale<sp/>=<sp/>self.softmax_scale<sp/>*<sp/>mscale<sp/>*<sp/>mscale</highlight></codeline>
<codeline lineno="756"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="757" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1af94174b8b0c46789f152137852a0772d" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>def<sp/>_init_rope(self):</highlight></codeline>
<codeline lineno="758"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.config.rope_scaling<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="759" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a1251ce70b3712e5e7daff0f9b44d7297" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.rotary_emb<sp/>=<sp/>DeepseekV3RotaryEmbedding(</highlight></codeline>
<codeline lineno="760"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.qk_rope_head_dim,</highlight></codeline>
<codeline lineno="761"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=self.max_position_embeddings,</highlight></codeline>
<codeline lineno="762"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=self.rope_theta,</highlight></codeline>
<codeline lineno="763"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="764"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="765"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_type<sp/>=<sp/>self.config.rope_scaling[&quot;type&quot;]</highlight></codeline>
<codeline lineno="766"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor<sp/>=<sp/>self.config.rope_scaling[&quot;factor&quot;]</highlight></codeline>
<codeline lineno="767"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>scaling_type<sp/>==<sp/>&quot;linear&quot;:</highlight></codeline>
<codeline lineno="768"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.rotary_emb<sp/>=<sp/>DeepseekV3LinearScalingRotaryEmbedding(</highlight></codeline>
<codeline lineno="769"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.qk_rope_head_dim,</highlight></codeline>
<codeline lineno="770"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=self.max_position_embeddings,</highlight></codeline>
<codeline lineno="771"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor=scaling_factor,</highlight></codeline>
<codeline lineno="772"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=self.rope_theta,</highlight></codeline>
<codeline lineno="773"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="774"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>scaling_type<sp/>==<sp/>&quot;dynamic&quot;:</highlight></codeline>
<codeline lineno="775"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.rotary_emb<sp/>=<sp/>DeepseekV3DynamicNTKScalingRotaryEmbedding(</highlight></codeline>
<codeline lineno="776"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.qk_rope_head_dim,</highlight></codeline>
<codeline lineno="777"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=self.max_position_embeddings,</highlight></codeline>
<codeline lineno="778"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor=scaling_factor,</highlight></codeline>
<codeline lineno="779"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=self.rope_theta,</highlight></codeline>
<codeline lineno="780"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="781"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>scaling_type<sp/>==<sp/>&quot;yarn&quot;:</highlight></codeline>
<codeline lineno="782"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kwargs<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="783"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key:<sp/>self.config.rope_scaling[key]</highlight></codeline>
<codeline lineno="784"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>key<sp/>in<sp/>[</highlight></codeline>
<codeline lineno="785"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;original_max_position_embeddings&quot;,</highlight></codeline>
<codeline lineno="786"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;beta_fast&quot;,</highlight></codeline>
<codeline lineno="787"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;beta_slow&quot;,</highlight></codeline>
<codeline lineno="788"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;mscale&quot;,</highlight></codeline>
<codeline lineno="789"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;mscale_all_dim&quot;,</highlight></codeline>
<codeline lineno="790"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]</highlight></codeline>
<codeline lineno="791"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>key<sp/>in<sp/>self.config.rope_scaling</highlight></codeline>
<codeline lineno="792"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="793"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.rotary_emb<sp/>=<sp/>DeepseekV3YarnRotaryEmbedding(</highlight></codeline>
<codeline lineno="794"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.qk_rope_head_dim,</highlight></codeline>
<codeline lineno="795"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_position_embeddings=self.max_position_embeddings,</highlight></codeline>
<codeline lineno="796"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>scaling_factor=scaling_factor,</highlight></codeline>
<codeline lineno="797"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>base=self.rope_theta,</highlight></codeline>
<codeline lineno="798"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="799"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="800"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="801"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(f&quot;Unknown<sp/>RoPE<sp/>scaling<sp/>type<sp/>{scaling_type}&quot;)</highlight></codeline>
<codeline lineno="802"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="803" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a0deae3082b58a29cbe17f5761ed7d3f8" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>def<sp/>_shape(self,<sp/>tensor:<sp/>torch.Tensor,<sp/>seq_len:<sp/>int,<sp/>bsz:<sp/>int):</highlight></codeline>
<codeline lineno="804"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>(</highlight></codeline>
<codeline lineno="805"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tensor.view(bsz,<sp/>seq_len,<sp/>self.num_heads,<sp/>self.v_head_dim)</highlight></codeline>
<codeline lineno="806"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="807"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.contiguous()</highlight></codeline>
<codeline lineno="808"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="809"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="810" refid="classmodeling__deepseek_1_1DeepseekV3Attention_1a1c0152e78a4d68499bc73ba94f63de6a" refkind="member"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>def<sp/>forward(</highlight></codeline>
<codeline lineno="811"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="812"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states:<sp/>torch.Tensor,</highlight></codeline>
<codeline lineno="813"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask:<sp/>Optional[torch.Tensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="814"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="815"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_value:<sp/>Optional[Cache]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="816"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions:<sp/>bool<sp/>=<sp/>False,</highlight></codeline>
<codeline lineno="817"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache:<sp/>bool<sp/>=<sp/>False,</highlight></codeline>
<codeline lineno="818"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="819"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Tuple[torch.Tensor,<sp/>Optional[torch.Tensor],<sp/>Optional[Tuple[torch.Tensor]]]:</highlight></codeline>
<codeline lineno="820"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>&quot;padding_mask&quot;<sp/>in<sp/>kwargs:</highlight></codeline>
<codeline lineno="821"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>warnings.warn(</highlight></codeline>
<codeline lineno="822"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;Passing<sp/>`padding_mask`<sp/>is<sp/>deprecated<sp/>and<sp/>will<sp/>be<sp/>removed<sp/>in<sp/>v4.37.<sp/>Please<sp/>make<sp/>sure<sp/>use<sp/>`attention_mask`<sp/>instead.`&quot;</highlight></codeline>
<codeline lineno="823"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="824"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bsz,<sp/>q_len,<sp/>_<sp/>=<sp/>hidden_states.size()</highlight></codeline>
<codeline lineno="825"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="826"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.q_lora_rank<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="827"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/>self.q_proj(hidden_states)</highlight></codeline>
<codeline lineno="828"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="829"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/>self.q_b_proj(self.q_a_layernorm(self.q_a_proj(hidden_states)))</highlight></codeline>
<codeline lineno="830"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/>q.view(bsz,<sp/>q_len,<sp/>self.num_heads,<sp/>self.q_head_dim).transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="831"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q_nope,<sp/>q_pe<sp/>=<sp/>torch.split(</highlight></codeline>
<codeline lineno="832"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q,<sp/>[self.qk_nope_head_dim,<sp/>self.qk_rope_head_dim],<sp/>dim=-1</highlight></codeline>
<codeline lineno="833"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="834"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="835"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>compressed_kv<sp/>=<sp/>self.kv_a_proj_with_mqa(hidden_states)</highlight></codeline>
<codeline lineno="836"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>compressed_kv,<sp/>k_pe<sp/>=<sp/>torch.split(</highlight></codeline>
<codeline lineno="837"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>compressed_kv,<sp/>[self.kv_lora_rank,<sp/>self.qk_rope_head_dim],<sp/>dim=-1</highlight></codeline>
<codeline lineno="838"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="839"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>k_pe<sp/>=<sp/>k_pe.view(bsz,<sp/>q_len,<sp/>1,<sp/>self.qk_rope_head_dim).transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="840"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="841"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.kv_b_proj(self.kv_a_layernorm(compressed_kv))</highlight></codeline>
<codeline lineno="842"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.view(bsz,<sp/>q_len,<sp/>self.num_heads,<sp/>self.qk_nope_head_dim<sp/>+<sp/>self.v_head_dim)</highlight></codeline>
<codeline lineno="843"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="844"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="845"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="846"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>k_nope,<sp/>value_states<sp/>=<sp/>torch.split(</highlight></codeline>
<codeline lineno="847"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv,<sp/>[self.qk_nope_head_dim,<sp/>self.v_head_dim],<sp/>dim=-1</highlight></codeline>
<codeline lineno="848"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="849"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv_seq_len<sp/>=<sp/>value_states.shape[-2]</highlight></codeline>
<codeline lineno="850"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>past_key_value<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="851"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.layer_idx<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="852"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(</highlight></codeline>
<codeline lineno="853"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;The<sp/>cache<sp/>structure<sp/>has<sp/>changed<sp/>since<sp/>version<sp/>v4.36.<sp/>If<sp/>you<sp/>are<sp/>using<sp/>{self.__class__.__name__}<sp/>&quot;</highlight></codeline>
<codeline lineno="854"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;for<sp/>auto-regressive<sp/>decoding<sp/>with<sp/>k/v<sp/>caching,<sp/>please<sp/>make<sp/>sure<sp/>to<sp/>initialize<sp/>the<sp/>attention<sp/>class<sp/>&quot;</highlight></codeline>
<codeline lineno="855"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;with<sp/>a<sp/>layer<sp/>index.&quot;</highlight></codeline>
<codeline lineno="856"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="857"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv_seq_len<sp/>+=<sp/>past_key_value.get_usable_length(kv_seq_len,<sp/>self.layer_idx)</highlight></codeline>
<codeline lineno="858"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cos,<sp/>sin<sp/>=<sp/>self.rotary_emb(value_states,<sp/>seq_len=kv_seq_len)</highlight></codeline>
<codeline lineno="859"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="860"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q_pe,<sp/>k_pe<sp/>=<sp/>apply_rotary_pos_emb(q_pe,<sp/>k_pe,<sp/>cos,<sp/>sin,<sp/>position_ids)</highlight></codeline>
<codeline lineno="861"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="862"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states<sp/>=<sp/>k_pe.new_empty(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>self.q_head_dim)</highlight></codeline>
<codeline lineno="863"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states[:,<sp/>:,<sp/>:,<sp/>:<sp/>self.qk_nope_head_dim]<sp/>=<sp/>q_nope</highlight></codeline>
<codeline lineno="864"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states[:,<sp/>:,<sp/>:,<sp/>self.qk_nope_head_dim<sp/>:]<sp/>=<sp/>q_pe</highlight></codeline>
<codeline lineno="865"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="866"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states<sp/>=<sp/>k_pe.new_empty(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>self.q_head_dim)</highlight></codeline>
<codeline lineno="867"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states[:,<sp/>:,<sp/>:,<sp/>:<sp/>self.qk_nope_head_dim]<sp/>=<sp/>k_nope</highlight></codeline>
<codeline lineno="868"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states[:,<sp/>:,<sp/>:,<sp/>self.qk_nope_head_dim<sp/>:]<sp/>=<sp/>k_pe</highlight></codeline>
<codeline lineno="869"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>past_key_value<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="870"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cache_kwargs<sp/>=<sp/>{&quot;sin&quot;:<sp/>sin,<sp/>&quot;cos&quot;:<sp/>cos}<sp/><sp/>#<sp/>Specific<sp/>to<sp/>RoPE<sp/>models</highlight></codeline>
<codeline lineno="871"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,<sp/>value_states<sp/>=<sp/>past_key_value.update(</highlight></codeline>
<codeline lineno="872"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,<sp/>value_states,<sp/>self.layer_idx,<sp/>cache_kwargs</highlight></codeline>
<codeline lineno="873"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="874"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="875"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="876"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.matmul(query_states,<sp/>key_states.transpose(2,<sp/>3))<sp/>*<sp/>self.softmax_scale</highlight></codeline>
<codeline lineno="877"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="878"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="879"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>attn_weights.size()<sp/>!=<sp/>(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>kv_seq_len):</highlight></codeline>
<codeline lineno="880"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(</highlight></codeline>
<codeline lineno="881"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;Attention<sp/>weights<sp/>should<sp/>be<sp/>of<sp/>size<sp/>{(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>kv_seq_len)},<sp/>but<sp/>is&quot;</highlight></codeline>
<codeline lineno="882"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;<sp/>{attn_weights.size()}&quot;</highlight></codeline>
<codeline lineno="883"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="884"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assert<sp/>attention_mask<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="885"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>attention_mask<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="886"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>attention_mask.size()<sp/>!=<sp/>(bsz,<sp/>1,<sp/>q_len,<sp/>kv_seq_len):</highlight></codeline>
<codeline lineno="887"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(</highlight></codeline>
<codeline lineno="888"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;Attention<sp/>mask<sp/>should<sp/>be<sp/>of<sp/>size<sp/>{(bsz,<sp/>1,<sp/>q_len,<sp/>kv_seq_len)},<sp/>but<sp/>is<sp/>{attention_mask.size()}&quot;</highlight></codeline>
<codeline lineno="889"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="890"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights<sp/>=<sp/>attn_weights<sp/>+<sp/>attention_mask</highlight></codeline>
<codeline lineno="891"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="892"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>upcast<sp/>attention<sp/>to<sp/>fp32</highlight></codeline>
<codeline lineno="893"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights<sp/>=<sp/>nn.functional.softmax(</highlight></codeline>
<codeline lineno="894"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights,<sp/>dim=-1,<sp/>dtype=torch.float32</highlight></codeline>
<codeline lineno="895"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>).to(query_states.dtype)</highlight></codeline>
<codeline lineno="896"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights<sp/>=<sp/>nn.functional.dropout(</highlight></codeline>
<codeline lineno="897"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights,<sp/>p=self.attention_dropout,<sp/>training=self.training</highlight></codeline>
<codeline lineno="898"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="899"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>torch.matmul(attn_weights,<sp/>value_states)</highlight></codeline>
<codeline lineno="900"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="901"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>attn_output.size()<sp/>!=<sp/>(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>self.v_head_dim):</highlight></codeline>
<codeline lineno="902"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(</highlight></codeline>
<codeline lineno="903"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;`attn_output`<sp/>should<sp/>be<sp/>of<sp/>size<sp/>{(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>self.v_head_dim)},<sp/>but<sp/>is&quot;</highlight></codeline>
<codeline lineno="904"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;<sp/>{attn_output.size()}&quot;</highlight></codeline>
<codeline lineno="905"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="906"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="907"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>attn_output.transpose(1,<sp/>2).contiguous()</highlight></codeline>
<codeline lineno="908"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="909"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>attn_output.reshape(bsz,<sp/>q_len,<sp/>self.num_heads<sp/>*<sp/>self.v_head_dim)</highlight></codeline>
<codeline lineno="910"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="911"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>self.o_proj(attn_output)</highlight></codeline>
<codeline lineno="912"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="913"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>output_attentions:</highlight></codeline>
<codeline lineno="914"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="915"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="916"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>attn_output,<sp/>attn_weights,<sp/>past_key_value</highlight></codeline>
<codeline lineno="917"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="918"><highlight class="stringliteral"></highlight></codeline>
<codeline lineno="919"><highlight class="stringliteral">#<sp/>Copied<sp/>from<sp/>transformers.models.llama.modeling_llama.LlamaFlashAttention2<sp/>with<sp/>Llama-&gt;DeepseekV3</highlight></codeline>
<codeline lineno="920" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2" refkind="compound"><highlight class="stringliteral">class<sp/>DeepseekV3FlashAttention2(DeepseekV3Attention):</highlight></codeline>
<codeline lineno="921"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="922"><highlight class="normal"><sp/><sp/><sp/><sp/>DeepseekV3<sp/>flash<sp/>attention<sp/>module.<sp/>This<sp/>module<sp/>inherits<sp/>from<sp/>`DeepseekV3Attention`<sp/>as<sp/>the<sp/>weights<sp/>of<sp/>the<sp/>module<sp/>stays</highlight></codeline>
<codeline lineno="923"><highlight class="normal"><sp/><sp/><sp/><sp/>untouched.<sp/>The<sp/>only<sp/>required<sp/>change<sp/>would<sp/>be<sp/>on<sp/>the<sp/>forward<sp/>pass<sp/>where<sp/>it<sp/>needs<sp/>to<sp/>correctly<sp/>call<sp/>the<sp/>public<sp/>API<sp/>of</highlight></codeline>
<codeline lineno="924"><highlight class="normal"><sp/><sp/><sp/><sp/>flash<sp/>attention<sp/>and<sp/>deal<sp/>with<sp/>padding<sp/>tokens<sp/>in<sp/>case<sp/>the<sp/>input<sp/>contains<sp/>any<sp/>of<sp/>them.</highlight></codeline>
<codeline lineno="925"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="926"><highlight class="normal"></highlight></codeline>
<codeline lineno="927" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a206c4a159e26bc17a1d26b653abf4a73" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>__init__(self,<sp/>*args,<sp/>**kwargs):</highlight></codeline>
<codeline lineno="928"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().__init__(*args,<sp/>**kwargs)</highlight></codeline>
<codeline lineno="929"><highlight class="normal"></highlight></codeline>
<codeline lineno="930"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>TODO:<sp/>Should<sp/>be<sp/>removed<sp/>once<sp/>Flash<sp/>Attention<sp/>for<sp/>RoCm<sp/>is<sp/>bumped<sp/>to<sp/>2.1.</highlight></codeline>
<codeline lineno="931"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>flash_attn&lt;2.1<sp/>generates<sp/>top-left<sp/>aligned<sp/>causal<sp/>mask,<sp/>while<sp/>what<sp/>is<sp/>needed<sp/>here<sp/>is<sp/>bottom-right<sp/>alignement,<sp/>that<sp/>was<sp/>made<sp/>default<sp/>for<sp/>flash_attn&gt;=2.1.<sp/>This<sp/>attribute<sp/>is<sp/>used<sp/>to<sp/>handle<sp/>this<sp/>difference.<sp/>Reference:<sp/>https://github.com/Dao-AILab/flash-attention/releases/tag/v2.1.0.</highlight></codeline>
<codeline lineno="932"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Beware<sp/>that<sp/>with<sp/>flash_attn&lt;2.1,<sp/>using<sp/>q_seqlen<sp/>!=<sp/>k_seqlen<sp/>(except<sp/>for<sp/>the<sp/>case<sp/>q_seqlen<sp/>==<sp/>1)<sp/>produces<sp/>a<sp/>wrong<sp/>mask<sp/>(top-left).</highlight></codeline>
<codeline lineno="933" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a38bd7b5da9b61cabffc696b79568cc35" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self._flash_attn_uses_top_left_mask<sp/>=<sp/>not<sp/>is_flash_attn_greater_or_equal_2_10()</highlight></codeline>
<codeline lineno="934"><highlight class="normal"></highlight></codeline>
<codeline lineno="935" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a2b99380feb66ac755ca513ced0472aea" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>forward(</highlight></codeline>
<codeline lineno="936"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="937"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states:<sp/>torch.Tensor,</highlight></codeline>
<codeline lineno="938"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="939"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="940"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_value:<sp/>Optional[Cache]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="941"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions:<sp/>bool<sp/>=<sp/>False,</highlight></codeline>
<codeline lineno="942"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache:<sp/>bool<sp/>=<sp/>False,</highlight></codeline>
<codeline lineno="943"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="944"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Tuple[torch.Tensor,<sp/>Optional[torch.Tensor],<sp/>Optional[Tuple[torch.Tensor]]]:</highlight></codeline>
<codeline lineno="945"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>DeepseekV3FlashAttention2<sp/>attention<sp/>does<sp/>not<sp/>support<sp/>output_attentions</highlight></codeline>
<codeline lineno="946"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>&quot;padding_mask&quot;<sp/>in<sp/>kwargs:</highlight></codeline>
<codeline lineno="947"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>warnings.warn(</highlight></codeline>
<codeline lineno="948"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;Passing<sp/>`padding_mask`<sp/>is<sp/>deprecated<sp/>and<sp/>will<sp/>be<sp/>removed<sp/>in<sp/>v4.37.<sp/>Please<sp/>make<sp/>sure<sp/>use<sp/>`attention_mask`<sp/>instead.`&quot;</highlight></codeline>
<codeline lineno="949"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="950"><highlight class="normal"></highlight></codeline>
<codeline lineno="951"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>overwrite<sp/>attention_mask<sp/>with<sp/>padding_mask</highlight></codeline>
<codeline lineno="952"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>=<sp/>kwargs.pop(&quot;padding_mask&quot;)</highlight></codeline>
<codeline lineno="953"><highlight class="normal"></highlight></codeline>
<codeline lineno="954"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions<sp/>=<sp/>False</highlight></codeline>
<codeline lineno="955"><highlight class="normal"></highlight></codeline>
<codeline lineno="956"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bsz,<sp/>q_len,<sp/>_<sp/>=<sp/>hidden_states.size()</highlight></codeline>
<codeline lineno="957"><highlight class="normal"></highlight></codeline>
<codeline lineno="958"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.q_lora_rank<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="959"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/>self.q_proj(hidden_states)</highlight></codeline>
<codeline lineno="960"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="961"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/>self.q_b_proj(self.q_a_layernorm(self.q_a_proj(hidden_states)))</highlight></codeline>
<codeline lineno="962"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q<sp/>=<sp/>q.view(bsz,<sp/>q_len,<sp/>self.num_heads,<sp/>self.q_head_dim).transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="963"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q_nope,<sp/>q_pe<sp/>=<sp/>torch.split(</highlight></codeline>
<codeline lineno="964" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a386d163029586f73f88fc97b29742ce9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q,<sp/>[self.qk_nope_head_dim,<sp/>self.qk_rope_head_dim],<sp/>dim=-1</highlight></codeline>
<codeline lineno="965"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="966"><highlight class="normal"></highlight></codeline>
<codeline lineno="967"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Flash<sp/>attention<sp/>requires<sp/>the<sp/>input<sp/>to<sp/>have<sp/>the<sp/>shape</highlight></codeline>
<codeline lineno="968"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>batch_size<sp/>x<sp/>seq_length<sp/>x<sp/>head_dim<sp/>x<sp/>hidden_dim</highlight></codeline>
<codeline lineno="969"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>therefore<sp/>we<sp/>just<sp/>need<sp/>to<sp/>keep<sp/>the<sp/>original<sp/>shape</highlight></codeline>
<codeline lineno="970"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>compressed_kv<sp/>=<sp/>self.kv_a_proj_with_mqa(hidden_states)</highlight></codeline>
<codeline lineno="971"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>compressed_kv,<sp/>k_pe<sp/>=<sp/>torch.split(</highlight></codeline>
<codeline lineno="972" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a6f0bd7faa6641c6cf187f3f19fb23ad1" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>compressed_kv,<sp/>[self.kv_lora_rank,<sp/>self.qk_rope_head_dim],<sp/>dim=-1</highlight></codeline>
<codeline lineno="973"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="974"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>k_pe<sp/>=<sp/>k_pe.view(bsz,<sp/>q_len,<sp/>1,<sp/>self.qk_rope_head_dim).transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="975"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="976"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.kv_b_proj(self.kv_a_layernorm(compressed_kv))</highlight></codeline>
<codeline lineno="977" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1aac3d7b7bbdfc37a526a6d4dd239a1b10" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.view(bsz,<sp/>q_len,<sp/>self.num_heads,<sp/>self.qk_nope_head_dim<sp/>+<sp/>self.v_head_dim)</highlight></codeline>
<codeline lineno="978"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="979"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="980"><highlight class="normal"></highlight></codeline>
<codeline lineno="981"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>k_nope,<sp/>value_states<sp/>=<sp/>torch.split(</highlight></codeline>
<codeline lineno="982"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv,<sp/>[self.qk_nope_head_dim,<sp/>self.v_head_dim],<sp/>dim=-1</highlight></codeline>
<codeline lineno="983"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="984"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv_seq_len<sp/>=<sp/>value_states.shape[-2]</highlight></codeline>
<codeline lineno="985"><highlight class="normal"></highlight></codeline>
<codeline lineno="986"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv_seq_len<sp/>=<sp/>value_states.shape[-2]</highlight></codeline>
<codeline lineno="987"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>past_key_value<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="988"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>kv_seq_len<sp/>+=<sp/>past_key_value.get_usable_length(kv_seq_len,<sp/>self.layer_idx)</highlight></codeline>
<codeline lineno="989"><highlight class="normal"></highlight></codeline>
<codeline lineno="990"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cos,<sp/>sin<sp/>=<sp/>self.rotary_emb(value_states,<sp/>seq_len=kv_seq_len)</highlight></codeline>
<codeline lineno="991"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q_pe,<sp/>k_pe<sp/>=<sp/>apply_rotary_pos_emb(q_pe,<sp/>k_pe,<sp/>cos,<sp/>sin,<sp/>position_ids)</highlight></codeline>
<codeline lineno="992"><highlight class="normal"></highlight></codeline>
<codeline lineno="993"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states<sp/>=<sp/>k_pe.new_empty(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>self.q_head_dim)</highlight></codeline>
<codeline lineno="994"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states[:,<sp/>:,<sp/>:,<sp/>:<sp/>self.qk_nope_head_dim]<sp/>=<sp/>q_nope</highlight></codeline>
<codeline lineno="995"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states[:,<sp/>:,<sp/>:,<sp/>self.qk_nope_head_dim<sp/>:]<sp/>=<sp/>q_pe</highlight></codeline>
<codeline lineno="996"><highlight class="normal"></highlight></codeline>
<codeline lineno="997"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states<sp/>=<sp/>k_pe.new_empty(bsz,<sp/>self.num_heads,<sp/>q_len,<sp/>self.q_head_dim)</highlight></codeline>
<codeline lineno="998"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states[:,<sp/>:,<sp/>:,<sp/>:<sp/>self.qk_nope_head_dim]<sp/>=<sp/>k_nope</highlight></codeline>
<codeline lineno="999"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states[:,<sp/>:,<sp/>:,<sp/>self.qk_nope_head_dim<sp/>:]<sp/>=<sp/>k_pe</highlight></codeline>
<codeline lineno="1000"><highlight class="normal"></highlight></codeline>
<codeline lineno="1001"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.q_head_dim<sp/>!=<sp/>self.v_head_dim:</highlight></codeline>
<codeline lineno="1002"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states<sp/>=<sp/>F.pad(value_states,<sp/>[0,<sp/>self.q_head_dim<sp/>-<sp/>self.v_head_dim])</highlight></codeline>
<codeline lineno="1003"><highlight class="normal"></highlight></codeline>
<codeline lineno="1004"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>past_key_value<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1005"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cache_kwargs<sp/>=<sp/>{&quot;sin&quot;:<sp/>sin,<sp/>&quot;cos&quot;:<sp/>cos}<sp/><sp/>#<sp/>Specific<sp/>to<sp/>RoPE<sp/>models</highlight></codeline>
<codeline lineno="1006"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,<sp/>value_states<sp/>=<sp/>past_key_value.update(</highlight></codeline>
<codeline lineno="1007" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a3e7d72c513cb9bf73f9c325206f797d8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,<sp/>value_states,<sp/>self.layer_idx,<sp/>cache_kwargs</highlight></codeline>
<codeline lineno="1008"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1009"><highlight class="normal"></highlight></codeline>
<codeline lineno="1010"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>TODO:<sp/>These<sp/>transpose<sp/>are<sp/>quite<sp/>inefficient<sp/>but<sp/>Flash<sp/>Attention<sp/>requires<sp/>the<sp/>layout<sp/>[batch_size,<sp/>sequence_length,<sp/>num_heads,<sp/>head_dim].<sp/>We<sp/>would<sp/>need<sp/>to<sp/>refactor<sp/>the<sp/>KV<sp/>cache</highlight></codeline>
<codeline lineno="1011"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>to<sp/>be<sp/>able<sp/>to<sp/>avoid<sp/>many<sp/>of<sp/>these<sp/>transpose/reshape/view.</highlight></codeline>
<codeline lineno="1012"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states<sp/>=<sp/>query_states.transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="1013"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states<sp/>=<sp/>key_states.transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="1014"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states<sp/>=<sp/>value_states.transpose(1,<sp/>2)</highlight></codeline>
<codeline lineno="1015"><highlight class="normal"></highlight></codeline>
<codeline lineno="1016"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dropout_rate<sp/>=<sp/>self.attention_dropout<sp/>if<sp/>self.training<sp/>else<sp/>0.0</highlight></codeline>
<codeline lineno="1017"><highlight class="normal"></highlight></codeline>
<codeline lineno="1018"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>In<sp/>PEFT,<sp/>usually<sp/>we<sp/>cast<sp/>the<sp/>layer<sp/>norms<sp/>in<sp/>float32<sp/>for<sp/>training<sp/>stability<sp/>reasons</highlight></codeline>
<codeline lineno="1019"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>therefore<sp/>the<sp/>input<sp/>hidden<sp/>states<sp/>gets<sp/>silently<sp/>casted<sp/>in<sp/>float32.<sp/>Hence,<sp/>we<sp/>need</highlight></codeline>
<codeline lineno="1020"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>cast<sp/>them<sp/>back<sp/>in<sp/>the<sp/>correct<sp/>dtype<sp/>just<sp/>to<sp/>be<sp/>sure<sp/>everything<sp/>works<sp/>as<sp/>expected.</highlight></codeline>
<codeline lineno="1021"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>This<sp/>might<sp/>slowdown<sp/>training<sp/>&amp;<sp/>inference<sp/>so<sp/>it<sp/>is<sp/>recommended<sp/>to<sp/>not<sp/>cast<sp/>the<sp/>LayerNorms</highlight></codeline>
<codeline lineno="1022"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>in<sp/>fp32.<sp/>(DeepseekV3RMSNorm<sp/>handles<sp/>it<sp/>correctly)</highlight></codeline>
<codeline lineno="1023"><highlight class="normal"></highlight></codeline>
<codeline lineno="1024"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_dtype<sp/>=<sp/>query_states.dtype</highlight></codeline>
<codeline lineno="1025"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>input_dtype<sp/>==<sp/>torch.float32:</highlight></codeline>
<codeline lineno="1026"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Handle<sp/>the<sp/>case<sp/>where<sp/>the<sp/>model<sp/>is<sp/>quantized</highlight></codeline>
<codeline lineno="1027" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1abaca9a82eff189a07de13ace872c840f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>hasattr(self.config,<sp/>&quot;_pre_quantization_dtype&quot;):</highlight></codeline>
<codeline lineno="1028"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target_dtype<sp/>=<sp/>self.config._pre_quantization_dtype</highlight></codeline>
<codeline lineno="1029"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>torch.is_autocast_enabled():</highlight></codeline>
<codeline lineno="1030"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target_dtype<sp/>=<sp/>torch.get_autocast_gpu_dtype()</highlight></codeline>
<codeline lineno="1031"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1032"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>target_dtype<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1033"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.q_proj.weight.dtype</highlight></codeline>
<codeline lineno="1034"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.q_lora_rank<sp/>is<sp/>None</highlight></codeline>
<codeline lineno="1035"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>self.q_a_proj.weight.dtype</highlight></codeline>
<codeline lineno="1036"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1037"><highlight class="normal"></highlight></codeline>
<codeline lineno="1038"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logger.warning_once(</highlight></codeline>
<codeline lineno="1039"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;The<sp/>input<sp/>hidden<sp/>states<sp/>seems<sp/>to<sp/>be<sp/>silently<sp/>casted<sp/>in<sp/>float32,<sp/>this<sp/>might<sp/>be<sp/>related<sp/>to&quot;</highlight></codeline>
<codeline lineno="1040"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;<sp/>the<sp/>fact<sp/>you<sp/>have<sp/>upcasted<sp/>embedding<sp/>or<sp/>layer<sp/>norm<sp/>layers<sp/>in<sp/>float32.<sp/>We<sp/>will<sp/>cast<sp/>back<sp/>the<sp/>input<sp/>in&quot;</highlight></codeline>
<codeline lineno="1041"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>f&quot;<sp/>{target_dtype}.&quot;</highlight></codeline>
<codeline lineno="1042"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1043"><highlight class="normal"></highlight></codeline>
<codeline lineno="1044"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states<sp/>=<sp/>query_states.to(target_dtype)</highlight></codeline>
<codeline lineno="1045"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states<sp/>=<sp/>key_states.to(target_dtype)</highlight></codeline>
<codeline lineno="1046"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states<sp/>=<sp/>value_states.to(target_dtype)</highlight></codeline>
<codeline lineno="1047"><highlight class="normal"></highlight></codeline>
<codeline lineno="1048"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>self._flash_attention_forward(</highlight></codeline>
<codeline lineno="1049"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states,</highlight></codeline>
<codeline lineno="1050"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,</highlight></codeline>
<codeline lineno="1051"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states,</highlight></codeline>
<codeline lineno="1052"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask,</highlight></codeline>
<codeline lineno="1053"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>q_len,</highlight></codeline>
<codeline lineno="1054"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dropout=dropout_rate,</highlight></codeline>
<codeline lineno="1055"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>softmax_scale=self.softmax_scale,</highlight></codeline>
<codeline lineno="1056"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1057"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.q_head_dim<sp/>!=<sp/>self.v_head_dim:</highlight></codeline>
<codeline lineno="1058"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>attn_output[:,<sp/>:,<sp/>:,<sp/>:<sp/>self.v_head_dim]</highlight></codeline>
<codeline lineno="1059"><highlight class="normal"></highlight></codeline>
<codeline lineno="1060"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>attn_output.reshape(</highlight></codeline>
<codeline lineno="1061"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>bsz,<sp/>q_len,<sp/>self.num_heads<sp/>*<sp/>self.v_head_dim</highlight></codeline>
<codeline lineno="1062"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>).contiguous()</highlight></codeline>
<codeline lineno="1063"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>self.o_proj(attn_output)</highlight></codeline>
<codeline lineno="1064"><highlight class="normal"></highlight></codeline>
<codeline lineno="1065"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>output_attentions:</highlight></codeline>
<codeline lineno="1066"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_weights<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="1067"><highlight class="normal"></highlight></codeline>
<codeline lineno="1068"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>attn_output,<sp/>attn_weights,<sp/>past_key_value</highlight></codeline>
<codeline lineno="1069"><highlight class="normal"></highlight></codeline>
<codeline lineno="1070" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1a6fff8930135ac4423b89be7762c7b384" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>_flash_attention_forward(</highlight></codeline>
<codeline lineno="1071"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1072"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states,</highlight></codeline>
<codeline lineno="1073"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,</highlight></codeline>
<codeline lineno="1074"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states,</highlight></codeline>
<codeline lineno="1075"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask,</highlight></codeline>
<codeline lineno="1076"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_length,</highlight></codeline>
<codeline lineno="1077"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dropout=0.0,</highlight></codeline>
<codeline lineno="1078"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>softmax_scale=None,</highlight></codeline>
<codeline lineno="1079"><highlight class="normal"><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1080"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1081"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Calls<sp/>the<sp/>forward<sp/>method<sp/>of<sp/>Flash<sp/>Attention<sp/>-<sp/>if<sp/>the<sp/>input<sp/>hidden<sp/>states<sp/>contain<sp/>at<sp/>least<sp/>one<sp/>padding<sp/>token</highlight></codeline>
<codeline lineno="1082"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>first<sp/>unpad<sp/>the<sp/>input,<sp/>then<sp/>computes<sp/>the<sp/>attention<sp/>scores<sp/>and<sp/>pad<sp/>the<sp/>final<sp/>attention<sp/>scores.</highlight></codeline>
<codeline lineno="1083"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Args:</highlight></codeline>
<codeline lineno="1084"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states<sp/>(`torch.Tensor`):</highlight></codeline>
<codeline lineno="1085"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Input<sp/>query<sp/>states<sp/>to<sp/>be<sp/>passed<sp/>to<sp/>Flash<sp/>Attention<sp/>API</highlight></codeline>
<codeline lineno="1086"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states<sp/>(`torch.Tensor`):</highlight></codeline>
<codeline lineno="1087"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Input<sp/>key<sp/>states<sp/>to<sp/>be<sp/>passed<sp/>to<sp/>Flash<sp/>Attention<sp/>API</highlight></codeline>
<codeline lineno="1088"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states<sp/>(`torch.Tensor`):</highlight></codeline>
<codeline lineno="1089"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Input<sp/>value<sp/>states<sp/>to<sp/>be<sp/>passed<sp/>to<sp/>Flash<sp/>Attention<sp/>API</highlight></codeline>
<codeline lineno="1090"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>(`torch.Tensor`):</highlight></codeline>
<codeline lineno="1091"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>The<sp/>padding<sp/>mask<sp/>-<sp/>corresponds<sp/>to<sp/>a<sp/>tensor<sp/>of<sp/>size<sp/>`(batch_size,<sp/>seq_len)`<sp/>where<sp/>0<sp/>stands<sp/>for<sp/>the</highlight></codeline>
<codeline lineno="1092"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position<sp/>of<sp/>padding<sp/>tokens<sp/>and<sp/>1<sp/>for<sp/>the<sp/>position<sp/>of<sp/>non-padding<sp/>tokens.</highlight></codeline>
<codeline lineno="1093"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dropout<sp/>(`int`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1094"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Attention<sp/>dropout</highlight></codeline>
<codeline lineno="1095"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>softmax_scale<sp/>(`float`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1096"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>The<sp/>scaling<sp/>of<sp/>QK^T<sp/>before<sp/>applying<sp/>softmax.<sp/>Default<sp/>to<sp/>1<sp/>/<sp/>sqrt(head_dim)</highlight></codeline>
<codeline lineno="1097"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1098"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>self._flash_attn_uses_top_left_mask:</highlight></codeline>
<codeline lineno="1099"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>causal<sp/>=<sp/>self.is_causal</highlight></codeline>
<codeline lineno="1100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>TODO:<sp/>Remove<sp/>the<sp/>`query_length<sp/>!=<sp/>1`<sp/>check<sp/>once<sp/>Flash<sp/>Attention<sp/>for<sp/>RoCm<sp/>is<sp/>bumped<sp/>to<sp/>2.1.<sp/>For<sp/>details,<sp/>please<sp/>see<sp/>the<sp/>comment<sp/>in<sp/>DeepseekV3FlashAttention2<sp/>__init__.</highlight></codeline>
<codeline lineno="1102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>causal<sp/>=<sp/>self.is_causal<sp/>and<sp/>query_length<sp/>!=<sp/>1</highlight></codeline>
<codeline lineno="1103"><highlight class="normal"></highlight></codeline>
<codeline lineno="1104"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Contains<sp/>at<sp/>least<sp/>one<sp/>padding<sp/>token<sp/>in<sp/>the<sp/>sequence</highlight></codeline>
<codeline lineno="1105"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>attention_mask<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size<sp/>=<sp/>query_states.shape[0]</highlight></codeline>
<codeline lineno="1107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(</highlight></codeline>
<codeline lineno="1108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states,</highlight></codeline>
<codeline lineno="1109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,</highlight></codeline>
<codeline lineno="1110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states,</highlight></codeline>
<codeline lineno="1111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_q,</highlight></codeline>
<codeline lineno="1112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seq_lens,</highlight></codeline>
<codeline lineno="1113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seq_lens,</highlight></codeline>
<codeline lineno="1114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/>=<sp/>self._upad_input(</highlight></codeline>
<codeline lineno="1115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states,<sp/>key_states,<sp/>value_states,<sp/>attention_mask,<sp/>query_length</highlight></codeline>
<codeline lineno="1116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1117"><highlight class="normal"></highlight></codeline>
<codeline lineno="1118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seqlens_q,<sp/>cu_seqlens_k<sp/>=<sp/>cu_seq_lens</highlight></codeline>
<codeline lineno="1119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seqlen_in_batch_q,<sp/>max_seqlen_in_batch_k<sp/>=<sp/>max_seq_lens</highlight></codeline>
<codeline lineno="1120"><highlight class="normal"></highlight></codeline>
<codeline lineno="1121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output_unpad<sp/>=<sp/>flash_attn_varlen_func(</highlight></codeline>
<codeline lineno="1122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states,</highlight></codeline>
<codeline lineno="1123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,</highlight></codeline>
<codeline lineno="1124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states,</highlight></codeline>
<codeline lineno="1125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seqlens_q=cu_seqlens_q,</highlight></codeline>
<codeline lineno="1126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seqlens_k=cu_seqlens_k,</highlight></codeline>
<codeline lineno="1127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seqlen_q=max_seqlen_in_batch_q,</highlight></codeline>
<codeline lineno="1128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seqlen_k=max_seqlen_in_batch_k,</highlight></codeline>
<codeline lineno="1129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dropout_p=dropout,</highlight></codeline>
<codeline lineno="1130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>softmax_scale=softmax_scale,</highlight></codeline>
<codeline lineno="1131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>causal=causal,</highlight></codeline>
<codeline lineno="1132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1133"><highlight class="normal"></highlight></codeline>
<codeline lineno="1134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>pad_input(</highlight></codeline>
<codeline lineno="1135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output_unpad,<sp/>indices_q,<sp/>batch_size,<sp/>query_length</highlight></codeline>
<codeline lineno="1136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attn_output<sp/>=<sp/>flash_attn_func(</highlight></codeline>
<codeline lineno="1139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_states,</highlight></codeline>
<codeline lineno="1140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_states,</highlight></codeline>
<codeline lineno="1141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_states,</highlight></codeline>
<codeline lineno="1142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dropout,</highlight></codeline>
<codeline lineno="1143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>softmax_scale=softmax_scale,</highlight></codeline>
<codeline lineno="1144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>causal=causal,</highlight></codeline>
<codeline lineno="1145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1146"><highlight class="normal"></highlight></codeline>
<codeline lineno="1147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>attn_output</highlight></codeline>
<codeline lineno="1148"><highlight class="normal"></highlight></codeline>
<codeline lineno="1149" refid="classmodeling__deepseek_1_1DeepseekV3FlashAttention2_1af35949d3bd3ad87dac8be0cebda1f1dd" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>_upad_input(</highlight></codeline>
<codeline lineno="1150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,<sp/>query_layer,<sp/>key_layer,<sp/>value_layer,<sp/>attention_mask,<sp/>query_length</highlight></codeline>
<codeline lineno="1151"><highlight class="normal"><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_k,<sp/>cu_seqlens_k,<sp/>max_seqlen_in_batch_k<sp/>=<sp/>_get_unpad_data(attention_mask)</highlight></codeline>
<codeline lineno="1153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size,<sp/>kv_seq_len,<sp/>num_key_value_heads,<sp/>head_dim<sp/>=<sp/>key_layer.shape</highlight></codeline>
<codeline lineno="1154"><highlight class="normal"></highlight></codeline>
<codeline lineno="1155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_layer<sp/>=<sp/>index_first_axis(</highlight></codeline>
<codeline lineno="1156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_layer.reshape(batch_size<sp/>*<sp/>kv_seq_len,<sp/>num_key_value_heads,<sp/>head_dim),</highlight></codeline>
<codeline lineno="1157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_k,</highlight></codeline>
<codeline lineno="1158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_layer<sp/>=<sp/>index_first_axis(</highlight></codeline>
<codeline lineno="1160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_layer.reshape(batch_size<sp/>*<sp/>kv_seq_len,<sp/>num_key_value_heads,<sp/>head_dim),</highlight></codeline>
<codeline lineno="1161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_k,</highlight></codeline>
<codeline lineno="1162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>query_length<sp/>==<sp/>kv_seq_len:</highlight></codeline>
<codeline lineno="1164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_layer<sp/>=<sp/>index_first_axis(</highlight></codeline>
<codeline lineno="1165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_layer.reshape(batch_size<sp/>*<sp/>kv_seq_len,<sp/>self.num_heads,<sp/>head_dim),</highlight></codeline>
<codeline lineno="1166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_k,</highlight></codeline>
<codeline lineno="1167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seqlens_q<sp/>=<sp/>cu_seqlens_k</highlight></codeline>
<codeline lineno="1169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seqlen_in_batch_q<sp/>=<sp/>max_seqlen_in_batch_k</highlight></codeline>
<codeline lineno="1170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_q<sp/>=<sp/>indices_k</highlight></codeline>
<codeline lineno="1171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>query_length<sp/>==<sp/>1:</highlight></codeline>
<codeline lineno="1172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_seqlen_in_batch_q<sp/>=<sp/>1</highlight></codeline>
<codeline lineno="1173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cu_seqlens_q<sp/>=<sp/>torch.arange(</highlight></codeline>
<codeline lineno="1174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size<sp/>+<sp/>1,<sp/>dtype=torch.int32,<sp/>device=query_layer.device</highlight></codeline>
<codeline lineno="1175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)<sp/><sp/>#<sp/>There<sp/>is<sp/>a<sp/>memcpy<sp/>here,<sp/>that<sp/>is<sp/>very<sp/>bad.</highlight></codeline>
<codeline lineno="1176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_q<sp/>=<sp/>cu_seqlens_q[:-1]</highlight></codeline>
<codeline lineno="1177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_layer<sp/>=<sp/>query_layer.squeeze(1)</highlight></codeline>
<codeline lineno="1178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>The<sp/>-q_len:<sp/>slice<sp/>assumes<sp/>left<sp/>padding.</highlight></codeline>
<codeline lineno="1180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>=<sp/>attention_mask[:,<sp/>-query_length:]</highlight></codeline>
<codeline lineno="1181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_layer,<sp/>indices_q,<sp/>cu_seqlens_q,<sp/>max_seqlen_in_batch_q<sp/>=<sp/>unpad_input(</highlight></codeline>
<codeline lineno="1182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_layer,<sp/>attention_mask</highlight></codeline>
<codeline lineno="1183"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1184"><highlight class="normal"></highlight></codeline>
<codeline lineno="1185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>(</highlight></codeline>
<codeline lineno="1186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_layer,</highlight></codeline>
<codeline lineno="1187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>key_layer,</highlight></codeline>
<codeline lineno="1188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>value_layer,</highlight></codeline>
<codeline lineno="1189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>indices_q,</highlight></codeline>
<codeline lineno="1190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(cu_seqlens_q,<sp/>cu_seqlens_k),</highlight></codeline>
<codeline lineno="1191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(max_seqlen_in_batch_q,<sp/>max_seqlen_in_batch_k),</highlight></codeline>
<codeline lineno="1192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1193"><highlight class="normal"></highlight></codeline>
<codeline lineno="1194"><highlight class="normal"></highlight></codeline>
<codeline lineno="1195" refid="namespacemodeling__deepseek_1ab4fe0f13f22eb77598df89bc23c86276" refkind="member"><highlight class="normal">ATTENTION_CLASSES<sp/>=<sp/>{</highlight></codeline>
<codeline lineno="1196"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;eager&quot;:<sp/>DeepseekV3Attention,</highlight></codeline>
<codeline lineno="1197"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;flash_attention_2&quot;:<sp/>DeepseekV3FlashAttention2,</highlight></codeline>
<codeline lineno="1198"><highlight class="normal">}</highlight></codeline>
<codeline lineno="1199"><highlight class="normal"></highlight></codeline>
<codeline lineno="1200"><highlight class="normal"></highlight></codeline>
<codeline lineno="1201" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer" refkind="compound"><highlight class="normal">class<sp/>DeepseekV3DecoderLayer(nn.Module):</highlight></codeline>
<codeline lineno="1202" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1a4065b3e08dbfb6e735546322339d9134" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>__init__(self,<sp/>config:<sp/>DeepseekV3Config,<sp/>layer_idx:<sp/>int):</highlight></codeline>
<codeline lineno="1203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().__init__()</highlight></codeline>
<codeline lineno="1204" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1aafb921ae2f0eb627a0fadaa574547b59" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.hidden_size<sp/>=<sp/>config.hidden_size</highlight></codeline>
<codeline lineno="1205"><highlight class="normal"></highlight></codeline>
<codeline lineno="1206" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1af4a351d35571620416cd9097bac15779" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.self_attn<sp/>=<sp/>ATTENTION_CLASSES[config._attn_implementation](</highlight></codeline>
<codeline lineno="1207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config=config,<sp/>layer_idx=layer_idx</highlight></codeline>
<codeline lineno="1208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1209"><highlight class="normal"></highlight></codeline>
<codeline lineno="1210" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1ac8f6b1665d09c12e725df870f2d294c3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.mlp<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DeepseekV3MoE(config)</highlight></codeline>
<codeline lineno="1212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(</highlight></codeline>
<codeline lineno="1213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.n_routed_experts<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>and<sp/>layer_idx<sp/>&gt;=<sp/>config.first_k_dense_replace</highlight></codeline>
<codeline lineno="1215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>and<sp/>layer_idx<sp/>%<sp/>config.moe_layer_freq<sp/>==<sp/>0</highlight></codeline>
<codeline lineno="1216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>DeepseekV3MLP(config)</highlight></codeline>
<codeline lineno="1218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1219" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1a09e3b71724ac8f1936cffd262396fa3f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.input_layernorm<sp/>=<sp/>DeepseekV3RMSNorm(</highlight></codeline>
<codeline lineno="1220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.hidden_size,<sp/>eps=config.rms_norm_eps</highlight></codeline>
<codeline lineno="1221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1222" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1a1b637af6c56f95970da448336bb826d7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.post_attention_layernorm<sp/>=<sp/>DeepseekV3RMSNorm(</highlight></codeline>
<codeline lineno="1223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.hidden_size,<sp/>eps=config.rms_norm_eps</highlight></codeline>
<codeline lineno="1224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1225"><highlight class="normal"></highlight></codeline>
<codeline lineno="1226" refid="classmodeling__deepseek_1_1DeepseekV3DecoderLayer_1ac380b4dd3b1abc3371cb2654a4e11071" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>forward(</highlight></codeline>
<codeline lineno="1227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states:<sp/>torch.Tensor,</highlight></codeline>
<codeline lineno="1229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask:<sp/>Optional[torch.Tensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_value:<sp/>Optional[Tuple[torch.Tensor]]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions:<sp/>Optional[bool]<sp/>=<sp/>False,</highlight></codeline>
<codeline lineno="1233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache:<sp/>Optional[bool]<sp/>=<sp/>False,</highlight></codeline>
<codeline lineno="1234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="1235"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Tuple[</highlight></codeline>
<codeline lineno="1236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.FloatTensor,<sp/>Optional[Tuple[torch.FloatTensor,<sp/>torch.FloatTensor]]</highlight></codeline>
<codeline lineno="1237"><highlight class="normal"><sp/><sp/><sp/><sp/>]:</highlight></codeline>
<codeline lineno="1238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Args:</highlight></codeline>
<codeline lineno="1240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>(`torch.FloatTensor`):<sp/>input<sp/>to<sp/>the<sp/>layer<sp/>of<sp/>shape<sp/>`(batch,<sp/>seq_len,<sp/>embed_dim)`</highlight></codeline>
<codeline lineno="1241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>(`torch.FloatTensor`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention<sp/>mask<sp/>of<sp/>size<sp/>`(batch_size,<sp/>sequence_length)`<sp/>if<sp/>flash<sp/>attention<sp/>is<sp/>used<sp/>or<sp/>`(batch_size,<sp/>1,</highlight></codeline>
<codeline lineno="1243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>query_sequence_length,<sp/>key_sequence_length)`<sp/>if<sp/>default<sp/>attention<sp/>is<sp/>used.</highlight></codeline>
<codeline lineno="1244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions<sp/>(`bool`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1245"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Whether<sp/>or<sp/>not<sp/>to<sp/>return<sp/>the<sp/>attentions<sp/>tensors<sp/>of<sp/>all<sp/>attention<sp/>layers.<sp/>See<sp/>`attentions`<sp/>under</highlight></codeline>
<codeline lineno="1246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>returned<sp/>tensors<sp/>for<sp/>more<sp/>detail.</highlight></codeline>
<codeline lineno="1247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache<sp/>(`bool`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>set<sp/>to<sp/>`True`,<sp/>`past_key_values`<sp/>key<sp/>value<sp/>states<sp/>are<sp/>returned<sp/>and<sp/>can<sp/>be<sp/>used<sp/>to<sp/>speed<sp/>up<sp/>decoding</highlight></codeline>
<codeline lineno="1249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(see<sp/>`past_key_values`).</highlight></codeline>
<codeline lineno="1250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_value<sp/>(`Tuple(torch.FloatTensor)`,<sp/>*optional*):<sp/>cached<sp/>past<sp/>key<sp/>and<sp/>value<sp/>projection<sp/>states</highlight></codeline>
<codeline lineno="1251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>&quot;padding_mask&quot;<sp/>in<sp/>kwargs:</highlight></codeline>
<codeline lineno="1253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>warnings.warn(</highlight></codeline>
<codeline lineno="1254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;Passing<sp/>`padding_mask`<sp/>is<sp/>deprecated<sp/>and<sp/>will<sp/>be<sp/>removed<sp/>in<sp/>v4.37.<sp/>Please<sp/>make<sp/>sure<sp/>use<sp/>`attention_mask`<sp/>instead.`&quot;</highlight></codeline>
<codeline lineno="1255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>residual<sp/>=<sp/>hidden_states</highlight></codeline>
<codeline lineno="1257"><highlight class="normal"></highlight></codeline>
<codeline lineno="1258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>self.input_layernorm(hidden_states)</highlight></codeline>
<codeline lineno="1259"><highlight class="normal"></highlight></codeline>
<codeline lineno="1260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Self<sp/>Attention</highlight></codeline>
<codeline lineno="1261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states,<sp/>self_attn_weights,<sp/>present_key_value<sp/>=<sp/>self.self_attn(</highlight></codeline>
<codeline lineno="1262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states=hidden_states,</highlight></codeline>
<codeline lineno="1263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask=attention_mask,</highlight></codeline>
<codeline lineno="1264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids=position_ids,</highlight></codeline>
<codeline lineno="1265"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_value=past_key_value,</highlight></codeline>
<codeline lineno="1266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions=output_attentions,</highlight></codeline>
<codeline lineno="1267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache=use_cache,</highlight></codeline>
<codeline lineno="1268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="1269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>residual<sp/>+<sp/>hidden_states</highlight></codeline>
<codeline lineno="1271"><highlight class="normal"></highlight></codeline>
<codeline lineno="1272"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Fully<sp/>Connected</highlight></codeline>
<codeline lineno="1273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>residual<sp/>=<sp/>hidden_states</highlight></codeline>
<codeline lineno="1274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>self.post_attention_layernorm(hidden_states)</highlight></codeline>
<codeline lineno="1275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>self.mlp(hidden_states)</highlight></codeline>
<codeline lineno="1276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>residual<sp/>+<sp/>hidden_states</highlight></codeline>
<codeline lineno="1277"><highlight class="normal"></highlight></codeline>
<codeline lineno="1278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outputs<sp/>=<sp/>(hidden_states,)</highlight></codeline>
<codeline lineno="1279"><highlight class="normal"></highlight></codeline>
<codeline lineno="1280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_attentions:</highlight></codeline>
<codeline lineno="1281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outputs<sp/>+=<sp/>(self_attn_weights,)</highlight></codeline>
<codeline lineno="1282"><highlight class="normal"></highlight></codeline>
<codeline lineno="1283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>use_cache:</highlight></codeline>
<codeline lineno="1284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outputs<sp/>+=<sp/>(present_key_value,)</highlight></codeline>
<codeline lineno="1285"><highlight class="normal"></highlight></codeline>
<codeline lineno="1286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>outputs</highlight></codeline>
<codeline lineno="1287"><highlight class="normal"></highlight></codeline>
<codeline lineno="1288"><highlight class="normal"></highlight></codeline>
<codeline lineno="1289" refid="namespacemodeling__deepseek_1ac35047c78f8be4b60c37f16178f47dbc" refkind="member"><highlight class="normal">DeepseekV3_START_DOCSTRING<sp/>=<sp/></highlight><highlight class="stringliteral">r&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1290"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>This<sp/>model<sp/>inherits<sp/>from<sp/>[`PreTrainedModel`].<sp/>Check<sp/>the<sp/>superclass<sp/>documentation<sp/>for<sp/>the<sp/>generic<sp/>methods<sp/>the</highlight></codeline>
<codeline lineno="1291"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>library<sp/>implements<sp/>for<sp/>all<sp/>its<sp/>model<sp/>(such<sp/>as<sp/>downloading<sp/>or<sp/>saving,<sp/>resizing<sp/>the<sp/>input<sp/>embeddings,<sp/>pruning<sp/>heads</highlight></codeline>
<codeline lineno="1292"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>etc.)</highlight></codeline>
<codeline lineno="1293"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>This<sp/>model<sp/>is<sp/>also<sp/>a<sp/>PyTorch<sp/>[torch.nn.Module](https://pytorch.org/docs/stable/nn.html#torch.nn.Module)<sp/>subclass.</highlight></codeline>
<codeline lineno="1294"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>Use<sp/>it<sp/>as<sp/>a<sp/>regular<sp/>PyTorch<sp/>Module<sp/>and<sp/>refer<sp/>to<sp/>the<sp/>PyTorch<sp/>documentation<sp/>for<sp/>all<sp/>matter<sp/>related<sp/>to<sp/>general<sp/>usage</highlight></codeline>
<codeline lineno="1295"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>and<sp/>behavior.</highlight></codeline>
<codeline lineno="1296"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>Parameters:</highlight></codeline>
<codeline lineno="1297"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config<sp/>([`DeepseekV3Config`]):</highlight></codeline>
<codeline lineno="1298"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Model<sp/>configuration<sp/>class<sp/>with<sp/>all<sp/>the<sp/>parameters<sp/>of<sp/>the<sp/>model.<sp/>Initializing<sp/>with<sp/>a<sp/>config<sp/>file<sp/>does<sp/>not</highlight></codeline>
<codeline lineno="1299"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>load<sp/>the<sp/>weights<sp/>associated<sp/>with<sp/>the<sp/>model,<sp/>only<sp/>the<sp/>configuration.<sp/>Check<sp/>out<sp/>the</highlight></codeline>
<codeline lineno="1300"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[`~PreTrainedModel.from_pretrained`]<sp/>method<sp/>to<sp/>load<sp/>the<sp/>model<sp/>weights.</highlight></codeline>
<codeline lineno="1301"><highlight class="stringliteral">&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1302"><highlight class="normal"></highlight></codeline>
<codeline lineno="1303"><highlight class="normal"></highlight></codeline>
<codeline lineno="1304"><highlight class="normal">@add_start_docstrings(</highlight></codeline>
<codeline lineno="1305"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;The<sp/>bare<sp/>DeepseekV3<sp/>Model<sp/>outputting<sp/>raw<sp/>hidden-states<sp/>without<sp/>any<sp/>specific<sp/>head<sp/>on<sp/>top.&quot;,</highlight></codeline>
<codeline lineno="1306"><highlight class="normal"><sp/><sp/><sp/><sp/>DeepseekV3_START_DOCSTRING,</highlight></codeline>
<codeline lineno="1307"><highlight class="normal">)</highlight></codeline>
<codeline lineno="1308" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel" refkind="compound"><highlight class="normal">class<sp/>DeepseekV3PreTrainedModel(PreTrainedModel):</highlight></codeline>
<codeline lineno="1309" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1a7d474bb0e4ceee261dbc5408308d19e5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>config_class<sp/>=<sp/>DeepseekV3Config</highlight></codeline>
<codeline lineno="1310" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1ae91340ec2f86af3258cd154b9b9c37f7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>base_model_prefix<sp/>=<sp/>&quot;model&quot;</highlight></codeline>
<codeline lineno="1311" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1a26ecbd5751fe120046a3ac63de76a119" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>supports_gradient_checkpointing<sp/>=<sp/>True</highlight></codeline>
<codeline lineno="1312" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1a6dde6aaabc5e04752f0051ba1fe1d00d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>_no_split_modules<sp/>=<sp/>[&quot;DeepseekV3DecoderLayer&quot;]</highlight></codeline>
<codeline lineno="1313" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1a47f21952aca9700e377488241fd4c7b1" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>_skip_keys_device_placement<sp/>=<sp/>&quot;past_key_values&quot;</highlight></codeline>
<codeline lineno="1314" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1a5d49dfaef213615f338caaf8006e6961" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>_supports_flash_attn_2<sp/>=<sp/>True</highlight></codeline>
<codeline lineno="1315" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1a419ff99c5c6047a575432bbab7dbac66" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>_supports_cache_class<sp/>=<sp/>True</highlight></codeline>
<codeline lineno="1316"><highlight class="normal"></highlight></codeline>
<codeline lineno="1317" refid="classmodeling__deepseek_1_1DeepseekV3PreTrainedModel_1ae39464b603daeade9cd604bbcb8a786a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>_init_weights(self,<sp/>module):</highlight></codeline>
<codeline lineno="1318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>std<sp/>=<sp/>self.config.initializer_range</highlight></codeline>
<codeline lineno="1319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>isinstance(module,<sp/>nn.Linear):</highlight></codeline>
<codeline lineno="1320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>module.weight.data.normal_(mean=0.0,<sp/>std=std)</highlight></codeline>
<codeline lineno="1321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>module.bias<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>module.bias.data.zero_()</highlight></codeline>
<codeline lineno="1323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>isinstance(module,<sp/>nn.Embedding):</highlight></codeline>
<codeline lineno="1324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>module.weight.data.normal_(mean=0.0,<sp/>std=std)</highlight></codeline>
<codeline lineno="1325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>module.padding_idx<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>module.weight.data[module.padding_idx].zero_()</highlight></codeline>
<codeline lineno="1327"><highlight class="normal"></highlight></codeline>
<codeline lineno="1328"><highlight class="normal"></highlight></codeline>
<codeline lineno="1329" refid="namespacemodeling__deepseek_1a0da3ab896abddeea5125328ccd7ba754" refkind="member"><highlight class="normal">DeepseekV3_INPUTS_DOCSTRING<sp/>=<sp/></highlight><highlight class="stringliteral">r&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1330"><highlight class="stringliteral"><sp/><sp/><sp/><sp/>Args:</highlight></codeline>
<codeline lineno="1331"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids<sp/>(`torch.LongTensor`<sp/>of<sp/>shape<sp/>`(batch_size,<sp/>sequence_length)`):</highlight></codeline>
<codeline lineno="1332"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Indices<sp/>of<sp/>input<sp/>sequence<sp/>tokens<sp/>in<sp/>the<sp/>vocabulary.<sp/>Padding<sp/>will<sp/>be<sp/>ignored<sp/>by<sp/>default<sp/>should<sp/>you<sp/>provide</highlight></codeline>
<codeline lineno="1333"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>it.</highlight></codeline>
<codeline lineno="1334"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Indices<sp/>can<sp/>be<sp/>obtained<sp/>using<sp/>[`AutoTokenizer`].<sp/>See<sp/>[`PreTrainedTokenizer.encode`]<sp/>and</highlight></codeline>
<codeline lineno="1335"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[`PreTrainedTokenizer.__call__`]<sp/>for<sp/>details.</highlight></codeline>
<codeline lineno="1336"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[What<sp/>are<sp/>input<sp/>IDs?](../glossary#input-ids)</highlight></codeline>
<codeline lineno="1337"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>(`torch.Tensor`<sp/>of<sp/>shape<sp/>`(batch_size,<sp/>sequence_length)`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1338"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Mask<sp/>to<sp/>avoid<sp/>performing<sp/>attention<sp/>on<sp/>padding<sp/>token<sp/>indices.<sp/>Mask<sp/>values<sp/>selected<sp/>in<sp/>`[0,<sp/>1]`:</highlight></codeline>
<codeline lineno="1339"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>1<sp/>for<sp/>tokens<sp/>that<sp/>are<sp/>**not<sp/>masked**,</highlight></codeline>
<codeline lineno="1340"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>0<sp/>for<sp/>tokens<sp/>that<sp/>are<sp/>**masked**.</highlight></codeline>
<codeline lineno="1341"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[What<sp/>are<sp/>attention<sp/>masks?](../glossary#attention-mask)</highlight></codeline>
<codeline lineno="1342"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Indices<sp/>can<sp/>be<sp/>obtained<sp/>using<sp/>[`AutoTokenizer`].<sp/>See<sp/>[`PreTrainedTokenizer.encode`]<sp/>and</highlight></codeline>
<codeline lineno="1343"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[`PreTrainedTokenizer.__call__`]<sp/>for<sp/>details.</highlight></codeline>
<codeline lineno="1344"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>`past_key_values`<sp/>is<sp/>used,<sp/>optionally<sp/>only<sp/>the<sp/>last<sp/>`input_ids`<sp/>have<sp/>to<sp/>be<sp/>input<sp/>(see</highlight></codeline>
<codeline lineno="1345"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>`past_key_values`).</highlight></codeline>
<codeline lineno="1346"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>you<sp/>want<sp/>to<sp/>change<sp/>padding<sp/>behavior,<sp/>you<sp/>should<sp/>read<sp/>[`modeling_opt._prepare_decoder_attention_mask`]</highlight></codeline>
<codeline lineno="1347"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>and<sp/>modify<sp/>to<sp/>your<sp/>needs.<sp/>See<sp/>diagram<sp/>1<sp/>in<sp/>[the<sp/>paper](https://arxiv.org/abs/1910.13461)<sp/>for<sp/>more</highlight></codeline>
<codeline lineno="1348"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>information<sp/>on<sp/>the<sp/>default<sp/>strategy.</highlight></codeline>
<codeline lineno="1349"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>1<sp/>indicates<sp/>the<sp/>head<sp/>is<sp/>**not<sp/>masked**,</highlight></codeline>
<codeline lineno="1350"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>0<sp/>indicates<sp/>the<sp/>head<sp/>is<sp/>**masked**.</highlight></codeline>
<codeline lineno="1351"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>(`torch.LongTensor`<sp/>of<sp/>shape<sp/>`(batch_size,<sp/>sequence_length)`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1352"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Indices<sp/>of<sp/>positions<sp/>of<sp/>each<sp/>input<sp/>sequence<sp/>tokens<sp/>in<sp/>the<sp/>position<sp/>embeddings.<sp/>Selected<sp/>in<sp/>the<sp/>range<sp/>`[0,</highlight></codeline>
<codeline lineno="1353"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.n_positions<sp/>-<sp/>1]`.</highlight></codeline>
<codeline lineno="1354"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[What<sp/>are<sp/>position<sp/>IDs?](../glossary#position-ids)</highlight></codeline>
<codeline lineno="1355"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values<sp/>(`Cache`<sp/>or<sp/>`tuple(tuple(torch.FloatTensor))`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1356"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Pre-computed<sp/>hidden-states<sp/>(key<sp/>and<sp/>values<sp/>in<sp/>the<sp/>self-attention<sp/>blocks<sp/>and<sp/>in<sp/>the<sp/>cross-attention</highlight></codeline>
<codeline lineno="1357"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>blocks)<sp/>that<sp/>can<sp/>be<sp/>used<sp/>to<sp/>speed<sp/>up<sp/>sequential<sp/>decoding.<sp/>This<sp/>typically<sp/>consists<sp/>in<sp/>the<sp/>`past_key_values`</highlight></codeline>
<codeline lineno="1358"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>returned<sp/>by<sp/>the<sp/>model<sp/>at<sp/>a<sp/>previous<sp/>stage<sp/>of<sp/>decoding,<sp/>when<sp/>`use_cache=True`<sp/>or<sp/>`config.use_cache=True`.</highlight></codeline>
<codeline lineno="1359"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Two<sp/>formats<sp/>are<sp/>allowed:</highlight></codeline>
<codeline lineno="1360"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>a<sp/>[`~cache_utils.Cache`]<sp/>instance;</highlight></codeline>
<codeline lineno="1361"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>-<sp/>Tuple<sp/>of<sp/>`tuple(torch.FloatTensor)`<sp/>of<sp/>length<sp/>`config.n_layers`,<sp/>with<sp/>each<sp/>tuple<sp/>having<sp/>2<sp/>tensors<sp/>of</highlight></codeline>
<codeline lineno="1362"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shape<sp/>`(batch_size,<sp/>num_heads,<sp/>sequence_length,<sp/>embed_size_per_head)`).<sp/>This<sp/>is<sp/>also<sp/>known<sp/>as<sp/>the<sp/>legacy</highlight></codeline>
<codeline lineno="1363"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cache<sp/>format.</highlight></codeline>
<codeline lineno="1364"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>The<sp/>model<sp/>will<sp/>output<sp/>the<sp/>same<sp/>cache<sp/>format<sp/>that<sp/>is<sp/>fed<sp/>as<sp/>input.<sp/>If<sp/>no<sp/>`past_key_values`<sp/>are<sp/>passed,<sp/>the</highlight></codeline>
<codeline lineno="1365"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>legacy<sp/>cache<sp/>format<sp/>will<sp/>be<sp/>returned.</highlight></codeline>
<codeline lineno="1366"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>`past_key_values`<sp/>are<sp/>used,<sp/>the<sp/>user<sp/>can<sp/>optionally<sp/>input<sp/>only<sp/>the<sp/>last<sp/>`input_ids`<sp/>(those<sp/>that<sp/>don&apos;t</highlight></codeline>
<codeline lineno="1367"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>have<sp/>their<sp/>past<sp/>key<sp/>value<sp/>states<sp/>given<sp/>to<sp/>this<sp/>model)<sp/>of<sp/>shape<sp/>`(batch_size,<sp/>1)`<sp/>instead<sp/>of<sp/>all<sp/>`input_ids`</highlight></codeline>
<codeline lineno="1368"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>of<sp/>shape<sp/>`(batch_size,<sp/>sequence_length)`.</highlight></codeline>
<codeline lineno="1369"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds<sp/>(`torch.FloatTensor`<sp/>of<sp/>shape<sp/>`(batch_size,<sp/>sequence_length,<sp/>hidden_size)`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1370"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Optionally,<sp/>instead<sp/>of<sp/>passing<sp/>`input_ids`<sp/>you<sp/>can<sp/>choose<sp/>to<sp/>directly<sp/>pass<sp/>an<sp/>embedded<sp/>representation.<sp/>This</highlight></codeline>
<codeline lineno="1371"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>is<sp/>useful<sp/>if<sp/>you<sp/>want<sp/>more<sp/>control<sp/>over<sp/>how<sp/>to<sp/>convert<sp/>`input_ids`<sp/>indices<sp/>into<sp/>associated<sp/>vectors<sp/>than<sp/>the</highlight></codeline>
<codeline lineno="1372"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>model&apos;s<sp/>internal<sp/>embedding<sp/>lookup<sp/>matrix.</highlight></codeline>
<codeline lineno="1373"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache<sp/>(`bool`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1374"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>If<sp/>set<sp/>to<sp/>`True`,<sp/>`past_key_values`<sp/>key<sp/>value<sp/>states<sp/>are<sp/>returned<sp/>and<sp/>can<sp/>be<sp/>used<sp/>to<sp/>speed<sp/>up<sp/>decoding<sp/>(see</highlight></codeline>
<codeline lineno="1375"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>`past_key_values`).</highlight></codeline>
<codeline lineno="1376"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions<sp/>(`bool`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1377"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Whether<sp/>or<sp/>not<sp/>to<sp/>return<sp/>the<sp/>attentions<sp/>tensors<sp/>of<sp/>all<sp/>attention<sp/>layers.<sp/>See<sp/>`attentions`<sp/>under<sp/>returned</highlight></codeline>
<codeline lineno="1378"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tensors<sp/>for<sp/>more<sp/>detail.</highlight></codeline>
<codeline lineno="1379"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states<sp/>(`bool`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1380"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Whether<sp/>or<sp/>not<sp/>to<sp/>return<sp/>the<sp/>hidden<sp/>states<sp/>of<sp/>all<sp/>layers.<sp/>See<sp/>`hidden_states`<sp/>under<sp/>returned<sp/>tensors<sp/>for</highlight></codeline>
<codeline lineno="1381"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>more<sp/>detail.</highlight></codeline>
<codeline lineno="1382"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>(`bool`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1383"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Whether<sp/>or<sp/>not<sp/>to<sp/>return<sp/>a<sp/>[`~utils.ModelOutput`]<sp/>instead<sp/>of<sp/>a<sp/>plain<sp/>tuple.</highlight></codeline>
<codeline lineno="1384"><highlight class="stringliteral">&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1385"><highlight class="normal"></highlight></codeline>
<codeline lineno="1386"><highlight class="normal"></highlight></codeline>
<codeline lineno="1387"><highlight class="normal">@add_start_docstrings(</highlight></codeline>
<codeline lineno="1388"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;The<sp/>bare<sp/>DeepseekV3<sp/>Model<sp/>outputting<sp/>raw<sp/>hidden-states<sp/>without<sp/>any<sp/>specific<sp/>head<sp/>on<sp/>top.&quot;,</highlight></codeline>
<codeline lineno="1389"><highlight class="normal"><sp/><sp/><sp/><sp/>DeepseekV3_START_DOCSTRING,</highlight></codeline>
<codeline lineno="1390"><highlight class="normal">)</highlight></codeline>
<codeline lineno="1391" refid="classmodeling__deepseek_1_1DeepseekV3Model" refkind="compound"><highlight class="normal">class<sp/>DeepseekV3Model(DeepseekV3PreTrainedModel):</highlight></codeline>
<codeline lineno="1392"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1393"><highlight class="normal"><sp/><sp/><sp/><sp/>Transformer<sp/>decoder<sp/>consisting<sp/>of<sp/>*config.num_hidden_layers*<sp/>layers.<sp/>Each<sp/>layer<sp/>is<sp/>a<sp/>[`DeepseekV3DecoderLayer`]</highlight></codeline>
<codeline lineno="1394"><highlight class="normal"><sp/><sp/><sp/><sp/>Args:</highlight></codeline>
<codeline lineno="1395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config:<sp/>DeepseekV3Config</highlight></codeline>
<codeline lineno="1396"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1397"><highlight class="normal"></highlight></codeline>
<codeline lineno="1398" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a0185e9c89d2431d6436819d9026272e8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>__init__(self,<sp/>config:<sp/>DeepseekV3Config):</highlight></codeline>
<codeline lineno="1399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().__init__(config)</highlight></codeline>
<codeline lineno="1400" refid="classmodeling__deepseek_1_1DeepseekV3Model_1abeef639068a6f00f0986c029c30ee089" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.padding_idx<sp/>=<sp/>config.pad_token_id</highlight></codeline>
<codeline lineno="1401" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a7706358bbac28fbc7fe2f248721ff686" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.vocab_size<sp/>=<sp/>config.vocab_size</highlight></codeline>
<codeline lineno="1402"><highlight class="normal"></highlight></codeline>
<codeline lineno="1403" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a50d53b622234a098e9cb05bf3eb4b174" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.embed_tokens<sp/>=<sp/>nn.Embedding(</highlight></codeline>
<codeline lineno="1404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.vocab_size,<sp/>config.hidden_size,<sp/>self.padding_idx</highlight></codeline>
<codeline lineno="1405"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1406" refid="classmodeling__deepseek_1_1DeepseekV3Model_1ac4ef5e6402248501a75e09fe50fc97d5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.layers<sp/>=<sp/>nn.ModuleList(</highlight></codeline>
<codeline lineno="1407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>[</highlight></codeline>
<codeline lineno="1408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>DeepseekV3DecoderLayer(config,<sp/>layer_idx)</highlight></codeline>
<codeline lineno="1409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>layer_idx<sp/>in<sp/>range(config.num_hidden_layers)</highlight></codeline>
<codeline lineno="1410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]</highlight></codeline>
<codeline lineno="1411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1412" refid="classmodeling__deepseek_1_1DeepseekV3Model_1afca7caa92c5ca69a6376bbc3aee899bc" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self._use_flash_attention_2<sp/>=<sp/>config._attn_implementation<sp/>==<sp/>&quot;flash_attention_2&quot;</highlight></codeline>
<codeline lineno="1413" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a543831f9b414c380f6ee9c64bb79bd03" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.norm<sp/>=<sp/>DeepseekV3RMSNorm(config.hidden_size,<sp/>eps=config.rms_norm_eps)</highlight></codeline>
<codeline lineno="1414"><highlight class="normal"></highlight></codeline>
<codeline lineno="1415" refid="classmodeling__deepseek_1_1DeepseekV3Model_1ab4d2c150b00d38ba41b62f22259582b3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.gradient_checkpointing<sp/>=<sp/>False</highlight></codeline>
<codeline lineno="1416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Initialize<sp/>weights<sp/>and<sp/>apply<sp/>final<sp/>processing</highlight></codeline>
<codeline lineno="1417"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.post_init()</highlight></codeline>
<codeline lineno="1418"><highlight class="normal"></highlight></codeline>
<codeline lineno="1419" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a520ce2820f7dc3ac6f4ac0c993d4d174" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>get_input_embeddings(self):</highlight></codeline>
<codeline lineno="1420"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>self.embed_tokens</highlight></codeline>
<codeline lineno="1421"><highlight class="normal"></highlight></codeline>
<codeline lineno="1422" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a3c509ee0055737fc20efddf9eaef30b9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>set_input_embeddings(self,<sp/>value):</highlight></codeline>
<codeline lineno="1423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.embed_tokens<sp/>=<sp/>value</highlight></codeline>
<codeline lineno="1424"><highlight class="normal"></highlight></codeline>
<codeline lineno="1425"><highlight class="normal"><sp/><sp/><sp/><sp/>@add_start_docstrings_to_model_forward(DeepseekV3_INPUTS_DOCSTRING)</highlight></codeline>
<codeline lineno="1426" refid="classmodeling__deepseek_1_1DeepseekV3Model_1a52079f13dedc7af8e831139b6180b7c1" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>forward(</highlight></codeline>
<codeline lineno="1427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids:<sp/>torch.LongTensor<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1429"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask:<sp/>Optional[torch.Tensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values:<sp/>Optional[List[torch.FloatTensor]]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1432"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds:<sp/>Optional[torch.FloatTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1437"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Union[Tuple,<sp/>BaseModelOutputWithPast]:</highlight></codeline>
<codeline lineno="1438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions</highlight></codeline>
<codeline lineno="1440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_attentions<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>self.config.output_attentions</highlight></codeline>
<codeline lineno="1442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states</highlight></codeline>
<codeline lineno="1445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_hidden_states<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>self.config.output_hidden_states</highlight></codeline>
<codeline lineno="1447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache<sp/>=<sp/>use_cache<sp/>if<sp/>use_cache<sp/>is<sp/>not<sp/>None<sp/>else<sp/>self.config.use_cache</highlight></codeline>
<codeline lineno="1449"><highlight class="normal"></highlight></codeline>
<codeline lineno="1450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>if<sp/>return_dict<sp/>is<sp/>not<sp/>None<sp/>else<sp/>self.config.use_return_dict</highlight></codeline>
<codeline lineno="1452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1453"><highlight class="normal"></highlight></codeline>
<codeline lineno="1454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>retrieve<sp/>input_ids<sp/>and<sp/>inputs_embeds</highlight></codeline>
<codeline lineno="1455"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>input_ids<sp/>is<sp/>not<sp/>None<sp/>and<sp/>inputs_embeds<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(</highlight></codeline>
<codeline lineno="1457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;You<sp/>cannot<sp/>specify<sp/>both<sp/>input_ids<sp/>and<sp/>inputs_embeds<sp/>at<sp/>the<sp/>same<sp/>time&quot;</highlight></codeline>
<codeline lineno="1458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>input_ids<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size,<sp/>seq_length<sp/>=<sp/>input_ids.shape[:2]</highlight></codeline>
<codeline lineno="1461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>inputs_embeds<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1462"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size,<sp/>seq_length<sp/>=<sp/>inputs_embeds.shape[:2]</highlight></codeline>
<codeline lineno="1463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(&quot;You<sp/>have<sp/>to<sp/>specify<sp/>either<sp/>input_ids<sp/>or<sp/>inputs_embeds&quot;)</highlight></codeline>
<codeline lineno="1465"><highlight class="normal"></highlight></codeline>
<codeline lineno="1466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values_length<sp/>=<sp/>0</highlight></codeline>
<codeline lineno="1467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>use_cache:</highlight></codeline>
<codeline lineno="1468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_legacy_cache<sp/>=<sp/>not<sp/>isinstance(past_key_values,<sp/>Cache)</highlight></codeline>
<codeline lineno="1469"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>use_legacy_cache:</highlight></codeline>
<codeline lineno="1470"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values<sp/>=<sp/>DynamicCache.from_legacy_cache(past_key_values)</highlight></codeline>
<codeline lineno="1471"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values_length<sp/>=<sp/>past_key_values.get_usable_length(seq_length)</highlight></codeline>
<codeline lineno="1472"><highlight class="normal"></highlight></codeline>
<codeline lineno="1473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>position_ids<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="1474"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device<sp/>=<sp/>input_ids.device<sp/>if<sp/>input_ids<sp/>is<sp/>not<sp/>None<sp/>else<sp/>inputs_embeds.device</highlight></codeline>
<codeline lineno="1475"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>=<sp/>torch.arange(</highlight></codeline>
<codeline lineno="1476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values_length,</highlight></codeline>
<codeline lineno="1477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>seq_length<sp/>+<sp/>past_key_values_length,</highlight></codeline>
<codeline lineno="1478"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dtype=torch.long,</highlight></codeline>
<codeline lineno="1479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>device=device,</highlight></codeline>
<codeline lineno="1480"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1481"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>=<sp/>position_ids.unsqueeze(0)</highlight></codeline>
<codeline lineno="1482"><highlight class="normal"></highlight></codeline>
<codeline lineno="1483"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>inputs_embeds<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="1484"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds<sp/>=<sp/>self.embed_tokens(input_ids)</highlight></codeline>
<codeline lineno="1485"><highlight class="normal"></highlight></codeline>
<codeline lineno="1486"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self._use_flash_attention_2:</highlight></codeline>
<codeline lineno="1487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>2d<sp/>mask<sp/>is<sp/>passed<sp/>through<sp/>the<sp/>layers</highlight></codeline>
<codeline lineno="1488"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1489"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask</highlight></codeline>
<codeline lineno="1490"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(attention_mask<sp/>is<sp/>not<sp/>None<sp/>and<sp/>0<sp/>in<sp/>attention_mask)</highlight></codeline>
<codeline lineno="1491"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>None</highlight></codeline>
<codeline lineno="1492"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1493"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1494"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>4d<sp/>mask<sp/>is<sp/>passed<sp/>through<sp/>the<sp/>layers</highlight></codeline>
<codeline lineno="1495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>=<sp/>_prepare_4d_causal_attention_mask(</highlight></codeline>
<codeline lineno="1496"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask,</highlight></codeline>
<codeline lineno="1497"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(batch_size,<sp/>seq_length),</highlight></codeline>
<codeline lineno="1498"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds,</highlight></codeline>
<codeline lineno="1499"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values_length,</highlight></codeline>
<codeline lineno="1500"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1501"><highlight class="normal"></highlight></codeline>
<codeline lineno="1502"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>embed<sp/>positions</highlight></codeline>
<codeline lineno="1503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>inputs_embeds</highlight></codeline>
<codeline lineno="1504"><highlight class="normal"></highlight></codeline>
<codeline lineno="1505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>decoder<sp/>layers</highlight></codeline>
<codeline lineno="1506"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_hidden_states<sp/>=<sp/>()<sp/>if<sp/>output_hidden_states<sp/>else<sp/>None</highlight></codeline>
<codeline lineno="1507"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_self_attns<sp/>=<sp/>()<sp/>if<sp/>output_attentions<sp/>else<sp/>None</highlight></codeline>
<codeline lineno="1508"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_decoder_cache<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="1509"><highlight class="normal"></highlight></codeline>
<codeline lineno="1510"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>decoder_layer<sp/>in<sp/>self.layers:</highlight></codeline>
<codeline lineno="1511"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_hidden_states:</highlight></codeline>
<codeline lineno="1512"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_hidden_states<sp/>+=<sp/>(hidden_states,)</highlight></codeline>
<codeline lineno="1513"><highlight class="normal"></highlight></codeline>
<codeline lineno="1514"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>layer_outputs<sp/>=<sp/>decoder_layer(</highlight></codeline>
<codeline lineno="1515"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states,</highlight></codeline>
<codeline lineno="1516"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask=attention_mask,</highlight></codeline>
<codeline lineno="1517"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids=position_ids,</highlight></codeline>
<codeline lineno="1518"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_value=past_key_values,</highlight></codeline>
<codeline lineno="1519"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions=output_attentions,</highlight></codeline>
<codeline lineno="1520"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache=use_cache,</highlight></codeline>
<codeline lineno="1521"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1522"><highlight class="normal"></highlight></codeline>
<codeline lineno="1523"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>layer_outputs[0]</highlight></codeline>
<codeline lineno="1524"><highlight class="normal"></highlight></codeline>
<codeline lineno="1525"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>use_cache:</highlight></codeline>
<codeline lineno="1526"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_decoder_cache<sp/>=<sp/>layer_outputs[2<sp/>if<sp/>output_attentions<sp/>else<sp/>1]</highlight></codeline>
<codeline lineno="1527"><highlight class="normal"></highlight></codeline>
<codeline lineno="1528"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_attentions:</highlight></codeline>
<codeline lineno="1529"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_self_attns<sp/>+=<sp/>(layer_outputs[1],)</highlight></codeline>
<codeline lineno="1530"><highlight class="normal"></highlight></codeline>
<codeline lineno="1531"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>self.norm(hidden_states)</highlight></codeline>
<codeline lineno="1532"><highlight class="normal"></highlight></codeline>
<codeline lineno="1533"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>add<sp/>hidden<sp/>states<sp/>from<sp/>the<sp/>last<sp/>decoder<sp/>layer</highlight></codeline>
<codeline lineno="1534"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_hidden_states:</highlight></codeline>
<codeline lineno="1535"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>all_hidden_states<sp/>+=<sp/>(hidden_states,)</highlight></codeline>
<codeline lineno="1536"><highlight class="normal"></highlight></codeline>
<codeline lineno="1537"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_cache<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="1538"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>use_cache:</highlight></codeline>
<codeline lineno="1539"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_cache<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1540"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>next_decoder_cache.to_legacy_cache()</highlight></codeline>
<codeline lineno="1541"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>use_legacy_cache</highlight></codeline>
<codeline lineno="1542"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>next_decoder_cache</highlight></codeline>
<codeline lineno="1543"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1544"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>return_dict:</highlight></codeline>
<codeline lineno="1545"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>tuple(</highlight></codeline>
<codeline lineno="1546"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>v</highlight></codeline>
<codeline lineno="1547"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>v<sp/>in<sp/>[hidden_states,<sp/>next_cache,<sp/>all_hidden_states,<sp/>all_self_attns]</highlight></codeline>
<codeline lineno="1548"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>v<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1549"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1550"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>BaseModelOutputWithPast(</highlight></codeline>
<codeline lineno="1551"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>last_hidden_state=hidden_states,</highlight></codeline>
<codeline lineno="1552"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values=next_cache,</highlight></codeline>
<codeline lineno="1553"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states=all_hidden_states,</highlight></codeline>
<codeline lineno="1554"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attentions=all_self_attns,</highlight></codeline>
<codeline lineno="1555"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1556"><highlight class="normal"></highlight></codeline>
<codeline lineno="1557"><highlight class="normal"></highlight></codeline>
<codeline lineno="1558" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM" refkind="compound"><highlight class="normal">class<sp/>DeepseekV3ForCausalLM(DeepseekV3PreTrainedModel):</highlight></codeline>
<codeline lineno="1559" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1a565a7fe638ed802fe23dc2d0460003f6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>_tied_weights_keys<sp/>=<sp/>[&quot;lm_head.weight&quot;]</highlight></codeline>
<codeline lineno="1560"><highlight class="normal"></highlight></codeline>
<codeline lineno="1561" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1aed4faa6621f4870fd6552fd04b92dc53" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>__init__(self,<sp/>config):</highlight></codeline>
<codeline lineno="1562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().__init__(config)</highlight></codeline>
<codeline lineno="1563" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1aad4697749ec5e14181f5180403c62678" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.model<sp/>=<sp/>DeepseekV3Model(config)</highlight></codeline>
<codeline lineno="1564" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1a083b08366f44ab692ef2667058e6fb6f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.vocab_size<sp/>=<sp/>config.vocab_size</highlight></codeline>
<codeline lineno="1565" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1a6be372824ccd084ed5cb22b425f4988c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.lm_head<sp/>=<sp/>nn.Linear(config.hidden_size,<sp/>config.vocab_size,<sp/>bias=False)</highlight></codeline>
<codeline lineno="1566"><highlight class="normal"></highlight></codeline>
<codeline lineno="1567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Initialize<sp/>weights<sp/>and<sp/>apply<sp/>final<sp/>processing</highlight></codeline>
<codeline lineno="1568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.post_init()</highlight></codeline>
<codeline lineno="1569"><highlight class="normal"></highlight></codeline>
<codeline lineno="1570" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1ab1878b3d66cfe81b5fbcec20780c9a8a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>get_input_embeddings(self):</highlight></codeline>
<codeline lineno="1571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>self.model.embed_tokens</highlight></codeline>
<codeline lineno="1572"><highlight class="normal"></highlight></codeline>
<codeline lineno="1573" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1af6b35f00f1a33c0d79b8b3535422fda6" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>set_input_embeddings(self,<sp/>value):</highlight></codeline>
<codeline lineno="1574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.model.embed_tokens<sp/>=<sp/>value</highlight></codeline>
<codeline lineno="1575"><highlight class="normal"></highlight></codeline>
<codeline lineno="1576" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1a34d6acbb961f016ac722ce7750e9dee9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>get_output_embeddings(self):</highlight></codeline>
<codeline lineno="1577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>self.lm_head</highlight></codeline>
<codeline lineno="1578"><highlight class="normal"></highlight></codeline>
<codeline lineno="1579" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1a1c13f841d9294cfb47727ac3dc7030b5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>set_output_embeddings(self,<sp/>new_embeddings):</highlight></codeline>
<codeline lineno="1580"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.lm_head<sp/>=<sp/>new_embeddings</highlight></codeline>
<codeline lineno="1581"><highlight class="normal"></highlight></codeline>
<codeline lineno="1582" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1a44b823f01d922a75f964d72a9d28343f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>set_decoder(self,<sp/>decoder):</highlight></codeline>
<codeline lineno="1583"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.model<sp/>=<sp/>decoder</highlight></codeline>
<codeline lineno="1584"><highlight class="normal"></highlight></codeline>
<codeline lineno="1585" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1ac922b83ff8476b87ba63d94d5836c2c5" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>get_decoder(self):</highlight></codeline>
<codeline lineno="1586"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>self.model</highlight></codeline>
<codeline lineno="1587"><highlight class="normal"></highlight></codeline>
<codeline lineno="1588"><highlight class="normal"><sp/><sp/><sp/><sp/>@add_start_docstrings_to_model_forward(DeepseekV3_INPUTS_DOCSTRING)</highlight></codeline>
<codeline lineno="1589"><highlight class="normal"><sp/><sp/><sp/><sp/>@replace_return_docstrings(</highlight></codeline>
<codeline lineno="1590"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_type=CausalLMOutputWithPast,<sp/>config_class=_CONFIG_FOR_DOC</highlight></codeline>
<codeline lineno="1591"><highlight class="normal"><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1592" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1ad418bf03e1ce9c23aa5e3ad6a4bf2672" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>forward(</highlight></codeline>
<codeline lineno="1593"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1594"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids:<sp/>torch.LongTensor<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1595"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask:<sp/>Optional[torch.Tensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1596"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1597"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values:<sp/>Optional[List[torch.FloatTensor]]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1598"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds:<sp/>Optional[torch.FloatTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1599"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>labels:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1600"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1601"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1602"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1603"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1604"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Union[Tuple,<sp/>CausalLMOutputWithPast]:</highlight></codeline>
<codeline lineno="1605"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">r&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1606"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Args:</highlight></codeline>
<codeline lineno="1607"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>labels<sp/>(`torch.LongTensor`<sp/>of<sp/>shape<sp/>`(batch_size,<sp/>sequence_length)`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1608"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Labels<sp/>for<sp/>computing<sp/>the<sp/>masked<sp/>language<sp/>modeling<sp/>loss.<sp/>Indices<sp/>should<sp/>either<sp/>be<sp/>in<sp/>`[0,<sp/>transformers.,</highlight></codeline>
<codeline lineno="1609"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.vocab_size]`<sp/>or<sp/>-100<sp/>(see<sp/>`input_ids`<sp/>docstring).<sp/>Tokens<sp/>with<sp/>indices<sp/>set<sp/>to<sp/>`-100`<sp/>are<sp/>ignored</highlight></codeline>
<codeline lineno="1610"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>(masked),<sp/>the<sp/>loss<sp/>is<sp/>only<sp/>computed<sp/>for<sp/>the<sp/>tokens<sp/>with<sp/>labels<sp/>in<sp/>`[0,<sp/>transformers.,<sp/>config.vocab_size]`.</highlight></codeline>
<codeline lineno="1611"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Returns:</highlight></codeline>
<codeline lineno="1612"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Example:</highlight></codeline>
<codeline lineno="1613"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>```python</highlight></codeline>
<codeline lineno="1614"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>from<sp/>transformers<sp/>import<sp/>AutoTokenizer,<sp/>DeepseekV3ForCausalLM</highlight></codeline>
<codeline lineno="1615"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>model<sp/>=<sp/>DeepseekV3ForCausalLM.from_pretrained(PATH_TO_CONVERTED_WEIGHTS)</highlight></codeline>
<codeline lineno="1616"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>tokenizer<sp/>=<sp/>AutoTokenizer.from_pretrained(PATH_TO_CONVERTED_TOKENIZER)</highlight></codeline>
<codeline lineno="1617"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>prompt<sp/>=<sp/>&quot;Hey,<sp/>are<sp/>you<sp/>conscious?<sp/>Can<sp/>you<sp/>talk<sp/>to<sp/>me?&quot;</highlight></codeline>
<codeline lineno="1618"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>inputs<sp/>=<sp/>tokenizer(prompt,<sp/>return_tensors=&quot;pt&quot;)</highlight></codeline>
<codeline lineno="1619"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>#<sp/>Generate</highlight></codeline>
<codeline lineno="1620"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>generate_ids<sp/>=<sp/>model.generate(inputs.input_ids,<sp/>max_length=30)</highlight></codeline>
<codeline lineno="1621"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&gt;&gt;&gt;<sp/>tokenizer.batch_decode(generate_ids,<sp/>skip_special_tokens=True,<sp/>clean_up_tokenization_spaces=False)[0]</highlight></codeline>
<codeline lineno="1622"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;Hey,<sp/>are<sp/>you<sp/>conscious?<sp/>Can<sp/>you<sp/>talk<sp/>to<sp/>me?\nI&apos;m<sp/>not<sp/>conscious,<sp/>but<sp/>I<sp/>can<sp/>talk<sp/>to<sp/>you.&quot;</highlight></codeline>
<codeline lineno="1623"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>```&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1624"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1625"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions</highlight></codeline>
<codeline lineno="1626"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_attentions<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1627"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>self.config.output_attentions</highlight></codeline>
<codeline lineno="1628"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1629"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1630"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states</highlight></codeline>
<codeline lineno="1631"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>output_hidden_states<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1632"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else<sp/>self.config.output_hidden_states</highlight></codeline>
<codeline lineno="1633"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1634"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1635"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>if<sp/>return_dict<sp/>is<sp/>not<sp/>None<sp/>else<sp/>self.config.use_return_dict</highlight></codeline>
<codeline lineno="1636"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1637"><highlight class="normal"></highlight></codeline>
<codeline lineno="1638"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>decoder<sp/>outputs<sp/>consists<sp/>of<sp/>(dec_features,<sp/>layer_state,<sp/>dec_hidden,<sp/>dec_attn)</highlight></codeline>
<codeline lineno="1639"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>outputs<sp/>=<sp/>self.model(</highlight></codeline>
<codeline lineno="1640"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids=input_ids,</highlight></codeline>
<codeline lineno="1641"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask=attention_mask,</highlight></codeline>
<codeline lineno="1642"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids=position_ids,</highlight></codeline>
<codeline lineno="1643"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values=past_key_values,</highlight></codeline>
<codeline lineno="1644"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds=inputs_embeds,</highlight></codeline>
<codeline lineno="1645"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache=use_cache,</highlight></codeline>
<codeline lineno="1646"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions=output_attentions,</highlight></codeline>
<codeline lineno="1647"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states=output_hidden_states,</highlight></codeline>
<codeline lineno="1648"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict=return_dict,</highlight></codeline>
<codeline lineno="1649"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1650"><highlight class="normal"></highlight></codeline>
<codeline lineno="1651"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>outputs[0]</highlight></codeline>
<codeline lineno="1652"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logits<sp/>=<sp/>self.lm_head(hidden_states)</highlight></codeline>
<codeline lineno="1653"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logits<sp/>=<sp/>logits.float()</highlight></codeline>
<codeline lineno="1654"><highlight class="normal"></highlight></codeline>
<codeline lineno="1655"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="1656"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>labels<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1657"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Shift<sp/>so<sp/>that<sp/>tokens<sp/>&lt;<sp/>n<sp/>predict<sp/>n</highlight></codeline>
<codeline lineno="1658"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shift_logits<sp/>=<sp/>logits[...,<sp/>:-1,<sp/>:].contiguous()</highlight></codeline>
<codeline lineno="1659"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shift_labels<sp/>=<sp/>labels[...,<sp/>1:].contiguous()</highlight></codeline>
<codeline lineno="1660"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Flatten<sp/>the<sp/>tokens</highlight></codeline>
<codeline lineno="1661"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss_fct<sp/>=<sp/>CrossEntropyLoss()</highlight></codeline>
<codeline lineno="1662"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shift_logits<sp/>=<sp/>shift_logits.view(-1,<sp/>self.config.vocab_size)</highlight></codeline>
<codeline lineno="1663"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shift_labels<sp/>=<sp/>shift_labels.view(-1)</highlight></codeline>
<codeline lineno="1664"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Enable<sp/>model<sp/>parallelism</highlight></codeline>
<codeline lineno="1665"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>shift_labels<sp/>=<sp/>shift_labels.to(shift_logits.device)</highlight></codeline>
<codeline lineno="1666"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>loss_fct(shift_logits,<sp/>shift_labels)</highlight></codeline>
<codeline lineno="1667"><highlight class="normal"></highlight></codeline>
<codeline lineno="1668"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>return_dict:</highlight></codeline>
<codeline lineno="1669"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output<sp/>=<sp/>(logits,)<sp/>+<sp/>outputs[1:]</highlight></codeline>
<codeline lineno="1670"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>(loss,)<sp/>+<sp/>output<sp/>if<sp/>loss<sp/>is<sp/>not<sp/>None<sp/>else<sp/>output</highlight></codeline>
<codeline lineno="1671"><highlight class="normal"></highlight></codeline>
<codeline lineno="1672"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>CausalLMOutputWithPast(</highlight></codeline>
<codeline lineno="1673"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss=loss,</highlight></codeline>
<codeline lineno="1674"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logits=logits,</highlight></codeline>
<codeline lineno="1675"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values=outputs.past_key_values,</highlight></codeline>
<codeline lineno="1676"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states=outputs.hidden_states,</highlight></codeline>
<codeline lineno="1677"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attentions=outputs.attentions,</highlight></codeline>
<codeline lineno="1678"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1679"><highlight class="normal"></highlight></codeline>
<codeline lineno="1680" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1aa0665c472444548a23e07d2441a57990" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>prepare_inputs_for_generation(</highlight></codeline>
<codeline lineno="1681"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1682"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids,</highlight></codeline>
<codeline lineno="1683"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values=None,</highlight></codeline>
<codeline lineno="1684"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask=None,</highlight></codeline>
<codeline lineno="1685"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds=None,</highlight></codeline>
<codeline lineno="1686"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>**kwargs,</highlight></codeline>
<codeline lineno="1687"><highlight class="normal"><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1688"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>past_key_values<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1689"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>isinstance(past_key_values,<sp/>Cache):</highlight></codeline>
<codeline lineno="1690"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cache_length<sp/>=<sp/>past_key_values.get_seq_length()</highlight></codeline>
<codeline lineno="1691"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_length<sp/>=<sp/>past_key_values.seen_tokens</highlight></codeline>
<codeline lineno="1692"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_cache_length<sp/>=<sp/>past_key_values.get_max_length()</highlight></codeline>
<codeline lineno="1693"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1694"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cache_length<sp/>=<sp/>past_length<sp/>=<sp/>past_key_values[0][0].shape[2]</highlight></codeline>
<codeline lineno="1695"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_cache_length<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="1696"><highlight class="normal"></highlight></codeline>
<codeline lineno="1697"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Keep<sp/>only<sp/>the<sp/>unprocessed<sp/>tokens:</highlight></codeline>
<codeline lineno="1698"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>1<sp/>-<sp/>If<sp/>the<sp/>length<sp/>of<sp/>the<sp/>attention_mask<sp/>exceeds<sp/>the<sp/>length<sp/>of<sp/>input_ids,<sp/>then<sp/>we<sp/>are<sp/>in<sp/>a<sp/>setting<sp/>where</highlight></codeline>
<codeline lineno="1699"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>some<sp/>of<sp/>the<sp/>inputs<sp/>are<sp/>exclusivelly<sp/>passed<sp/>as<sp/>part<sp/>of<sp/>the<sp/>cache<sp/>(e.g.<sp/>when<sp/>passing<sp/>input_embeds<sp/>as</highlight></codeline>
<codeline lineno="1700"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>input)</highlight></codeline>
<codeline lineno="1701"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(</highlight></codeline>
<codeline lineno="1702"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1703"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>and<sp/>attention_mask.shape[1]<sp/>&gt;<sp/>input_ids.shape[1]</highlight></codeline>
<codeline lineno="1704"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1705"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids<sp/>=<sp/>input_ids[:,<sp/>-(attention_mask.shape[1]<sp/>-<sp/>past_length)<sp/>:]</highlight></codeline>
<codeline lineno="1706"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>2<sp/>-<sp/>If<sp/>the<sp/>past_length<sp/>is<sp/>smaller<sp/>than<sp/>input_ids&apos;,<sp/>then<sp/>input_ids<sp/>holds<sp/>all<sp/>input<sp/>tokens.<sp/>We<sp/>can<sp/>discard</highlight></codeline>
<codeline lineno="1707"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>input_ids<sp/>based<sp/>on<sp/>the<sp/>past_length.</highlight></codeline>
<codeline lineno="1708"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>past_length<sp/>&lt;<sp/>input_ids.shape[1]:</highlight></codeline>
<codeline lineno="1709"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids<sp/>=<sp/>input_ids[:,<sp/>past_length:]</highlight></codeline>
<codeline lineno="1710"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>3<sp/>-<sp/>Otherwise<sp/>(past_length<sp/>&gt;=<sp/>input_ids.shape[1]),<sp/>let&apos;s<sp/>assume<sp/>input_ids<sp/>only<sp/>has<sp/>unprocessed<sp/>tokens.</highlight></codeline>
<codeline lineno="1711"><highlight class="normal"></highlight></codeline>
<codeline lineno="1712"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>If<sp/>we<sp/>are<sp/>about<sp/>to<sp/>go<sp/>beyond<sp/>the<sp/>maximum<sp/>cache<sp/>length,<sp/>we<sp/>need<sp/>to<sp/>crop<sp/>the<sp/>input<sp/>attention<sp/>mask.</highlight></codeline>
<codeline lineno="1713"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>(</highlight></codeline>
<codeline lineno="1714"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>max_cache_length<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1715"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>and<sp/>attention_mask<sp/>is<sp/>not<sp/>None</highlight></codeline>
<codeline lineno="1716"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>and<sp/>cache_length<sp/>+<sp/>input_ids.shape[1]<sp/>&gt;<sp/>max_cache_length</highlight></codeline>
<codeline lineno="1717"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1718"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask<sp/>=<sp/>attention_mask[:,<sp/>-max_cache_length:]</highlight></codeline>
<codeline lineno="1719"><highlight class="normal"></highlight></codeline>
<codeline lineno="1720"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>=<sp/>kwargs.get(&quot;position_ids&quot;,<sp/>None)</highlight></codeline>
<codeline lineno="1721"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>attention_mask<sp/>is<sp/>not<sp/>None<sp/>and<sp/>position_ids<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="1722"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>create<sp/>position_ids<sp/>on<sp/>the<sp/>fly<sp/>for<sp/>batch<sp/>generation</highlight></codeline>
<codeline lineno="1723"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>=<sp/>attention_mask.long().cumsum(-1)<sp/>-<sp/>1</highlight></codeline>
<codeline lineno="1724"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids.masked_fill_(attention_mask<sp/>==<sp/>0,<sp/>1)</highlight></codeline>
<codeline lineno="1725"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>past_key_values:</highlight></codeline>
<codeline lineno="1726"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids<sp/>=<sp/>position_ids[:,<sp/>-input_ids.shape[1]<sp/>:]</highlight></codeline>
<codeline lineno="1727"><highlight class="normal"></highlight></codeline>
<codeline lineno="1728"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>if<sp/>`inputs_embeds`<sp/>are<sp/>passed,<sp/>we<sp/>only<sp/>want<sp/>to<sp/>use<sp/>them<sp/>in<sp/>the<sp/>1st<sp/>generation<sp/>step</highlight></codeline>
<codeline lineno="1729"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>inputs_embeds<sp/>is<sp/>not<sp/>None<sp/>and<sp/>past_key_values<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="1730"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>model_inputs<sp/>=<sp/>{&quot;inputs_embeds&quot;:<sp/>inputs_embeds}</highlight></codeline>
<codeline lineno="1731"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1732"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>model_inputs<sp/>=<sp/>{&quot;input_ids&quot;:<sp/>input_ids}</highlight></codeline>
<codeline lineno="1733"><highlight class="normal"></highlight></codeline>
<codeline lineno="1734"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>model_inputs.update(</highlight></codeline>
<codeline lineno="1735"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="1736"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;position_ids&quot;:<sp/>position_ids,</highlight></codeline>
<codeline lineno="1737"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;past_key_values&quot;:<sp/>past_key_values,</highlight></codeline>
<codeline lineno="1738"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;use_cache&quot;:<sp/>kwargs.get(&quot;use_cache&quot;),</highlight></codeline>
<codeline lineno="1739"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;attention_mask&quot;:<sp/>attention_mask,</highlight></codeline>
<codeline lineno="1740"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="1741"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1742"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>model_inputs</highlight></codeline>
<codeline lineno="1743"><highlight class="normal"></highlight></codeline>
<codeline lineno="1744"><highlight class="normal"><sp/><sp/><sp/><sp/>@staticmethod</highlight></codeline>
<codeline lineno="1745" refid="classmodeling__deepseek_1_1DeepseekV3ForCausalLM_1add132503d3e9b761cf4bcfc9b254a1ed" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>_reorder_cache(past_key_values,<sp/>beam_idx):</highlight></codeline>
<codeline lineno="1746"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reordered_past<sp/>=<sp/>()</highlight></codeline>
<codeline lineno="1747"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>layer_past<sp/>in<sp/>past_key_values:</highlight></codeline>
<codeline lineno="1748"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>reordered_past<sp/>+=<sp/>(</highlight></codeline>
<codeline lineno="1749"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>tuple(</highlight></codeline>
<codeline lineno="1750"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_state.index_select(0,<sp/>beam_idx.to(past_state.device))</highlight></codeline>
<codeline lineno="1751"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>for<sp/>past_state<sp/>in<sp/>layer_past</highlight></codeline>
<codeline lineno="1752"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>),</highlight></codeline>
<codeline lineno="1753"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1754"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>reordered_past</highlight></codeline>
<codeline lineno="1755"><highlight class="normal"></highlight></codeline>
<codeline lineno="1756"><highlight class="normal"></highlight></codeline>
<codeline lineno="1757"><highlight class="normal">@add_start_docstrings(</highlight></codeline>
<codeline lineno="1758"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1759"><highlight class="normal"><sp/><sp/><sp/><sp/>The<sp/>DeepseekV3<sp/>Model<sp/>transformer<sp/>with<sp/>a<sp/>sequence<sp/>classification<sp/>head<sp/>on<sp/>top<sp/>(linear<sp/>layer).</highlight></codeline>
<codeline lineno="1760"><highlight class="normal"><sp/><sp/><sp/><sp/>[`DeepseekV3ForSequenceClassification`]<sp/>uses<sp/>the<sp/>last<sp/>token<sp/>in<sp/>order<sp/>to<sp/>do<sp/>the<sp/>classification,<sp/>as<sp/>other<sp/>causal<sp/>models</highlight></codeline>
<codeline lineno="1761"><highlight class="normal"><sp/><sp/><sp/><sp/>(e.g.<sp/>GPT-2)<sp/>do.</highlight></codeline>
<codeline lineno="1762"><highlight class="normal"><sp/><sp/><sp/><sp/>Since<sp/>it<sp/>does<sp/>classification<sp/>on<sp/>the<sp/>last<sp/>token,<sp/>it<sp/>requires<sp/>to<sp/>know<sp/>the<sp/>position<sp/>of<sp/>the<sp/>last<sp/>token.<sp/>If<sp/>a</highlight></codeline>
<codeline lineno="1763"><highlight class="normal"><sp/><sp/><sp/><sp/>`pad_token_id`<sp/>is<sp/>defined<sp/>in<sp/>the<sp/>configuration,<sp/>it<sp/>finds<sp/>the<sp/>last<sp/>token<sp/>that<sp/>is<sp/>not<sp/>a<sp/>padding<sp/>token<sp/>in<sp/>each<sp/>row.<sp/>If</highlight></codeline>
<codeline lineno="1764"><highlight class="normal"><sp/><sp/><sp/><sp/>no<sp/>`pad_token_id`<sp/>is<sp/>defined,<sp/>it<sp/>simply<sp/>takes<sp/>the<sp/>last<sp/>value<sp/>in<sp/>each<sp/>row<sp/>of<sp/>the<sp/>batch.<sp/>Since<sp/>it<sp/>cannot<sp/>guess<sp/>the</highlight></codeline>
<codeline lineno="1765"><highlight class="normal"><sp/><sp/><sp/><sp/>padding<sp/>tokens<sp/>when<sp/>`inputs_embeds`<sp/>are<sp/>passed<sp/>instead<sp/>of<sp/>`input_ids`,<sp/>it<sp/>does<sp/>the<sp/>same<sp/>(take<sp/>the<sp/>last<sp/>value<sp/>in</highlight></codeline>
<codeline lineno="1766"><highlight class="normal"><sp/><sp/><sp/><sp/>each<sp/>row<sp/>of<sp/>the<sp/>batch).</highlight></codeline>
<codeline lineno="1767"><highlight class="normal"><sp/><sp/><sp/><sp/>&quot;&quot;&quot;,</highlight></codeline>
<codeline lineno="1768"><highlight class="normal"><sp/><sp/><sp/><sp/>DeepseekV3_START_DOCSTRING,</highlight></codeline>
<codeline lineno="1769"><highlight class="normal">)</highlight></codeline>
<codeline lineno="1770" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification" refkind="compound"><highlight class="normal">class<sp/>DeepseekV3ForSequenceClassification(DeepseekV3PreTrainedModel):</highlight></codeline>
<codeline lineno="1771" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1ad3f02d6db56704c70fd4599cd00d38e1" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>__init__(self,<sp/>config):</highlight></codeline>
<codeline lineno="1772"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>super().__init__(config)</highlight></codeline>
<codeline lineno="1773" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1a1f6de83af3dd6afb28cbbb210140ef5e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.num_labels<sp/>=<sp/>config.num_labels</highlight></codeline>
<codeline lineno="1774" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1acb029dadf3b1efc6c53745e936d9196c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.model<sp/>=<sp/>DeepseekV3Model(config)</highlight></codeline>
<codeline lineno="1775" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1a42e3c0a1e37298d4bf81407969d258f3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.score<sp/>=<sp/>nn.Linear(config.hidden_size,<sp/>self.num_labels,<sp/>bias=False)</highlight></codeline>
<codeline lineno="1776"><highlight class="normal"></highlight></codeline>
<codeline lineno="1777"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#<sp/>Initialize<sp/>weights<sp/>and<sp/>apply<sp/>final<sp/>processing</highlight></codeline>
<codeline lineno="1778"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.post_init()</highlight></codeline>
<codeline lineno="1779"><highlight class="normal"></highlight></codeline>
<codeline lineno="1780" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1a59604452d77a43090aa4b2013f72c1f8" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>get_input_embeddings(self):</highlight></codeline>
<codeline lineno="1781"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>self.model.embed_tokens</highlight></codeline>
<codeline lineno="1782"><highlight class="normal"></highlight></codeline>
<codeline lineno="1783" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1a5ddc1b3a59c71d5951369ec1ae9d6807" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>set_input_embeddings(self,<sp/>value):</highlight></codeline>
<codeline lineno="1784"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.model.embed_tokens<sp/>=<sp/>value</highlight></codeline>
<codeline lineno="1785"><highlight class="normal"></highlight></codeline>
<codeline lineno="1786"><highlight class="normal"><sp/><sp/><sp/><sp/>@add_start_docstrings_to_model_forward(DeepseekV3_INPUTS_DOCSTRING)</highlight></codeline>
<codeline lineno="1787" refid="classmodeling__deepseek_1_1DeepseekV3ForSequenceClassification_1a392a427c3f5ed209e815703be6ba6b93" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>def<sp/>forward(</highlight></codeline>
<codeline lineno="1788"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self,</highlight></codeline>
<codeline lineno="1789"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids:<sp/>torch.LongTensor<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1790"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask:<sp/>Optional[torch.Tensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1791"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1792"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values:<sp/>Optional[List[torch.FloatTensor]]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1793"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds:<sp/>Optional[torch.FloatTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1794"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>labels:<sp/>Optional[torch.LongTensor]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1795"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1796"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1797"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1798"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict:<sp/>Optional[bool]<sp/>=<sp/>None,</highlight></codeline>
<codeline lineno="1799"><highlight class="normal"><sp/><sp/><sp/><sp/>)<sp/>-&gt;<sp/>Union[Tuple,<sp/>SequenceClassifierOutputWithPast]:</highlight></codeline>
<codeline lineno="1800"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">r&quot;&quot;&quot;</highlight></codeline>
<codeline lineno="1801"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>labels<sp/>(`torch.LongTensor`<sp/>of<sp/>shape<sp/>`(batch_size,)`,<sp/>*optional*):</highlight></codeline>
<codeline lineno="1802"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Labels<sp/>for<sp/>computing<sp/>the<sp/>sequence<sp/>classification/regression<sp/>loss.<sp/>Indices<sp/>should<sp/>be<sp/>in<sp/>`[0,<sp/>transformers.,</highlight></codeline>
<codeline lineno="1803"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>config.num_labels<sp/>-<sp/>1]`.<sp/>If<sp/>`config.num_labels<sp/>==<sp/>1`<sp/>a<sp/>regression<sp/>loss<sp/>is<sp/>computed<sp/>(Mean-Square<sp/>loss),<sp/>If</highlight></codeline>
<codeline lineno="1804"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>`config.num_labels<sp/>&gt;<sp/>1`<sp/>a<sp/>classification<sp/>loss<sp/>is<sp/>computed<sp/>(Cross-Entropy).</highlight></codeline>
<codeline lineno="1805"><highlight class="stringliteral"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;&quot;&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="1806"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1807"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict<sp/>if<sp/>return_dict<sp/>is<sp/>not<sp/>None<sp/>else<sp/>self.config.use_return_dict</highlight></codeline>
<codeline lineno="1808"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1809"><highlight class="normal"></highlight></codeline>
<codeline lineno="1810"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>transformer_outputs<sp/>=<sp/>self.model(</highlight></codeline>
<codeline lineno="1811"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input_ids,</highlight></codeline>
<codeline lineno="1812"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attention_mask=attention_mask,</highlight></codeline>
<codeline lineno="1813"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>position_ids=position_ids,</highlight></codeline>
<codeline lineno="1814"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values=past_key_values,</highlight></codeline>
<codeline lineno="1815"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>inputs_embeds=inputs_embeds,</highlight></codeline>
<codeline lineno="1816"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>use_cache=use_cache,</highlight></codeline>
<codeline lineno="1817"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_attentions=output_attentions,</highlight></codeline>
<codeline lineno="1818"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output_hidden_states=output_hidden_states,</highlight></codeline>
<codeline lineno="1819"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return_dict=return_dict,</highlight></codeline>
<codeline lineno="1820"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1821"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states<sp/>=<sp/>transformer_outputs[0]</highlight></codeline>
<codeline lineno="1822"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logits<sp/>=<sp/>self.score(hidden_states)</highlight></codeline>
<codeline lineno="1823"><highlight class="normal"></highlight></codeline>
<codeline lineno="1824"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>input_ids<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1825"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size<sp/>=<sp/>input_ids.shape[0]</highlight></codeline>
<codeline lineno="1826"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1827"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>batch_size<sp/>=<sp/>inputs_embeds.shape[0]</highlight></codeline>
<codeline lineno="1828"><highlight class="normal"></highlight></codeline>
<codeline lineno="1829"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.config.pad_token_id<sp/>is<sp/>None<sp/>and<sp/>batch_size<sp/>!=<sp/>1:</highlight></codeline>
<codeline lineno="1830"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>raise<sp/>ValueError(</highlight></codeline>
<codeline lineno="1831"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&quot;Cannot<sp/>handle<sp/>batch<sp/>sizes<sp/>&gt;<sp/>1<sp/>if<sp/>no<sp/>padding<sp/>token<sp/>is<sp/>defined.&quot;</highlight></codeline>
<codeline lineno="1832"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1833"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.config.pad_token_id<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="1834"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sequence_lengths<sp/>=<sp/>-1</highlight></codeline>
<codeline lineno="1835"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1836"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>input_ids<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1837"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sequence_lengths<sp/>=<sp/>(</highlight></codeline>
<codeline lineno="1838"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.eq(input_ids,<sp/>self.config.pad_token_id).int().argmax(-1)<sp/>-<sp/>1</highlight></codeline>
<codeline lineno="1839"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>).to(logits.device)</highlight></codeline>
<codeline lineno="1840"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1841"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>sequence_lengths<sp/>=<sp/>-1</highlight></codeline>
<codeline lineno="1842"><highlight class="normal"></highlight></codeline>
<codeline lineno="1843"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pooled_logits<sp/>=<sp/>logits[</highlight></codeline>
<codeline lineno="1844"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>torch.arange(batch_size,<sp/>device=logits.device),<sp/>sequence_lengths</highlight></codeline>
<codeline lineno="1845"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>]</highlight></codeline>
<codeline lineno="1846"><highlight class="normal"></highlight></codeline>
<codeline lineno="1847"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>None</highlight></codeline>
<codeline lineno="1848"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>labels<sp/>is<sp/>not<sp/>None:</highlight></codeline>
<codeline lineno="1849"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>labels<sp/>=<sp/>labels.to(logits.device)</highlight></codeline>
<codeline lineno="1850"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.config.problem_type<sp/>is<sp/>None:</highlight></codeline>
<codeline lineno="1851"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.num_labels<sp/>==<sp/>1:</highlight></codeline>
<codeline lineno="1852"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.config.problem_type<sp/>=<sp/>&quot;regression&quot;</highlight></codeline>
<codeline lineno="1853"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>self.num_labels<sp/>&gt;<sp/>1<sp/>and<sp/>(</highlight></codeline>
<codeline lineno="1854"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>labels.dtype<sp/>==<sp/>torch.long<sp/>or<sp/>labels.dtype<sp/>==<sp/>torch.int</highlight></codeline>
<codeline lineno="1855"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>):</highlight></codeline>
<codeline lineno="1856"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.config.problem_type<sp/>=<sp/>&quot;single_label_classification&quot;</highlight></codeline>
<codeline lineno="1857"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1858"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>self.config.problem_type<sp/>=<sp/>&quot;multi_label_classification&quot;</highlight></codeline>
<codeline lineno="1859"><highlight class="normal"></highlight></codeline>
<codeline lineno="1860"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.config.problem_type<sp/>==<sp/>&quot;regression&quot;:</highlight></codeline>
<codeline lineno="1861"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss_fct<sp/>=<sp/>MSELoss()</highlight></codeline>
<codeline lineno="1862"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>self.num_labels<sp/>==<sp/>1:</highlight></codeline>
<codeline lineno="1863"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>loss_fct(pooled_logits.squeeze(),<sp/>labels.squeeze())</highlight></codeline>
<codeline lineno="1864"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>else:</highlight></codeline>
<codeline lineno="1865"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>loss_fct(pooled_logits,<sp/>labels)</highlight></codeline>
<codeline lineno="1866"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>self.config.problem_type<sp/>==<sp/>&quot;single_label_classification&quot;:</highlight></codeline>
<codeline lineno="1867"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss_fct<sp/>=<sp/>CrossEntropyLoss()</highlight></codeline>
<codeline lineno="1868"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>loss_fct(</highlight></codeline>
<codeline lineno="1869"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pooled_logits.view(-1,<sp/>self.num_labels),<sp/>labels.view(-1)</highlight></codeline>
<codeline lineno="1870"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1871"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elif<sp/>self.config.problem_type<sp/>==<sp/>&quot;multi_label_classification&quot;:</highlight></codeline>
<codeline lineno="1872"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss_fct<sp/>=<sp/>BCEWithLogitsLoss()</highlight></codeline>
<codeline lineno="1873"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss<sp/>=<sp/>loss_fct(pooled_logits,<sp/>labels)</highlight></codeline>
<codeline lineno="1874"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>if<sp/>not<sp/>return_dict:</highlight></codeline>
<codeline lineno="1875"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>output<sp/>=<sp/>(pooled_logits,)<sp/>+<sp/>transformer_outputs[1:]</highlight></codeline>
<codeline lineno="1876"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>((loss,)<sp/>+<sp/>output)<sp/>if<sp/>loss<sp/>is<sp/>not<sp/>None<sp/>else<sp/>output</highlight></codeline>
<codeline lineno="1877"><highlight class="normal"></highlight></codeline>
<codeline lineno="1878"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>return<sp/>SequenceClassifierOutputWithPast(</highlight></codeline>
<codeline lineno="1879"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>loss=loss,</highlight></codeline>
<codeline lineno="1880"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logits=pooled_logits,</highlight></codeline>
<codeline lineno="1881"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>past_key_values=transformer_outputs.past_key_values,</highlight></codeline>
<codeline lineno="1882"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>hidden_states=transformer_outputs.hidden_states,</highlight></codeline>
<codeline lineno="1883"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>attentions=transformer_outputs.attentions,</highlight></codeline>
<codeline lineno="1884"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>)</highlight></codeline>
<codeline lineno="1885"><highlight class="normal"></highlight></codeline>
    </programlisting>
    <location file="/tmp/github_repos_arch_doc_gen/sumansaurabh/deeseek-model-visualizer/modeling_deepseek.py"/>
  </compounddef>
</doxygen>
